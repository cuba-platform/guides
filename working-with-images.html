<!doctype html>
<!--[if IE 9]>
<html class="lt-ie10" lang="en"> <![endif]-->
<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Working with Images in CUBA applications</title>
    <meta name="description" content="The CUBA Platform guides cover different aspects of the CUBA Platform and give you advice on how to work with CUBA Platform by giving you concrete examples.">
    <meta name="author" content="Haulmont">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@CubaPlatform">
    <meta name="twitter:creator" content="@CubaPlatform">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Working with Images in CUBA applications">
    <meta property="og:description" content="In this guide several ways will be explored on how to interact with images in a CUBA application">
    <meta property="og:url" content="https://www.cuba-platform.com/guides/working-with-images">
    <meta property="og:image" content="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-working-with-images/master/img/login-screen.png">

    <link rel="shortcut icon" href="/guides/images/favicon.png" type="image/png" />
    <link rel="stylesheet" href="/guides/css/foundation.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.css">
    <link rel="stylesheet" href="/guides/css/coderay.css">
    <link rel="stylesheet" href="/guides/css/bootstrap.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/reset.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/animate.css">
    <link rel="stylesheet" href="/guides/css/extra.css">
    <link rel="stylesheet" href="/guides/css/extra2.css">
    <link rel="stylesheet" href="/guides/css/cuba-new.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.min.css">
    <link rel="stylesheet" href="/guides/css/guides.css">
    <script src="/guides/js/jquery_v2.1.min.js"></script>
    <link rel="stylesheet" href="/guides/css/main.css" />
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-962 node-type-blog-post i18n-en">

<section id="wrapper">
    
<header role="banner" fragment="14269c1b298" class="header">
    <nav class="header_nav">
        <input id="mobile-menu-open" type="checkbox" class="header_checkbox">
        <div class="container header_container">
            <div class="header_toggle">
                <label for="mobile-menu-open"
                       class="header_toggle-label toggle-label">
                    <span>CUBA.platform</span>
                </label>
            </div>
            <a href="/" class="header_logo nuxt-link-active"></a>
            <ul class="header_menu">
                <li class="header_menu_item"><a href="/framework/" class="header_menu_link">Framework</a></li>
                <li class="header_menu_item"><a href="/learn/" class="header_menu_link nuxt-link-active">Learn</a></li>
                <li class="header_menu_item"><a href="/documentation/" class="header_menu_link">Documentation</a></li>
                <li class="header_menu_item"><a href="/discuss/" class="header_menu_link">Forum</a></li>
                <li class="header_menu_item"><a href="/blog/" class="header_menu_link">Blog</a></li>
            </ul>
            <div class="header-support">
                <button class="header-support_toggle">
                <img src="images/users.svg" class="header-support_toggle_icon">
                <span class="header-support_toggle_text">Services</span></button>
                <div class="header-support_popup">
                    <div class="support-popup">
                        <div class="support-popup_services">
                            <h3 class="support-popup_services_title">Commercial services for your project</h3>
                            <ul class="services-list">
                                <li class="services-list_item"><a href="/support-options/"><strong
                                        class="services-list_title">Consultancy &amp; Support</strong>
                                    <div class="services-list_text">
                                        <div><p>Commercial consulting requests have a guaranteed response
                                            time.</p>
                                        </div>
                                    </div>
                                </a></li>
                                <li class="services-list_item"><a href="/development/"><strong
                                        class="services-list_title">Custom Development</strong>
                                    <div class="services-list_text">
                                        <div><p>We can deliver a turn key solution or contribute to your
                                            project</p>
                                        </div>
                                    </div>
                                </a></li>
                                <li class="services-list_item"><a href="/training/"><strong
                                        class="services-list_title">Training</strong>
                                    <div class="services-list_text">
                                        <div><p>For fast and deep dive into framework features to shift your
                                            team productivity.</p>
                                        </div>
                                    </div>
                                </a></li>
                            </ul>
                        </div>
                        <div class="support-popup_haulmont">
                            <div class="support-popup_haulmont_header"><h3 class="support-popup_haulmont_title">
                                Haulmont</h3>
                                <div class="support-popup_haulmont_subtitle">we develop modern enterprise
                                    solutions
                                </div>
                            </div>
                            <ul class="haulmont-list">
                                <li class="haulmont-list_item">
                                    <div><p>Experts in Enterprise software</p>
                                    </div>
                                </li>
                                <li class="haulmont-list_item">
                                    <div><p>Creators of the CUBA Platform</p>
                                    </div>
                                </li>
                                <li class="haulmont-list_item">
                                    <div><p>Established in 2008</p>
                                    </div>
                                </li>
                            </ul>
                            <ul class="numbers-list">
                                <li class="numbers-list_item"><strong class="numbers-list_number">300+</strong>
                                    <div class="numbers-list_text">developers</div>
                                </li>
                                <li class="numbers-list_item"><strong class="numbers-list_number">400+</strong>
                                    <div class="numbers-list_text">projects</div>
                                </li>
                                <li class="numbers-list_item">
                                    <div class="numbers-list_text">Customers in</div>
                                    <strong class="numbers-list_number">60+</strong>
                                    <div class="numbers-list_text">countries</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <a href="/user/" class="header_profile">
                <svg xmlns="http://www.w3.org/2000/svg" id="i-profile" class="icon header_profile_src" viewBox="0 0 563.43 563.43" width="100%" height="100%">
                    <path d="M280.79 314.559c83.266 0 150.803-67.538 150.803-150.803S364.055 13.415 280.79 13.415 129.987 80.953 129.987 163.756s67.537 150.803 150.803 150.803zm0-261.824c61.061 0 111.021 49.959 111.021 111.021s-49.96 111.02-111.021 111.02-111.021-49.959-111.021-111.021 49.959-111.02 111.021-111.02zM19.891 550.015h523.648c11.102 0 19.891-8.789 19.891-19.891 0-104.082-84.653-189.198-189.198-189.198H189.198C85.116 340.926 0 425.579 0 530.124c0 11.102 8.789 19.891 19.891 19.891zm169.307-169.307h185.034c75.864 0 138.313 56.436 148.028 129.524H41.17c9.714-72.625 72.164-129.524 148.028-129.524z"></path>
                </svg>
            </a>
        </div>
    </nav>
    <nav class="header-submenu">
        <div class="container header-submenu_container">
            <a href="/learn/quickstart/" class="header-submenu_link">Quick Start</a>
            <a href="/learn/live-demo/" class="header-submenu_link">Live Demo</a>
            <a href="/guides/" class="header-submenu_link nuxt-link-exact-active nuxt-link-active">Guides</a>
        </div>
    </nav>
</header>

<style>
    .upper-header .header-options {
        display: none;
    }

    .upper-header .upper-header-wrapper .header-menu div .nav > li:last-child > a {
        padding-right: 0;
    }
</style>

    <!-- Main Page Content and Sidebar -->
    <div class="content-wrapper">
        <div class="cuba-container text-node blog">



            <!-- Main content (left column) -->
            <div class="region region-content">



                <section id="block-system-main" class="block block-system clearfix">
                    <div id="node-962" class="article node node-blog-post node-promoted clearfix">
                        <div class="content">
                            <div class="field field-name-body field-type-text-with-summary field-label-hidden">
                                <div class="field-items">
                                    <div class="field-item even" property="content: encoded">
                                        <h1>Working with Images in CUBA applications</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In a CUBA application it is possible to interact with images in various ways. In this guide, it will be demonstrated how to upload and display images in the application on live examples. It will be also shown how to attach those images to entities and how to enable users to download the image files from the application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what_will_be_built"><a class="anchor" href="#what_will_be_built"></a><a class="link" href="#what_will_be_built">What Will be Built</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide enhances the <a href="https://github.com/cuba-platform/cuba-petclinic">CUBA Petclinic</a> example to allow users to attach images to entities and interact with them. In particular, the following changes will be made:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ability to upload an avatar image for a Veterinarian</p>
</li>
<li>
<p>render the Veterinarian&#8217;s avatar in the Veterinarian&#8217;s browse table</p>
</li>
<li>
<p>create custom lookup-like component that shows the Veterinarian&#8217;s avatar next to the name</p>
</li>
<li>
<p>ability to attach X-Ray images to a visit and preview the images</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="final_application"><a class="anchor" href="#final_application"></a><a class="link" href="#final_application">Final Application</a></h3>
<a href="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-working-with-images/master/img/adjustments-cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-working-with-images/master/img/login-screen.png"/></a>
</div>
<div class="sect2">
<h3 id="requirements"><a class="anchor" href="#requirements"></a><a class="link" href="#requirements">Requirements</a></h3>
<div class="paragraph">
<p>Your development environment requires to contain the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 1.8</a></p>
</li>
<li>
<p>a text editor or IDE (<a href="https://www.jetbrains.com/idea/download/">IntelliJ IDEA</a> preferred)</p>
</li>
<li>
<p><a href="https://www.cuba-platform.com/download">CUBA Studio</a> as standalone IDE or as an IDEA plugin (optional)</p>
</li>
<li>
<p><a href="https://github.com/cuba-platform/cuba-cli/wiki/Installation">CUBA CLI</a> (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://github.com/cuba-guides/cuba-petclinic-working-with-images/archive/master.zip">Download</a> and unzip the source repository for this guide, or clone it using git:</p>
</div>
<div class="paragraph">
<p><code>git clone <a href="https://github.com/cuba-guides/cuba-petclinic-working-with-images.git" class="bare">https://github.com/cuba-guides/cuba-petclinic-working-with-images.git</a></code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example_cuba_petclinic"><a class="anchor" href="#example_cuba_petclinic"></a><a class="link" href="#example_cuba_petclinic">Example: CUBA petclinic</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The project that is the basis for this example is <a href="https://github.com/cuba-platform/cuba-petclinic">CUBA Petclinic</a>. It is based on the commonly known <a href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a>. The CUBA Petclinic application deals with the domain of a Pet clinic and the associated business workflows to manage a pet clinic.</p>
</div>
<div class="paragraph">
<p>The underlying domain model for the application looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/domain-model.png" alt="Domain model">
</div>
</div>
<div class="paragraph">
<p>The main entities are <strong>Pet</strong> and <strong>Visit</strong>. A Pet is visiting the petclinic and during this Visit a Vet is taking care of it. A Pet belongs to an Owner, which can hold multiple pets. The visit describes the act of a pet visiting the clinic with the help of its owner.</p>
</div>
<a href="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/login-screen.png"/></a>
</div>
</div>
<div class="sect1">
<h2 id="cubas_file_storage_subsystem"><a class="anchor" href="#cubas_file_storage_subsystem"></a><a class="link" href="#cubas_file_storage_subsystem">CUBA&#8217;s File Storage Subsystem</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>CUBA has a comprehensive set of features that deal with the task of interacting with files within an application. The underlying subsystem is called <code>File Storage</code>.</p>
</div>
<div class="paragraph">
<p>This set of APIs allow the developer to fulfill the end-to-end process of working with files. This mainly contains:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ability for users to upload files</p>
</li>
<li>
<p>store references from business entities in files</p>
</li>
<li>
<p>read &amp; write files in the application</p>
</li>
<li>
<p>ability for users to download files</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The File Storage subsystem separates the storage of the file metadata from the file binary. It stores metadata about the file in the relational database and the raw file binary in the filesystem.</p>
</div>
<div class="paragraph">
<p>More information about this topic can be found in the reference documentation on <a href="https://doc.cuba-platform.com/manual-7.0/file_storage.html">File Storage</a>.</p>
</div>
<div class="paragraph">
<p>As an Image is just a particular type of file, it is possible to treat the image handling just like any other kind of file handling with some specific additional behavior like preview in the browser.</p>
</div>
<div class="imageblock right">
<div class="content">
<img src="/guides/images/working-with-images/vet-avatar-example.png" alt="vet avatar example" width="200">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="veterinarians_avatar_image"><a class="anchor" href="#veterinarians_avatar_image"></a><a class="link" href="#veterinarians_avatar_image">Veterinarian&#8217;s Avatar Image</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The first example of this Images guide allows users to upload &amp; display an avatar image for a particular veterinarian.</p>
</div>
<div class="paragraph">
<p>In order to achieve this behavior, the data model of the Petclinic example needs to be enhanced, to store a reference to a file for the <code>Vet</code> entity. The corresponding JPA entity that is bundled in CUBA itself is called <code>FileDescriptor</code>. It represents the metadata part of a file and acts as a pointer to this file.</p>
</div>
<div class="paragraph">
<p>The association type is <code>MANY-TO-ONE</code>. In the Studio entity designer, the result looks like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<a class="image" href="/guides/images/working-with-images/vet-entity-file-descriptor-reference.png"><img src="/guides/images/working-with-images/vet-entity-file-descriptor-reference.png" alt="vet entity file descriptor reference"></a>
</div>
</div>
<div class="paragraph">
<p>Since the entity model contains the reference to the <code>FileDescriptor</code> entity, the attribute <code>image</code> must be added to the view, in order to interact with this attribute in the UI.</p>
</div>
<div class="paragraph">
<p>The view <code>vet-with-specialties</code> for the <code>Vet</code> entity, that is used within the Vet editor, has to be changed to contain the <code>image</code> attribute like this:</p>
</div>
<div class="listingblock">
<div class="title">views.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;view</span> <span class="attribute-name">class</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.haulmont.sample.petclinic.entity.vet.Vet</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">extends</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_local</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vet-with-specialties-and-image</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">specialties</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">view</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_minimal</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">image</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">view</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">_base</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/view&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>With this adjustment it makes sense to rename the view name to <code>vet-with-specialties-and-image</code> as well, to reflect the content of the view.</p>
</div>
<div class="sect2">
<h3 id="upload_vets_avatar_image"><a class="anchor" href="#upload_vets_avatar_image"></a><a class="link" href="#upload_vets_avatar_image">Upload Vet&#8217;s Avatar Image</a></h3>
<div class="paragraph">
<p>With those preconditions in place, the next step is to adjust the Vet editor, so that it is also able to upload an image during the process of creating / editing a Vet record.</p>
</div>
<div class="paragraph">
<p>CUBA has a built-in UI component for dealing with <code>FileDescriptor</code> instances - the FileUploadField component. This component can be added to the already existing <code>&lt;form /&gt;</code> component form in the <code>vet-edit.xml</code> screen descriptor:</p>
</div>
<div class="listingblock">
<div class="title">vet-edit.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;form</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fieldGroup</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">dataContainer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">vetDc</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;column</span> <span class="attribute-name">width</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">250px</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

        <span class="tag">&lt;textField</span> <span class="attribute-name">property</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;textField</span> <span class="attribute-name">property</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

        <span class="tag">&lt;upload</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">imageField</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">property</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">image</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="attribute-name">fileStoragePutMode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">IMMEDIATE</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">showFileName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
        <span class="tag">/&gt;</span>

    <span class="tag">&lt;/column&gt;</span>
<span class="tag">&lt;/form&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the FileUploadField component binds the uploaded file to the <code>image</code> attribute of the <code>vetDc</code> data container</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are a couple of options for the upload component to control its behavior, that can be looked up in the <a href="https://doc.cuba-platform.com/manual-7.0/gui_FileUploadField.html">reference documentation</a>. For this use case, the default behavior is sufficient. It will allow users to upload, download, remove and re-upload a file and directly attach it to the vet instance of the editor.</p>
</div>
<div class="paragraph">
<p>The resulting user interface looks like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/working-with-images/vet-entity-file-descriptor-reference-ui.png" alt="vet entity file descriptor reference ui">
</div>
</div>
<div class="paragraph">
<p>The attribute <code>fileStoragePutMode</code> set to <code>IMMEDIATE</code> leads to the behavior that the file is persisted and a corresponding persisted <code>FileDescriptor</code> instance is created directly after the file uploading is completed. The benefit of such approach is that this behavior allows to link the Vet instance to the image without further programmatic interaction.</p>
</div>
<div class="paragraph">
<p>However, it has the side effect that even if the vet instance is not saved, the file will still be kept in the system. It can still be found via <code>Administration &gt; External Files</code>. If this behavior is not desired, the <code>fileStoragePutMode</code> can be set to <code>MANUAL</code>, which requires manual management of the file persistence. The next use case will describe this behavior in further detail.</p>
</div>
</div>
<div class="sect2">
<h3 id="display_vets_avatar_image_in_the_browse_table"><a class="anchor" href="#display_vets_avatar_image_in_the_browse_table"></a><a class="link" href="#display_vets_avatar_image_in_the_browse_table">Display Vet&#8217;s Avatar Image in the Browse Table</a></h3>
<div class="paragraph">
<p>The next example that deals with the Vet&#8217;s avatar image is that the uploaded file should be displayed in the Vet browse screen. In order to do that, the <code>image</code> attribute has to be a part of the corresponding view (which it is from the change above).</p>
</div>
<div class="paragraph">
<p>In order to display an image in a screen the second UI component in this space is the <code>&lt;image /&gt;</code> component. It allows to render an image based on various sources including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Image from the filesystem / classpath</p>
</li>
<li>
<p>Image from an arbitrary URL</p>
</li>
<li>
<p>Image from a <code>FileDescriptor</code> instance</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See <a href="https://doc.cuba-platform.com/manual-7.0/gui_Image.html">CUBA docs: Image UI component</a> for more information on the possible options.</p>
</div>
<div class="paragraph">
<p>In this use case, since the <code>Vet</code> instance holds the reference to a <code>FileDescriptor</code> instance via the <code>image</code> attribute, it is possible to directly render the image out of the file reference.</p>
</div>
<div class="paragraph">
<p>The target UI should look like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<a class="image" href="/guides/images/working-with-images/vet-avatar-browse-screen.png"><img src="/guides/images/working-with-images/vet-avatar-browse-screen.png" alt="vet avatar browse screen"></a>
</div>
</div>
<div class="paragraph">
<p>The <code>image</code> attribute should be one of the columns in the vets table. Furthermore, it should render a particular representation of the image: not the instance name of the <code>FileDescriptor</code>, but rather the image itself.</p>
</div>
<div class="paragraph">
<p>To achieve this behavior some programmatic definition in the controller is needed.</p>
</div>
<div class="paragraph">
<p>The <code>Table</code> component has a particular API method: <code>addGeneratedColumn</code>, which allows to define a <code>Component</code> as a representation for a particular column in the table. This method is called for every entity that should be displayed in the table and it receives the corresponding entity instance as a parameter.</p>
</div>
<div class="listingblock">
<div class="title">VetBrowse.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VetBrowse</span> <span class="directive">extends</span> StandardLookup&lt;Vet&gt; {

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> GroupTable&lt;Vet&gt; vetsTable;

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> UiComponents uiComponents;

    <span class="annotation">@Subscribe</span>
    <span class="directive">protected</span> <span class="type">void</span> onInit(InitEvent event) {
        vetsTable.addGeneratedColumn( <i class="conum" data-value="1"></i><b>(1)</b>
                <span class="string"><span class="delimiter">&quot;</span><span class="content">image</span><span class="delimiter">&quot;</span></span>,
                <span class="local-variable">this</span>::renderAvatarImageComponent
        );
    }

    <span class="directive">private</span> <span class="predefined-type">Component</span> renderAvatarImageComponent(Vet vet) {
        <span class="predefined-type">FileDescriptor</span> imageFile = vet.getImage(); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">if</span> (imageFile == <span class="predefined-constant">null</span>) {
            <span class="keyword">return</span> <span class="predefined-constant">null</span>;
        }
        <span class="predefined-type">Image</span> image = smallAvatarImage();
        image.setSource(FileDescriptorResource.class)
                .setFileDescriptor(imageFile); <i class="conum" data-value="4"></i><b>(4)</b>

        <span class="keyword">return</span> image;
    }

    <span class="directive">private</span> <span class="predefined-type">Image</span> smallAvatarImage() {
        <span class="predefined-type">Image</span> image = uiComponents.create(<span class="predefined-type">Image</span>.class);  <i class="conum" data-value="3"></i><b>(3)</b>
        image.setScaleMode(<span class="predefined-type">Image</span>.ScaleMode.CONTAIN);
        image.setHeight(<span class="string"><span class="delimiter">&quot;</span><span class="content">40</span><span class="delimiter">&quot;</span></span>);
        image.setWidth(<span class="string"><span class="delimiter">&quot;</span><span class="content">40</span><span class="delimiter">&quot;</span></span>);
        image.setStyleName(<span class="string"><span class="delimiter">&quot;</span><span class="content">avatar-icon-small</span><span class="delimiter">&quot;</span></span>);
        <span class="keyword">return</span> image;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>a new column <code>image</code> is registered in the <code>vetsTable</code> through the <code>renderAvatarImageComponent</code> method</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the <code>FileDescriptor</code> reference is retrieved from the <code>Vet</code> instance through the <code>image</code> association</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the UI infrastructure bean <code>uiComponents</code> is the entry point for creating UI components programmatically</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>the Image component is bound to the <code>FileDescriptor</code> through the <code>FileDescriptorResource</code> variant</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With this code in place, an image component is created, configured and bound to the <code>FileDescriptor</code> instance. With the corresponding style name <code>avatar-icon-small</code>, the image is rendered as shown above.</p>
</div>
</div>
<div class="sect2">
<h3 id="create_vets_lookup_component_containing_the_avatar_image"><a class="anchor" href="#create_vets_lookup_component_containing_the_avatar_image"></a><a class="link" href="#create_vets_lookup_component_containing_the_avatar_image">Create Vets Lookup Component containing the Avatar Image</a></h3>
<div class="paragraph">
<p>The last part of this Vet avatar functionality is that in the Visit detail screen, the representation of the Vet should include the image and the name like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/working-with-images/vet-avatar-example.png" alt="vet avatar example" width="300">
</div>
</div>
<div class="paragraph">
<p>This requires to apply the image component in a different way as this component is now a part of the Visit editor inside the <code>&lt;form /&gt;</code> component.</p>
</div>
<div class="paragraph">
<p>The source code for providing this functionality consists of two parts.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>VetEdit</code> controller which orchestrates the creation and binding of the custom component</p>
</li>
<li>
<p>the <code>VetPreviewComponentFactory</code> which is responsible for creating the component shown above with the correct layout and binding to the correct fields of the <code>InstanceContainer</code></p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
A dedicated factory class that defines how the component is created is just one possible option to structure the implementation. It has certain advantages to extract the creating of the component into a dedicated class like encapsulation, separation of concerns and the ability to re-use in other screens.<br>
<br>
However, it is also possible to include the component creation logic directly into the controller. This variant can be seen as an example on how to structure business logic in the UI layer. More information about this topic can be found in <a href="https://www.cuba-platform.com/guides/create-business-logic-in-cuba">Create business logic in CUBA</a> guide.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The orchestration within the <code>VetEdit</code> controller looks like this:</p>
</div>
<div class="listingblock">
<div class="title">VisitEdit.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VisitEdit</span> <span class="directive">extends</span> StandardEditor&lt;Visit&gt; {

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> Form treatingVetForm;

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> InstanceContainer&lt;Visit&gt; visitDc;

    <span class="comment">// ...</span>

    <span class="annotation">@Subscribe</span>
    <span class="directive">protected</span> <span class="type">void</span> renderTreatingVetLayout(AfterShowEvent event) {

        VetPreviewComponentFactory vetPreviewComponentFactory =
            <span class="keyword">new</span> VetPreviewComponentFactory( <i class="conum" data-value="1"></i><b>(1)</b>
                uiComponents,
                screenBuilders,
                messageBundle,
                <span class="local-variable">this</span>
            );

        <span class="predefined-type">Component</span> vetPreview = vetPreviewComponentFactory.create(  <i class="conum" data-value="2"></i><b>(2)</b>
                visitDc,
                vet -&gt; getEditedEntity().setTreatingVet(vet)
        );

        treatingVetForm.add(vetPreview); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>a new <code>VetPreviewComponentFactory</code> instance is created with all the required dependencies passed to it</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>create</code> creates an instance of the desired Vet avatar image component</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the created component is attached to the <code>treatingVetForm</code> to render the vet avatar image</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>VetPreviewComponentFactory</code> code contains a little bit more code for correct positioning of the elements within the layout. The key points are listed below (the complete class can be found in the example project: <a href="https://github.com/cuba-guides/cuba-petclinic-working-with-images/blob/master/modules/web/src/com/haulmont/sample/petclinic/web/visit/visit/VetPreviewComponentFactory.java">VetPreviewComponentFactory.java</a>).</p>
</div>
<div class="listingblock">
<div class="title">VetPreviewComponentFactory.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VetPreviewComponentFactory</span> {

    <span class="directive">private</span> <span class="directive">final</span> UiComponents uiComponents;
    <span class="directive">private</span> <span class="directive">final</span> ScreenBuilders screenBuilders;
    <span class="directive">private</span> <span class="directive">final</span> FrameOwner frameOwner;

    <span class="directive">public</span> <span class="predefined-type">Component</span> create( <i class="conum" data-value="1"></i><b>(1)</b>
            InstanceContainer&lt;Visit&gt; visitDc,
            Consumer&lt;Vet&gt; vetSelectionHandler
    ){
        <span class="keyword">return</span> verticalLayout(
                vetImage(visitDc),
                horizontalLayout(
                        treatingVetName(visitDc),
                        editVetButton(vetSelectionHandler)
                )
        );
    }

    <span class="comment">// ...</span>

    <span class="directive">private</span> <span class="predefined-type">Image</span> vetImage(InstanceContainer&lt;Visit&gt; visitDc) {

        <span class="predefined-type">Image</span> image = uiComponents.create(<span class="predefined-type">Image</span>.class);
        <span class="comment">// ...</span>
        image.setValueSource(
                <span class="keyword">new</span> ContainerValueSource&lt;&gt;(visitDc, <span class="string"><span class="delimiter">&quot;</span><span class="content">treatingVet.image</span><span class="delimiter">&quot;</span></span>) <i class="conum" data-value="2"></i><b>(2)</b>
        );
        <span class="keyword">return</span> image;
    }

    <span class="directive">private</span> <span class="predefined-type">Button</span> editVetButton(Consumer&lt;Vet&gt; vetSelectionHandler) {

        LinkButton button = uiComponents.create(LinkButton.class);
        <span class="comment">// ...</span>
        button.setAction(
                <span class="keyword">new</span> BaseAction(<span class="string"><span class="delimiter">&quot;</span><span class="content">changeVet</span><span class="delimiter">&quot;</span></span>)
                .withHandler(event -&gt; openVetLookup(event, vetSelectionHandler)) <i class="conum" data-value="3"></i><b>(3)</b>
        );
        <span class="keyword">return</span> button;
    }

    <span class="directive">private</span> <span class="type">void</span> openVetLookup(
            <span class="predefined-type">Action</span>.ActionPerformedEvent event,
            Consumer&lt;Vet&gt; vetSelectionHandler
    ) {
        screenBuilders.lookup(Vet.class, frameOwner)
                .withOpenMode(OpenMode.DIALOG)
                .withSelectHandler(
                        vets -&gt; vetSelectionHandler.accept(vets.iterator().next())
                )
                .show();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>a vertical layout containing the image, a horizontal layout containing the name and an "Edit" button is created</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the <code>ValueSource</code> references the <code>image</code> attribute of the associated <code>treatingVet</code> for the data container</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the handler for the "Edit" button triggers the provided <code>vetSelectionHandler</code>, so the associated actions can be controlled from the outside of this factory method</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With this, the final usage of the custom Vet display &amp; selection for the Vet looks like this:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<a class="image" href="/guides/images/working-with-images/vet-selection-in-visit-edit.png"><img src="/guides/images/working-with-images/vet-selection-in-visit-edit.png" alt="vet selection in visit edit"></a>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="x_ray_images_for_visits"><a class="anchor" href="#x_ray_images_for_visits"></a><a class="link" href="#x_ray_images_for_visits">X-Ray Images for Visits</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The second use case covered in this guide is the ability to attach X-Ray images to a particular visit. Those X-Ray images should be displayed when selected on the Table. Further it should be possible to upload and download those images.</p>
</div>
<div class="paragraph">
<p>The precondition is another change in the data model. As before, for the <code>Vet</code> entity the <code>Visit</code> also needs a reference to the <code>FileDescriptor</code>, but this time it is a <code>MANY-TO-MANY</code> association. With this domain model change as well as the corresponding view adjustment in place, the three parts of uploading, previewing and downloading the X-Ray images can be tackled.</p>
</div>
<div class="sect2">
<h3 id="upload_x_ray_images"><a class="anchor" href="#upload_x_ray_images"></a><a class="link" href="#upload_x_ray_images">Upload X-Ray Images</a></h3>
<div class="paragraph">
<p>The first step is to upload the X-Ray image to a particular <code>Visit</code> instance. For this the following <code>&lt;upload /&gt;</code> component will be placed in the <code>&lt;buttonsPanel /&gt;</code> component of the <code>xRayImagesTable</code>. Compared to the first use case, this time the <code>fileStoragePutMode</code> will be set to <code>MANUAL</code>. This gives more freedom in defining the persistence behavior which is required in this scenario.</p>
</div>
<div class="listingblock">
<div class="title">visit-edit.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;upload</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">upload</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">showClearButton</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">uploadButtonIcon</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UPLOAD</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">uploadButtonCaption</span>=<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">fileStoragePutMode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MANUAL</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="attribute-name">permittedExtensions</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">.png,.jpg,.pdf</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="attribute-name">dropZone</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">contentHBox</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="attribute-name">showFileName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the persistence operation will be handled manually by the controller in order to correctly display the image preview</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>either images or PDF files are allowed to be uploaded</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the additional drop zone allows users to drag &amp; drop files onto the table / preview component</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The corresponding <code>VisitEdit</code> controller subscribes to the <code>FileUploadSucceedEvent</code> of the <code>upload</code> component, persists the file and adds the <code>FileDescriptor</code> to the <code>M:N</code> association of the visit instance.</p>
</div>
<div class="listingblock">
<div class="title">VisitEdit.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VisitEdit</span> <span class="directive">extends</span> StandardEditor&lt;Visit&gt; {

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> CollectionPropertyContainer&lt;<span class="predefined-type">FileDescriptor</span>&gt; xRayImagesDc;

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> FileUploadField upload;

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> DataContext dataContext;

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> FileUploadingAPI fileUploadingAPI;

    <span class="annotation">@Subscribe</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">upload</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="type">void</span> onUploadFileUploadSucceed(
            FileUploadField.FileUploadSucceedEvent event
    ) {
        <span class="predefined-type">FileDescriptor</span> imageDescriptor = upload.getFileDescriptor(); <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="keyword">try</span> {
            fileUploadingAPI.putFileIntoStorage(upload.getFileId(), imageDescriptor); <i class="conum" data-value="2"></i><b>(2)</b>

            <span class="predefined-type">FileDescriptor</span> savedImageDescriptor = dataManager.commit(imageDescriptor);
            newImageDescriptors.add(savedImageDescriptor);

            xRayImagesDc.getMutableItems().add(savedImageDescriptor); <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="comment">/* ... */</span>
        } <span class="keyword">catch</span> (FileStorageException e) {
            <span class="comment">/* ... */</span>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the newly created <code>FileDescriptor</code> instance of the uploaded file is needed to persist the instance</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the uploaded file is transferred to the backend and persisted in the FileStorage</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the <code>FileDescriptor</code> instance for the already persisted file is assigned to the X-Ray images <code>M:N</code> association to display it in the table</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Besides the code in the listing, there is a little bit more relevant code in the example. It handles the case when the edit operation of the visit is cancelled by the user after uploading an image. In this case the images have to be removed again. For more information see the example: <a href="https://github.com/cuba-guides/cuba-petclinic-working-with-images/blob/master/modules/web/src/com/haulmont/sample/petclinic/web/visit/visit/VisitEdit.java">VisitEdit.java</a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With that subscription code in place, the X-Ray image upload is implemented and can be used to fulfil the next step: preview of the uploaded images.</p>
</div>
</div>
<div class="sect2">
<h3 id="x_ray_image_preview"><a class="anchor" href="#x_ray_image_preview"></a><a class="link" href="#x_ray_image_preview">X-Ray Image Preview</a></h3>
<div class="paragraph">
<p>In order to render an image preview of the uploaded X-Ray image, the <code>visit-edit.xml</code> needs to be adjusted so that it can display information next to the X-Ray images M:N table.</p>
</div>
<div class="listingblock">
<div class="title">visit-edit.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;hbox</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">contentHBox</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">spacing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">width</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100%</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;table</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xRayImagesTable</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">dataContainer</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xRayImagesDc</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">width</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100%</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">height</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100%</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">columnControlVisible</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;actions&gt;</span>
            <span class="tag">&lt;action</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">download</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">trackSelection</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">icon</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DOWNLOAD</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;action</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">edit</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">edit</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;action</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remove</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remove</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/actions&gt;</span>
        <span class="tag">&lt;columns&gt;</span>
            <span class="tag">&lt;column</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/columns&gt;</span>
    <span class="tag">&lt;/table&gt;</span>
    <span class="tag">&lt;hbox</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xrayImageWrapperLayout</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">height</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100%</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">width</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100%</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">spacing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;/hbox&gt;</span>
<span class="tag">&lt;/hbox&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The most relevant part for this case is the <code>xrayImageWrapperLayout</code> component, which acts as a placeholder that will contain the image later. Currently it contains no child components, instead it will be dynamically filled at the time a selection is made for the <code>xRayImagesTable</code>.</p>
</div>
<div class="listingblock">
<div class="title">VisitEdit.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VisitEdit</span> <span class="directive">extends</span> StandardEditor&lt;Visit&gt; {

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> Table&lt;<span class="predefined-type">FileDescriptor</span>&gt; xRayImagesTable;

    <span class="annotation">@Subscribe</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">xRayImagesTable</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="type">void</span> onXRayImagesTableSelection(
            Table.SelectionEvent&lt;<span class="predefined-type">FileDescriptor</span>&gt; event
    ) {
        xrayImageWrapperLayout.removeAll();
        <span class="predefined-type">Set</span>&lt;<span class="predefined-type">FileDescriptor</span>&gt; selectedXrayImages = event.getSelected(); <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="keyword">if</span> (!selectedXrayImages.isEmpty()) {
            xrayImageWrapperLayout.add( <i class="conum" data-value="2"></i><b>(2)</b>
                    xrayImage(
                            selectedXrayImages.iterator().next()
                    )
            );
        }
    }

    <span class="directive">private</span> <span class="predefined-type">Component</span> xrayImage(<span class="predefined-type">FileDescriptor</span> file) {
        XrayPreviewComponentFactory factory = <span class="keyword">new</span> XrayPreviewComponentFactory(
                uiComponents,
                messageBundle
        );

        <span class="keyword">return</span> factory.create(file); <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the table selection event is used to fetch the selected <code>FileDescriptor</code> instance (X-Ray image)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>an X-Ray component is placed within the <code>xrayImageWrapperLayout</code> as a child component for the selected X-Ray image</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the logic to create the X-Ray image preview component is delegated to the <code>XrayPreviewComponentFactory</code> class</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Since the X-Ray image preview is also a composition of multiple elements, this logic was once again extracted into a dedicated <code>Factory</code> class. The resulting UI layout consists of a <code>GroupBox</code> which has the filename as the caption and the image preview as the content:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/working-with-images/x-ray-image-component.png" alt="x ray image component" width="600">
</div>
</div>
<div class="paragraph">
<p>The listing for the <code>XrayPreviewComponentFactory</code> contains only the most relevant parts. One important part of the functionality is that it should be able to render either Images or PDF files directly in the browser. This requires a branching logic within the implementation to use the correct UI component based on the file type.</p>
</div>
<div class="listingblock">
<div class="title">XrayPreviewComponentFactory.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">XrayPreviewComponentFactory</span> {

    <span class="directive">public</span> <span class="predefined-type">Component</span> create(<span class="predefined-type">FileDescriptor</span> file) {
        GroupBoxLayout groupBoxLayout = uiComponents.create(GroupBoxLayout.class);
        groupBoxLayout.setShowAsPanel(<span class="predefined-constant">true</span>); <i class="conum" data-value="1"></i><b>(1)</b>
        groupBoxLayout.setStyleName(<span class="string"><span class="delimiter">&quot;</span><span class="content">well</span><span class="delimiter">&quot;</span></span>);
        groupBoxLayout.setCaption(
                messageBundle.formatMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">previewFile</span><span class="delimiter">&quot;</span></span>, file.getName())
        );
        <span class="keyword">if</span> (isPdf(file)) {
            groupBoxLayout.add(xrayPdfComponent(file));
        }
        <span class="keyword">else</span> <span class="keyword">if</span> (isImage(file)){
            groupBoxLayout.add(xrayImageComponent(file));
        }
        <span class="keyword">return</span> groupBoxLayout;
    }

    <span class="directive">private</span> <span class="type">boolean</span> isPdf(<span class="predefined-type">FileDescriptor</span> file) {
        <span class="keyword">return</span> file.getExtension().contains(<span class="string"><span class="delimiter">&quot;</span><span class="content">pdf</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="comment">// ...</span>

    <span class="directive">private</span> <span class="predefined-type">Component</span> xrayImageComponent(<span class="predefined-type">FileDescriptor</span> imageFile) {
        <span class="predefined-type">Image</span> image = uiComponents.create(<span class="predefined-type">Image</span>.class);
        image.setScaleMode(<span class="predefined-type">Image</span>.ScaleMode.SCALE_DOWN);
        image.setSource(FileDescriptorResource.class)
                .setFileDescriptor(imageFile); <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="keyword">return</span> image;
    }

    <span class="directive">private</span> <span class="predefined-type">Component</span> xrayPdfComponent(<span class="predefined-type">FileDescriptor</span> imageFile) {
        BrowserFrame browserFrame = uiComponents.create(BrowserFrame.class);
        browserFrame.setSource(FileDescriptorResource.class)
                .setFileDescriptor(imageFile)
                .setMimeType(MediaType.APPLICATION_PDF_VALUE); <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="keyword">return</span> browserFrame;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>GroupBox specific styles will be applied to the wrapper component</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>in case of an image, the <code>Image</code> component will be used and the <code>FileDescriptor</code> will be assigned as a source</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>in case of a PDF file, the correct mime type has to be set in order to render the file in the browser inline</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With those two parts in place, the preview functionality of the X-Ray Images is complete:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<a class="image" href="/guides/images/working-with-images/x-ray-image-preview.png"><img src="/guides/images/working-with-images/x-ray-image-preview.png" alt="x ray image preview"></a>
</div>
</div>
</div>
<div class="sect2">
<h3 id="download_x_ray_images"><a class="anchor" href="#download_x_ray_images"></a><a class="link" href="#download_x_ray_images">Download X-Ray Images</a></h3>
<div class="paragraph">
<p>The last part of the X-Ray Image preview functionality use case is that it should be possible to download the image files.</p>
</div>
<div class="paragraph">
<p>To achieve this an additional <code>download</code> button and action are placed on top of the <code>xRayImagesTable</code>. The controller code uses the <code>ExportDisplay</code> bean from CUBA to trigger the download of a FileDescriptor in the browser.</p>
</div>
<div class="listingblock">
<div class="title">VisitEdit.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VisitEdit</span> <span class="directive">extends</span> StandardEditor&lt;Visit&gt; {

    <span class="annotation">@Inject</span>
    <span class="directive">protected</span> ExportDisplay exportDisplay;

    <span class="annotation">@Subscribe</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">xRayImagesTable.download</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="type">void</span> onXRayImagesTableDownload(<span class="predefined-type">Action</span>.ActionPerformedEvent event) {
        downloadFile(xRayImagesTable.getSingleSelected());
    }

    <span class="directive">private</span> <span class="type">void</span> downloadFile(<span class="predefined-type">FileDescriptor</span> file) {
        exportDisplay.show(file, ExportFormat.OCTET_STREAM);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>exportDisplay</code> bean has multiple options to download a file. The one that is used here takes a <code>FileDescriptor</code> instance. <code>ExportFormat.OCTET_STREAM</code> indicates that the browser should force the file to be downloaded and not to try to render it within the browser.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a><a class="link" href="#summary">Summary</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Image rendering within CUBA applications as well as custom composition of components will enrich the CRUD experience for users immediately. The main building block is the <code>FileDescriptor</code> abstraction that all UI components seamlessly integrate with.</p>
</div>
<div class="paragraph">
<p>In this guide two use cases were shown. The first one with the Vet avatar image used the standard upload functionality within a <code>&lt;form /&gt;</code> component and rendered the result as a generated column within a table. Additionally a custom image-aware "PickerField" was created. The second use case used the APIs more directly to upload, preview and download X-Ray images for visits.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further_information"><a class="anchor" href="#further_information"></a><a class="link" href="#further_information">Further Information</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://doc.cuba-platform.com/manual-7.0/gui_FileUploadField.html">CUBA docs: File Upload UI component</a></p>
</li>
<li>
<p><a href="https://doc.cuba-platform.com/manual-7.0/gui_Image.html">CUBA docs: Image UI component</a></p>
</li>
<li>
<p><a href="https://www.cuba-platform.com/guides/create-business-logic-in-cuba">CUBA guide: Create business logic in CUBA</a></p>
</li>
</ul>
</div>
</div>
</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <!-- Sidebar (right column) -->
            <div id="blog-sidebar">
                <div class="region region-sidebar ">
                    <section id="block-block-29" class="block block-block clearfix">

                        <div class="guide-panel">
                            <h3 class="header-table-content">Table of contents</h3>
                            <ul class="sectlevel1">
<li><a href="#what_will_be_built">What Will be Built</a>
<ul class="sectlevel2">
<li><a href="#final_application">Final Application</a></li>
<li><a href="#requirements">Requirements</a></li>
</ul>
</li>
<li><a href="#example_cuba_petclinic">Example: CUBA petclinic</a></li>
<li><a href="#cubas_file_storage_subsystem">CUBA&#8217;s File Storage Subsystem</a></li>
<li><a href="#veterinarians_avatar_image">Veterinarian&#8217;s Avatar Image</a>
<ul class="sectlevel2">
<li><a href="#upload_vets_avatar_image">Upload Vet&#8217;s Avatar Image</a></li>
<li><a href="#display_vets_avatar_image_in_the_browse_table">Display Vet&#8217;s Avatar Image in the Browse Table</a></li>
<li><a href="#create_vets_lookup_component_containing_the_avatar_image">Create Vets Lookup Component containing the Avatar Image</a></li>
</ul>
</li>
<li><a href="#x_ray_images_for_visits">X-Ray Images for Visits</a>
<ul class="sectlevel2">
<li><a href="#upload_x_ray_images">Upload X-Ray Images</a></li>
<li><a href="#x_ray_image_preview">X-Ray Image Preview</a></li>
<li><a href="#download_x_ray_images">Download X-Ray Images</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#further_information">Further Information</a></li>
</ul>
                        </div>

                        <div class="sidebar-razd"></div>
                        <div class="guide-panel download">
                            <a href="https://github.com/cuba-guides/cuba-petclinic-working-with-images" class="github-link" target="_blank">Example code on Github</a>
                        </div>
                        <div class="guide-panel cuba-version">Supported versions: CUBA 7.0+; Java 8+</div>

                    </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer fragment="14269c1b298" class="footer">
    <div class="container footer_container">
        <div class="footer_columns">
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Framework</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/framework/">Framework</a></li>
                        <li><a href="/tools/">Tools</a></li>
                        <li><a href="/marketplace/">Addons</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Learn</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/learn/quickstart/">Quick Start</a></li>
                        <li><a href="/learn/live-demo/">Live Demo</a></li>
                        <li><a href="/guides/">Guides</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Documentation</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/documentation/">Documentation</a></li>
                        <li><a href="/api-reference/">API References</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Community</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/discuss/">Forum</a></li>
                        <li><a href="/blog/">Blog</a></li>
                        <li><a href="/contacts/">Contacts</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer_bottom">
            <div class="footer_copyright">
                Developed and sponsored by Haulmont
                <a href="https://www.cuba-platform.com/terms-of-use/" class="footer_terms">Terms of Use</a></div>
            <ul class="social footer_social">
                <li class="social_item">
                    <a href="https://github.com/cuba-platform/cuba" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -github social_icon">
                        <path d="M3.047 3.188C5.109 1.062 7.594 0 10.5 0c2.906 0 5.383 1.055 7.43 3.164C19.977 5.274 21 7.812 21 10.781c0 2.344-.672 4.453-2.016 6.328-1.343 1.875-3.062 3.172-5.156 3.891h-.187c-.375 0-.563-.187-.563-.563l.024-1.054c.015-.672.023-1.29.023-1.852 0-.906-.25-1.578-.75-2.015 1.438-.188 2.602-.649 3.492-1.383.89-.735 1.336-2.04 1.336-3.914 0-1.125-.36-2.094-1.078-2.906.313-.907.281-1.86-.094-2.86h-.234c-.719 0-1.61.375-2.672 1.125a9.858 9.858 0 0 0-2.625-.375c-.844 0-1.719.125-2.625.375-1.063-.75-1.953-1.125-2.672-1.125H4.97c-.375 1-.407 1.953-.094 2.86-.719.812-1.078 1.78-1.078 2.906 0 1.875.437 3.18 1.312 3.914s2.032 1.195 3.47 1.383c-.345.343-.563.828-.657 1.453a2.687 2.687 0 0 1-1.219.281c-.781 0-1.39-.39-1.828-1.172-.406-.687-.953-1.062-1.64-1.125-.657 0-.673.219-.047.656.468.25.859.782 1.171 1.594.032.125.094.274.188.445.094.172.351.399.773.68.422.281.93.422 1.524.422.437 0 .781-.031 1.031-.094v1.828c0 .344-.172.516-.516.516h-.187c-2.125-.719-3.852-2.008-5.18-3.867C.664 15.273 0 13.156 0 10.78c0-2.969 1.016-5.5 3.047-7.594z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://www.linkedin.com/company/cuba-platform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -linkedin social_icon">
                        <path d="M19.305 0c.474 0 .875.155 1.203.465.328.31.492.702.492 1.176v17.554c0 .474-.164.894-.492 1.258-.328.365-.73.547-1.203.547h-17.5c-.474 0-.894-.182-1.258-.547C.182 20.09 0 19.67 0 19.195V1.641C0 1.167.173.775.52.465.866.155 1.294 0 1.805 0h17.5zM6.775 17.613V8.129h-2.71v9.484h2.71zM4.431 6.407c.245.245.566.367.964.367s.728-.13.988-.39.39-.574.39-.942c0-.398-.122-.727-.367-.987s-.567-.39-.965-.39-.727.13-.987.39-.39.59-.39.987c0 .368.122.69.367.965zm13.18 11.206v-5.42c0-1.336-.305-2.348-.916-3.034-.612-.687-1.407-1.03-2.386-1.03-1.048 0-1.922.506-2.62 1.517v-1.3H8.806v9.267h2.884v-5.257c0-.361.034-.614.104-.759.28-.722.77-1.083 1.468-1.083.979 0 1.468.668 1.468 2.005v5.094h2.883z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://www.facebook.com/CUBAplatform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -facebook social_icon">
                        <path d="M17.063 0A3.939 3.939 0 0 1 21 3.938v13.124A3.939 3.939 0 0 1 17.062 21h-2.57v-8.135h2.72l.411-3.172h-3.13V7.67c0-.916.245-1.531 1.571-1.531l1.668-.014v-2.83c-.287-.041-1.285-.123-2.433-.123-2.42 0-4.088 1.476-4.088 4.183v2.338H8.477v3.172h2.734V21H3.937A3.939 3.939 0 0 1 0 17.062V3.938A3.939 3.939 0 0 1 3.938 0h13.124z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://twitter.com/CubaPlatform" target="_blank" class="social_link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon -twitter social_icon">
                            <path d="M17.5 6.59a6.058 6.058 0 0 1-1.654.465 2.903 2.903 0 0 0 1.271-1.6 5.717 5.717 0 0 1-1.832.697 2.847 2.847 0 0 0-2.092-.902 2.87 2.87 0 0 0-2.87 2.871c0 .219.013.451.068.656A8.158 8.158 0 0 1 4.457 5.77c-.246.423-.396.93-.396 1.449 0 .998.464 1.873 1.244 2.392-.479-.013-.93-.15-1.367-.355v.027c0 1.395 1.052 2.557 2.365 2.817-.246.068-.438.109-.698.109-.177 0-.355-.027-.533-.055a2.889 2.889 0 0 0 2.68 1.996A5.782 5.782 0 0 1 3.5 15.34a8.183 8.183 0 0 0 4.402 1.285c5.278 0 8.176-4.375 8.176-8.176 0-.123 0-.246-.014-.369A5.521 5.521 0 0 0 17.5 6.59zM21 3.938v13.124A3.939 3.939 0 0 1 17.062 21H3.938A3.939 3.939 0 0 1 0 17.062V3.938A3.939 3.939 0 0 1 3.938 0h13.124A3.939 3.939 0 0 1 21 3.938z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </a>
                </li>
                <li class="social_item">
                    <a href="https://www.youtube.com/c/CubaPlatform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -youtube social_icon">
                        <path d="M27.836 4.648c.11 1.97.164 3.92.164 5.852 0 1.932-.055 3.883-.164 5.852 0 1.24-.392 2.287-1.176 3.144-.784.857-1.74 1.285-2.87 1.285-2.808.146-6.071.219-9.79.219-3.719 0-6.982-.073-9.79-.219-1.13 0-2.086-.428-2.87-1.285C.556 18.64.164 17.591.164 16.352.054 14.382 0 12.432 0 10.5c0-1.276.073-3.227.219-5.852 0-1.24.383-2.287 1.148-3.144C2.133.647 3.081.219 4.211.219 6.872.073 9.97 0 13.508 0h.984c3.537 0 6.636.073 9.297.219 1.13 0 2.087.428 2.871 1.285.784.857 1.176 1.905 1.176 3.144zM11.32 15.86l7.93-5.359-7.93-5.414v10.773z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="/rss.xml" class="social_link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon -rss social_icon">
                            <path d="M.857 15.91C1.464 15.305 2.18 15 3 15c.821 0 1.527.295 2.116.884.59.59.884 1.295.884 2.116 0 .821-.295 1.527-.884 2.116-.59.59-1.295.884-2.116.884-.821 0-1.527-.295-2.116-.884C.294 19.526 0 18.821 0 18c0-.821.286-1.518.857-2.09zM0 7c3.828 0 7.118 1.376 9.871 4.129C12.624 13.882 14 17.172 14 21H9.625c0-2.917-.875-5.25-2.625-7s-4.083-2.625-7-2.625V7zm0-7c5.797 0 10.746 2.05 14.848 6.152C18.949 10.254 21 15.203 21 21h-4.375c0-4.667-1.604-8.604-4.813-11.813C8.604 5.98 4.668 4.375 0 4.375V0z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</footer>
<!--<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/83f852ef4b5c91802566.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/d3a40ea16eeb2e16777d.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/9bd7e05c04e06e762b47.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/70ff0a2e2f971caf4892.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/cf082d0abe0e606c10b9.js" defer></script>-->
<style>
    [class*="column"] + [class*="column"]:last-child {
        float: none;
    }
</style>


<!-- BEGIN FOOTER -->
<!--<footer id="footer">
    <div class="footer-wrapper cuba-container">
        <div class="region region-footer-sitemap">
            <section id="block-footer-sitemap-footer-sitemap" class="block block-footer-sitemap clearfix">
                <div id="footer-sitemap" class="clearfix">
                    <div class="fs-block-content">
                        <div class="menu-footer-sitemap">
                            <ul class="footer_links_menu-footer-sitemap total-items-5 parent-items-0 single-items-0">
                                <li class="menu-1466 depth-1 total-children-4 parent-children-0 single-children-4  first">
                                    <a href="/framework" class="fs-root-link">Platform</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-4 parent-items-0 single-items-0">
                                        <li class="menu-2770 depth-2 fs-no-children  first"><a href="/framework">The Framework</a></li>
                                        <li class="menu-1473 depth-2 fs-no-children"><a href="/development-tools">Development Tools</a></li>
                                        <li class="menu-2838 depth-2 fs-no-children last"><a href="/marketplace">Marketplace</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1469 depth-1 total-children-7 parent-children-0 single-children-7">
                                    <a href="/online-demo" class="fs-root-link">Learn</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-7 parent-items-0 single-items-0">
                                        <li class="menu-1479 depth-2 fs-no-children first"><a href="/online-demo">Online demo</a></li>
                                        <li class="menu-1477 depth-2 fs-no-children"><a href="/quickstart">Quick start</a></li>
                                        <li class="menu-1478 depth-2 fs-no-children"><a href="/documentation">Documentation</a></li>
                                        <li class="menu-1731 depth-2 fs-no-children"><a href="/guides">Guides</a></li>
                                        <li class="menu-1773 depth-2 fs-no-children"><a href="/webinars">Webinars</a></li>
                                        <li class="menu-1602 depth-2 fs-no-children last"><a href="/faq">FAQ</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1603 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="https://www.cuba-platform.com/discuss/" class="fs-root-link">Community</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1604 depth-2 fs-no-children first"><a href="https://www.cuba-platform.com/discuss/">Forum</a></li>
                                        <li class="menu-1692 depth-2 fs-no-children"><a href="/testimonials">Customer stories</a></li>
                                        <li class="menu-1615 depth-2 fs-no-children last"><a href="/blog">Blog</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1663 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="/training" class="fs-root-link">Services</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1756 depth-2 fs-no-children first"><a href="/training">Training</a></li>
                                        <li class="menu-1757 depth-2 fs-no-children"><a href="/support-options">Support</a></li>
                                        <li class="menu-1758 depth-2 fs-no-children last"><a href="/deployment">Development</a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="menu-1612 depth-1 total-children-3 parent-children-0 single-children-3  last">
                                    <a href="/download" class="fs-root-link">More</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-2773 depth-2 fs-no-children first"><a href="/download">Download</a></li>
                                        <li class="menu-2775 depth-2 fs-no-children"><a href="/store">Store</a></li>
                                        <li class="menu-1480 depth-2 fs-no-children last"><a href="/contacts">Contacts</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </section>
        </div>
        <div class="region region-footer-copyright">
            <section id="block-block-14" class="block block-block clearfix">
                <div class="footer-copyright">
                    <div class="copyright">Copyright &copy; 2008-2018 Haulmont</div>
                    <div class="licences"><a href="/terms-of-use">Terms of Use</a></div>
                    <div class="socials">
                        <ul>
                            <li><a href="https://github.com/cuba-platform/cuba" class="socials-icon github"></a></li>
                            <li><a href="https://www.youtube.com/c/CubaPlatform" class="socials-icon youtube"></a></li>
                            <li><a href="https://www.facebook.com/CUBAplatform" class="socials-icon facebook"></a></li>
                            <li><a href="https://twitter.com/CubaPlatform" class="socials-icon twitter"></a></li>
                            <li><a href="https://www.linkedin.com/company/cuba-platform" class="socials-icon linkedin"></a></li>
                            <li><a href="https://www.cuba-platform.com/rss.xml" class="socials-icon rss"></a></li>
                        </ul>
                    </div>
                </div>
                <script async defer src="https://buttons.github.io/buttons.js"></script>
            </section>
        </div>
    </div>
</footer>-->
<!-- END FOOTER -->
<div class="scrollTop"></div>
</section>

<script src="/guides/js/foundation.min.js"></script>
<script src="https://unpkg.com/isotope-layout@3.0/dist/isotope.pkgd.js"></script>
<script src="/guides/js/vendor/modernizr.js"></script>
<script src="/guides/js/toc.js"></script>
<script src="/guides/js/navigation.js"></script>
<script src="/guides/js/navbar.js"></script>
<script src="/guides/js/extra.js"></script>
<script src="/guides/js/extra2.js"></script>
<script src="/guides/js/cuba-new.js"></script>
<script>
(function ($) {
  $(document).foundation();
  var doc = document.documentElement;
  doc.setAttribute('data-useragent', navigator.userAgent)

  /* Issue #24 */
  $(".blog .content img").each(function() {
    var imgMarkup = $(this)[0].outerHTML;
    console.log(imgMarkup);
    $(this).replaceWith('<div class="img-center">' + imgMarkup + '</div>');
  });

})(jQuery);

// Cache selectors
var lastId,
    topMenu = $(".sectlevel1"),
    topMenuHeight = topMenu.outerHeight()+1,

    // All list items
    menuItems = topMenu.find("a"),
    // Anchors corresponding to menu items
    scrollItems = menuItems.map(function(){
        var item = $($(this).attr("href"));
        if (item.length) { return item; }
    });
console.log(topMenuHeight );
menuItems.click(function(e){
    var href = $(this).attr("href"),
        offsetTop = href === "#" ? 0 : $(href).offset().top - 85;
    $('html, body').stop().animate({
        scrollTop: offsetTop
    }, 850);
    e.preventDefault();
    window.location =  href;
});

$( document ).ready(function() {
    const hash = location.hash.replace('#','');
    if(hash !== ''){
        $('html, body').stop().animate({ scrollTop: $('a[href=#' + hash + ']').offset().top - 85}, 850);
    }
});

// Bind to scroll
$(window).scroll(function(){
    // Get container scroll position
    var fromTop = $(this).scrollTop()+topMenuHeight;

    // Get id of current scroll item
    var cur = scrollItems.map(function(){
        if ($(this).offset().top < fromTop)
            return this;
    });
    // Get the id of the current element
    cur = cur[cur.length-1];
    var id = cur && cur.length ? cur[0].id : "";

    if (lastId !== id) {
        lastId = id;
        // Set/remove active class
        menuItems
            .parent().removeClass("active")
            .end().filter("[href=#"+id+"]").parent().addClass("active");
    }
});

</script>
</body>
</html>
