<!doctype html>
<!--[if IE 9]>
<html class="lt-ie10" lang="en"> <![endif]-->
<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anonymous Access &amp; Social Login</title>
    <meta name="description" content="The CUBA Platform guides cover different aspects of the CUBA Platform and give you advice on how to work with CUBA Platform by giving you concrete examples.">
    <meta name="author" content="Haulmont">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@CubaPlatform">
    <meta name="twitter:creator" content="@CubaPlatform">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Anonymous Access &amp; Social Login">
    <meta property="og:description" content="In this guide the anonymous access feature and social login implementation are explained">
    <meta property="og:url" content="https://www.cuba-platform.com/guides/anonymous-access-and-social-login">
    <meta property="og:image" content="">

    <link rel="shortcut icon" href="/guides/images/favicon.png" type="image/png" />
    <link rel="stylesheet" href="/guides/css/foundation.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.css">
    <link rel="stylesheet" href="/guides/css/coderay.css">
    <link rel="stylesheet" href="/guides/css/bootstrap.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/reset.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/animate.css">
    <link rel="stylesheet" href="/guides/css/extra.css">
    <link rel="stylesheet" href="/guides/css/extra2.css">
    <link rel="stylesheet" href="/guides/css/cuba-new.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.min.css">
    <link rel="stylesheet" href="/guides/css/guides.css">
    <script src="/guides/js/jquery_v2.1.min.js"></script>
    <link rel="stylesheet" href="/guides/css/main.css" />
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MH3DTWV');</script>
<!-- End Google Tag Manager -->
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-962 node-type-blog-post i18n-en">

<section id="wrapper">
    
<header role="banner" fragment="14269c1b298" class="header">
    <nav class="header_nav">
        <input id="mobile-menu-open" type="checkbox" class="header_checkbox">
        <div class="container header_container">
            <div class="header_toggle">
                <label for="mobile-menu-open"
                       class="header_toggle-label toggle-label">
                    <span>CUBA.platform</span>
                </label>
            </div>
            <a href="/" class="header_logo nuxt-link-active"></a>
            <ul class="header_menu">
                <li class="header_menu_item"><a href="/framework/" class="header_menu_link">Framework</a></li>
                <li class="header_menu_item"><a href="/learn/" class="header_menu_link nuxt-link-active">Learn</a></li>
                <li class="header_menu_item"><a href="/documentation/" class="header_menu_link">Documentation</a></li>
                <li class="header_menu_item"><a href="/discuss/" class="header_menu_link">Forum</a></li>
                <li class="header_menu_item"><a href="/blog/" class="header_menu_link">Blog</a></li>
            </ul>
            <div class="header-support">
                <button class="header-support_toggle">
                <img src="images/users.svg" class="header-support_toggle_icon">
                <span class="header-support_toggle_text">Services</span></button>
                <div class="header-support_popup">
                    <div class="support-popup">
                        <div class="support-popup_services">
                            <h3 class="support-popup_services_title">Commercial services for your project</h3>
                            <ul class="services-list">
                                <li class="services-list_item"><a href="/support-options/"><strong
                                        class="services-list_title">Consultancy &amp; Support</strong>
                                    <div class="services-list_text">
                                        <div><p>Commercial consulting requests have a guaranteed response
                                            time.</p>
                                        </div>
                                    </div>
                                </a></li>
                                <li class="services-list_item"><a href="/development/"><strong
                                        class="services-list_title">Custom Development</strong>
                                    <div class="services-list_text">
                                        <div><p>We can deliver a turn key solution or contribute to your
                                            project</p>
                                        </div>
                                    </div>
                                </a></li>
                                <li class="services-list_item"><a href="/training/"><strong
                                        class="services-list_title">Training</strong>
                                    <div class="services-list_text">
                                        <div><p>For fast and deep dive into framework features to shift your
                                            team productivity.</p>
                                        </div>
                                    </div>
                                </a></li>
                            </ul>
                        </div>
                        <div class="support-popup_haulmont">
                            <div class="support-popup_haulmont_header"><h3 class="support-popup_haulmont_title">
                                Haulmont</h3>
                                <div class="support-popup_haulmont_subtitle">we develop modern enterprise
                                    solutions
                                </div>
                            </div>
                            <ul class="haulmont-list">
                                <li class="haulmont-list_item">
                                    <div><p>Experts in Enterprise software</p>
                                    </div>
                                </li>
                                <li class="haulmont-list_item">
                                    <div><p>Creators of the CUBA Platform</p>
                                    </div>
                                </li>
                                <li class="haulmont-list_item">
                                    <div><p>Established in 2008</p>
                                    </div>
                                </li>
                            </ul>
                            <ul class="numbers-list">
                                <li class="numbers-list_item"><strong class="numbers-list_number">300+</strong>
                                    <div class="numbers-list_text">developers</div>
                                </li>
                                <li class="numbers-list_item"><strong class="numbers-list_number">400+</strong>
                                    <div class="numbers-list_text">projects</div>
                                </li>
                                <li class="numbers-list_item">
                                    <div class="numbers-list_text">Customers in</div>
                                    <strong class="numbers-list_number">60+</strong>
                                    <div class="numbers-list_text">countries</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <a href="/user/" class="header_profile">
                <svg xmlns="http://www.w3.org/2000/svg" id="i-profile" class="icon header_profile_src" viewBox="0 0 563.43 563.43" width="100%" height="100%">
                    <path d="M280.79 314.559c83.266 0 150.803-67.538 150.803-150.803S364.055 13.415 280.79 13.415 129.987 80.953 129.987 163.756s67.537 150.803 150.803 150.803zm0-261.824c61.061 0 111.021 49.959 111.021 111.021s-49.96 111.02-111.021 111.02-111.021-49.959-111.021-111.021 49.959-111.02 111.021-111.02zM19.891 550.015h523.648c11.102 0 19.891-8.789 19.891-19.891 0-104.082-84.653-189.198-189.198-189.198H189.198C85.116 340.926 0 425.579 0 530.124c0 11.102 8.789 19.891 19.891 19.891zm169.307-169.307h185.034c75.864 0 138.313 56.436 148.028 129.524H41.17c9.714-72.625 72.164-129.524 148.028-129.524z"></path>
                </svg>
            </a>
        </div>
    </nav>
    <nav class="header-submenu">
        <div class="container header-submenu_container">
            <a href="/learn/quickstart/" class="header-submenu_link">Quick Start</a>
            <a href="/learn/live-demo/" class="header-submenu_link">Live Demo</a>
            <a href="/guides/" class="header-submenu_link nuxt-link-exact-active nuxt-link-active">Guides</a>
        </div>
    </nav>
</header>

<style>
    .upper-header .header-options {
        display: none;
    }

    .upper-header .upper-header-wrapper .header-menu div .nav > li:last-child > a {
        padding-right: 0;
    }
</style>

    <!-- Main Page Content and Sidebar -->
    <div class="content-wrapper">
        <div class="cuba-container text-node blog">



            <!-- Main content (left column) -->
            <div class="region region-content">



                <section id="block-system-main" class="block block-system clearfix">
                    <div id="node-962" class="article node node-blog-post node-promoted clearfix">
                        <div class="content">
                            <div class="field field-name-body field-type-text-with-summary field-label-hidden">
                                <div class="field-items">
                                    <div class="field-item even" property="content: encoded">
                                        <h1>Anonymous Access &amp; Social Login</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Applications such as online stores provide users the ability to view a list of available products, read their description, or compare with each other without logging in. But in order to make a purchase, users usually have to register, and using a social network account is the most convenient way to do it.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what_will_be_built"><a class="anchor" href="#what_will_be_built"></a><a class="link" href="#what_will_be_built">What Will Be Built</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide enhances the CUBA Petclinic example to demonstrate how to enable application public access and allow users to register via social services.</p>
</div>
<div class="paragraph">
<p>In particular, the following topics will be covered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Anonymous access</p>
</li>
<li>
<p>Custom Login Dialog</p>
</li>
<li>
<p>OAuth Web Flow</p>
</li>
<li>
<p>Social Login</p>
</li>
<li>
<p>Auto-registration</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="final_application"><a class="anchor" href="#final_application"></a><a class="link" href="#final_application">Final Application</a></h3>
<a href="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-social-login/master/img/cuba-petclinic-overview.gif">
  <img src="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-social-login/master/img/login-dialog.png"/>
</a>
</div>
<div class="sect2">
<h3 id="requirements"><a class="anchor" href="#requirements"></a><a class="link" href="#requirements">Requirements</a></h3>
<div class="paragraph">
<p>Your development environment requires to contain the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://adoptopenjdk.net/">JDK 8</a></p>
</li>
<li>
<p>a text editor or IDE (<a href="https://www.jetbrains.com/idea/download/">IntelliJ IDEA</a> preferred)</p>
</li>
<li>
<p><a href="https://www.cuba-platform.com/download">CUBA Studio</a> as standalone IDE or as an IDEA plugin (optional)</p>
</li>
<li>
<p><a href="https://github.com/cuba-platform/cuba-cli/wiki/Installation">CUBA CLI</a> (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://github.com/cuba-guides/cuba-petclinic-social-login/archive/master.zip">Download</a> and unzip the source repository for this guide, or clone it using git:</p>
</div>
<div class="paragraph">
<p><code>git clone <a href="https://github.com/cuba-guides/cuba-petclinic-social-login.git" class="bare">https://github.com/cuba-guides/cuba-petclinic-social-login.git</a></code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example_cuba_petclinic"><a class="anchor" href="#example_cuba_petclinic"></a><a class="link" href="#example_cuba_petclinic">Example: CUBA petclinic</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The project that is the basis for this example is <a href="https://github.com/cuba-platform/cuba-petclinic">CUBA Petclinic</a>. It is based on the commonly known <a href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a>. The CUBA Petclinic application deals with the domain of a Pet clinic and the associated business workflows to manage a pet clinic.</p>
</div>
<div class="paragraph">
<p>The underlying domain model for the application looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/domain-model.png" alt="Domain model">
</div>
</div>
<div class="paragraph">
<p>The main entities are <strong>Pet</strong> and <strong>Visit</strong>. A Pet is visiting the petclinic and during this Visit a Vet is taking care of it. A Pet belongs to an Owner, which can hold multiple pets. The visit describes the act of a pet visiting the clinic with the help of its owner.</p>
</div>
<a href="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/login-screen.png"/></a>
</div>
</div>
<div class="sect1">
<h2 id="public_access"><a class="anchor" href="#public_access"></a><a class="link" href="#public_access">Public Access</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Oftentimes CRM-like applications have info or features that should be available for both authenticated and anonymous users - products, services, etc. This scenario is also relevant for dashboards, contacts or support pages. In this guide we will provide an ability to view the list of veterinarians working in the clinic and pets that can be brought for treatment without logging in to the application, i.e. working in app anonymously.</p>
</div>
<div class="paragraph">
<p>Since version 7.1 CUBA provides more flexible approach to create publicly available screens that can be easily managed with a built-in security subsystem. We will use it to provide access for Anonymous users.</p>
</div>
<div class="paragraph">
<p>Let’s begin.</p>
</div>
<div class="sect2">
<h3 id="setting_up_anonymous_access"><a class="anchor" href="#setting_up_anonymous_access"></a><a class="link" href="#setting_up_anonymous_access">Setting up Anonymous Access</a></h3>
<div class="paragraph">
<p>The first thing that should be done is enabling anonymous access via application properties:</p>
</div>
<div class="listingblock">
<div class="title">web-app.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">cuba.web.allowAnonymousAccess = true</code></pre>
</div>
</div>
<div class="paragraph">
<p>When this setting is on and the current user session is not authenticated (i.e. not logged in), the application will check permissions of the anonymous user to this screen instead of redirecting to the login screen.</p>
</div>
</div>
<div class="sect2">
<h3 id="initial_screen"><a class="anchor" href="#initial_screen"></a><a class="link" href="#initial_screen">Initial Screen</a></h3>
<div class="paragraph">
<p>The next step is to configure the screen that will be opened by default:</p>
</div>
<div class="listingblock">
<div class="title">web-app.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">cuba.web.initialScreenId = main</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we have the first result:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/anonymous-access-and-social-login/initial-screen.png" alt="initial screen">
</div>
</div>
<div class="paragraph">
<p>The main screen with an empty side menu is opened. But it’s not very interesting to see a blank page - let’s set up permissions for anonymous users.</p>
</div>
</div>
<div class="sect2">
<h3 id="anonymous_permissions"><a class="anchor" href="#anonymous_permissions"></a><a class="link" href="#anonymous_permissions">Anonymous Permissions</a></h3>
<div class="paragraph">
<p>Click the Login button in the side menu to proceed to login screen and enter the system as an administrator. Open “Role” browser and edit “Anonymous” role.</p>
</div>
<div class="paragraph">
<p>Permit all required menu items and screens:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/anonymous-access-and-social-login/screen-permissions.png" alt="screen permissions">
</div>
</div>
<div class="paragraph">
<p>And give permissions to read corresponding entities:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/anonymous-access-and-social-login/entity-permissions.png" alt="entity permissions">
</div>
</div>
<div class="paragraph">
<p>And restart the app. Now anonymous users can view the list of veterinarians:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/anonymous-access-and-social-login/pemitted-screens.png" alt="pemitted screens">
</div>
</div>
</div>
<div class="sect2">
<h3 id="screen_routes"><a class="anchor" href="#screen_routes"></a><a class="link" href="#screen_routes">Screen Routes</a></h3>
<div class="paragraph">
<p>CUBA Navigation feature also supports anonymous access, so let’s register routes for our screens to be able to open screens directly. It can be done with <code>@Route</code> annotation:</p>
</div>
<div class="listingblock">
<div class="title">VetBrowse.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Route</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">vets</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@UiController</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_Vet.browse</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@UiDescriptor</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">vet-browse.xml</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@LookupComponent</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">vetsTable</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@LoadDataBeforeShow</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">VetBrowse</span> <span class="directive">extends</span> StandardLookup&lt;Vet&gt; {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add routes for other screens in the same way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>@Route("pet-types")</code> for <code>PetTypeBrowse</code></p>
</li>
<li>
<p><code>@Route("specs")</code> for <code>SpecialtyBrowse</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Restart the app and try to open the Vets screen using the following link:</p>
</div>
<a href="http://localhost:8080/petclinic/#main/vets">http://localhost:8080/petclinic/#main/vets</a>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/anonymous-access-and-social-login/screen-routes.png" alt="screen routes">
</div>
</div>
<div class="paragraph">
<p>Now users can view the list of veterinarians, bookmark available pages or share links with friends without logging in to the application. Other public pages also can be navigated as usual, but if a user tries to open not permitted screens they will be redirected to the login screen.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="login_dialog"><a class="anchor" href="#login_dialog"></a><a class="link" href="#login_dialog">Login Dialog</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Default login process in CUBA application requires redirecting to a separate screen. In this section, we’ll demonstrate how to implement login using a modal dialog. Later we will place social networks buttons on this dialog.</p>
</div>
<div class="sect2">
<h3 id="extended_main_screen"><a class="anchor" href="#extended_main_screen"></a><a class="link" href="#extended_main_screen">Extended Main Screen</a></h3>
<div class="paragraph">
<p>Let’s begin with extending the default Main Screen. Open “New Screen” dialog in CUBA Studio and choose a template named “Main screen with side menu”. You may notice that the screen layout has a new component - <code>UserActionsButton</code>. It combines “log in” action for anonymous users and allows logged in users to open the "Settings" screen or to log out.</p>
</div>
<div class="paragraph">
<p>The <code>UserActionsButton</code> component has a few extension points to override the default behavior for login and logout actions. It allows us to define our custom logic to open the dialog - add custom login handler via <code>@Install</code> annotation:</p>
</div>
<div class="listingblock">
<div class="title">ExtMainScreen.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@UiController</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@UiDescriptor</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">ext-main-screen.xml</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ExtMainScreen</span> <span class="directive">extends</span> MainScreen {

    <span class="annotation">@Install</span>(to = <span class="string"><span class="delimiter">&quot;</span><span class="content">userActionsButton</span><span class="delimiter">&quot;</span></span>, subject = <span class="string"><span class="delimiter">&quot;</span><span class="content">loginHandler</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="type">void</span> loginHandler(UserActionsButton.LoginHandlerContext ctx) {
        <span class="comment">// will open login dialog later</span>
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="login_dialog_2"><a class="anchor" href="#login_dialog_2"></a><a class="link" href="#login_dialog_2">Login Dialog</a></h3>
<div class="paragraph">
<p>The new login dialog will be a simplified version of the default login screen, so start with creating a new blank screen. Make <code>LoginDialog</code> extend <code>LoginScreen</code> to re-use login process logic:</p>
</div>
<div class="listingblock">
<div class="title">LoginDialog.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@UiDescriptor</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">login-dialog.xml</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@UiController</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">LoginDialog</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoginDialog</span> <span class="directive">extends</span> LoginScreen {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The dialog layout is just a login form copied from the default login screen:</p>
</div>
<div class="listingblock">
<div class="title">login-dialog.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;window</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://schemas.haulmont.com/cuba/screen/window.xsd</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">caption</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mainMsg://loginWindow.loginField</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;actions&gt;</span>
        <span class="tag">&lt;action</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">caption</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mainMsg://loginWindow.okButton</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">icon</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">app/images/login-button.png</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">invoke</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">performLogin</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">shortcut</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ENTER</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/actions&gt;</span>

    <span class="tag">&lt;layout&gt;</span>
        <span class="tag">&lt;vbox</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginMainBox</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">align</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MIDDLE_CENTER</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">margin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
              <span class="attribute-name">width</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">320</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;hbox</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginTitleBox</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">align</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MIDDLE_CENTER</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">spacing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-title</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;image</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">logoImage</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">align</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MIDDLE_LEFT</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">height</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AUTO</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">scaleMode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SCALE_DOWN</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-icon</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">width</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AUTO</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

                <span class="tag">&lt;label</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">welcomeLabel</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">align</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MIDDLE_LEFT</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-caption</span><span class="delimiter">&quot;</span></span>
                       <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mainMsg://loginDialog.label</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/hbox&gt;</span>

            <span class="tag">&lt;capsLockIndicator</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">capsLockIndicator</span><span class="delimiter">&quot;</span></span>
                               <span class="attribute-name">align</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MIDDLE_CENTER</span><span class="delimiter">&quot;</span></span>
                               <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-capslockindicator</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;vbox</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginForm</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">spacing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-form</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;cssLayout</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginCredentials</span><span class="delimiter">&quot;</span></span>
                           <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-credentials</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;textField</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginField</span><span class="delimiter">&quot;</span></span>
                               <span class="attribute-name">htmlName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginField</span><span class="delimiter">&quot;</span></span>
                               <span class="attribute-name">inputPrompt</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mainMsg://loginWindow.loginPlaceholder</span><span class="delimiter">&quot;</span></span>
                               <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-username</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;passwordField</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">passwordField</span><span class="delimiter">&quot;</span></span>
                                   <span class="attribute-name">autocomplete</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
                                   <span class="attribute-name">htmlName</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">passwordField</span><span class="delimiter">&quot;</span></span>
                                   <span class="attribute-name">inputPrompt</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mainMsg://loginWindow.passwordPlaceholder</span><span class="delimiter">&quot;</span></span>
                                   <span class="attribute-name">capsLockIndicator</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">capsLockIndicator</span><span class="delimiter">&quot;</span></span>
                                   <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-password</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/cssLayout&gt;</span>
                <span class="tag">&lt;hbox</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rememberLocalesBox</span><span class="delimiter">&quot;</span></span>
                      <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-remember-locales</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                    <span class="tag">&lt;checkBox</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rememberMeCheckBox</span><span class="delimiter">&quot;</span></span>
                              <span class="attribute-name">caption</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mainMsg://loginWindow.rememberMe</span><span class="delimiter">&quot;</span></span>
                              <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-remember-me</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                    <span class="tag">&lt;lookupField</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localesSelect</span><span class="delimiter">&quot;</span></span>
                                 <span class="attribute-name">nullOptionVisible</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span>
                                 <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-locale</span><span class="delimiter">&quot;</span></span>
                                 <span class="attribute-name">textInputAllowed</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                <span class="tag">&lt;/hbox&gt;</span>
                <span class="tag">&lt;button</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginButton</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">align</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">MIDDLE_CENTER</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">action</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">submit</span><span class="delimiter">&quot;</span></span>
                        <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">c-login-submit-button</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/vbox&gt;</span>
        <span class="tag">&lt;/vbox&gt;</span>
    <span class="tag">&lt;/layout&gt;</span>
<span class="tag">&lt;/window&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Set the dialog width and add a login button click listener:</p>
</div>
<div class="listingblock">
<div class="title">LoginDialog.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Route</span>
<span class="annotation">@DialogMode</span>(width = <span class="string"><span class="delimiter">&quot;</span><span class="content">430</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@UiDescriptor</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">login-dialog.xml</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@UiController</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">LoginDialog</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">LoginDialog</span> <span class="directive">extends</span> LoginScreen {

    <span class="annotation">@Subscribe</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">loginButton</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="type">void</span> onLoginButtonClick(<span class="predefined-type">Button</span>.ClickEvent event) {
        login();

        <span class="keyword">if</span> (connection.isAuthenticated()) {
            close(WINDOW_CLOSE_ACTION);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The new login dialog should be available to all users regardless of their roles, so we’ll use the default permissions mechanism to enable it. Create <code>default-permission-values.xml</code> file in the root package of the <code>core</code> module with the following content:</p>
</div>
<div class="listingblock">
<div class="title">default-permission-values.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;default-permission-values</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://schemas.haulmont.com/cuba/default-permission-values.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="comment">&lt;!-- Permit to open LoginDialog for all roles by default --&gt;</span>
    <span class="tag">&lt;permission</span> <span class="attribute-name">target</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LoginDialog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/default-permission-values&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And append this config to default permissions in <code>app.properties</code> file:</p>
</div>
<div class="listingblock">
<div class="title">app.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">cuba.defaultPermissionValuesConfig = +com/haulmont/sample/petclinic/default-permission-values.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can open our new dialog in <code>UserActionsButton</code> login handler:</p>
</div>
<div class="listingblock">
<div class="title">ExtMainScreen.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@UiController</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">main</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@UiDescriptor</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">ext-main-screen.xml</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">ExtMainScreen</span> <span class="directive">extends</span> MainScreen {

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> Screens screens;

    <span class="annotation">@Install</span>(to = <span class="string"><span class="delimiter">&quot;</span><span class="content">userActionsButton</span><span class="delimiter">&quot;</span></span>, subject = <span class="string"><span class="delimiter">&quot;</span><span class="content">loginHandler</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="type">void</span> loginHandler(UserActionsButton.LoginHandlerContext ctx) {
        screens.create(LoginDialog.class, OpenMode.DIALOG)
                .show();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Restart the app and try to log in:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/anonymous-access-and-social-login/login-dialog-init.png" alt="login dialog init">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="social_login"><a class="anchor" href="#social_login"></a><a class="link" href="#social_login">Social Login</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In most cases, applications and services require to register an account to use their features. Registration itself often involves filling out tedious forms and confirming an email address. One of the approaches that solves this problem and has become widespread is registration via social services like Google or Facebook.</p>
</div>
<div class="paragraph">
<p>The flow usually looks like this: the application redirects users to the social network login page, and after the users have allowed the requested access, they are redirected back to the application. Since application automatically registers a user account, it eliminates the need to fill in the fields and reduces the access time to the services it needs.</p>
</div>
<div class="paragraph">
<p>This approach is called "OAuth Web Flow" and we will use it to integrate the social login into Petclinic application.</p>
</div>
<div class="sect2">
<h3 id="oauth_web_flow"><a class="anchor" href="#oauth_web_flow"></a><a class="link" href="#oauth_web_flow">OAuth Web Flow</a></h3>
<div class="paragraph">
<p>One of the main tasks of the application is to automatically register a new account for user. It requires basic info like name, email, etc. Popular social network services like Facebook provide API endpoints to access this information. The common way to secure these endpoints is to use <a href="https://oauth.net">OAuth</a> tokens, or “access tokens”.</p>
</div>
<div class="paragraph">
<p>First of all you should register your app in the social service:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://cloud.google.com/cloud-console/">Google Cloud Console</a></p>
</li>
<li>
<p><a href="https://developers.facebook.com/apps">Facebook Apps</a></p>
</li>
<li>
<p><a href="https://github.com/settings/apps">GitHub Apps</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You’ll get a so-called <code>client id</code> and <code>client secret</code> credentials that are used in the authentication process:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The application sends a request with a client id to the auth service endpoint.</p>
</li>
<li>
<p>The service returns a response with a temporary code.</p>
</li>
<li>
<p>The application sends a request with a client id, client secret and the given code to the service.</p>
</li>
<li>
<p>The service returns a response with an access token if all credentials are correct.</p>
</li>
</ol>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/anonymous-access-and-social-login/web-auth-flow.png" alt="web auth flow">
</div>
</div>
</div>
<div class="sect2">
<h3 id="social_buttons"><a class="anchor" href="#social_buttons"></a><a class="link" href="#social_buttons">Social Buttons</a></h3>
<div class="paragraph">
<p>One of the most common ways to integrate social login in the UI is buttons in the registration dialog, for example, Pinterest:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/anonymous-access-and-social-login/pinterest-login.png" alt="pinterest login">
</div>
</div>
<div class="paragraph">
<p>Add social buttons into the Login Dialog using <code>LinkButton</code> components placed into a horizontal box layout:</p>
</div>
<div class="listingblock">
<div class="title">login-dialog.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;hbox</span> <span class="attribute-name">align</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">TOP_CENTER</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">margin</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true;false;false;false</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">spacing</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">width</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AUTO</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;linkButton</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">googleLogin</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">icon</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">GOOGLE</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">social-button</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;linkButton</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">facebookLogin</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">icon</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FACEBOOK</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">social-button</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;linkButton</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">githubLogin</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">icon</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">GITHUB</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">stylename</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">social-button</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/hbox&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We’re using a custom style name to make buttons bigger. Open <code>hover-ext.scss</code> file and add the following rule:</p>
</div>
<div class="listingblock">
<div class="title">hover-ext.scss</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">.v-button-link.social-button {
  font-size: round($v-unit-size * 0.8);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Result:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/anonymous-access-and-social-login/social-buttons.png" alt="social buttons">
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll use these buttons later to trigger social login process.</p>
</div>
</div>
<div class="sect2">
<h3 id="preliminary_preparation"><a class="anchor" href="#preliminary_preparation"></a><a class="link" href="#preliminary_preparation">Preliminary Preparation</a></h3>
<div class="paragraph">
<p>Not all services support <code>localhost</code> as application host. You can add a host alias to the operating system hosts file and use it in the application properties:</p>
</div>
<div class="listingblock">
<div class="title">app.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">cuba.webAppUrl = https://petclinic.com:8080/petclinic</code></pre>
</div>
</div>
<div class="paragraph">
<p>Moreover, the majority of social services require to use HTTPS - you can find a detailed guide on how to enable SSL for Tomcat container at <a href="https://tomcat.apache.org/tomcat-9.0-doc/ssl-howto.html" class="bare">https://tomcat.apache.org/tomcat-9.0-doc/ssl-howto.html</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="social_services_configuration"><a class="anchor" href="#social_services_configuration"></a><a class="link" href="#social_services_configuration">Social Services Configuration</a></h3>
<div class="paragraph">
<p>It’s assumed that the app is already registered in social services and the required credentials (<code>client id</code> and <code>client secret</code>) are available.</p>
</div>
<div class="paragraph">
<p>To store service credentials we’ll use the configuration interfaces mechanism. Let’s introduce the following configs:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>GoogleConfig</code></p>
</li>
<li>
<p><code>FacebookConfig</code></p>
</li>
<li>
<p><code>GitHubConfig</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since a set of credentials is the same for all the services we can create a common interface <code>SocialServiceConfig</code>:</p>
</div>
<div class="listingblock">
<div class="title">SocialServiceConfig.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SocialServiceConfig</span> {

    <span class="predefined-type">String</span> getClientId();

    <span class="predefined-type">String</span> getClientSecret();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So, for example, <code>GoogleConfig</code> will be:</p>
</div>
<div class="listingblock">
<div class="title">GoogleConfig.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Source</span>(type = SourceType.APP)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">GoogleConfig</span> <span class="directive">extends</span> Config, SocialServiceConfig {

    <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">google.clientId</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> getClientId();

    <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">google.clientSecret</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> getClientSecret();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After getting the <code>client id</code> and <code>client secret</code> from a social service, write them down to <code>app.properties</code> and restart the application:</p>
</div>
<div class="listingblock">
<div class="title">app.properties</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">google.clientId = &lt;APP_CLIENT_ID&gt;
google.clientSecret = &lt;APP_CLIENT_SECRET&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="getting_an_auth_code"><a class="anchor" href="#getting_an_auth_code"></a><a class="link" href="#getting_an_auth_code">Getting an Auth Code</a></h3>
<div class="paragraph">
<p>The first step of authentication is to get an auth code - a temporary code that will be exchanged for an access token. To get a code we should redirect a user to the service authentication endpoint and handle a response.</p>
</div>
<div class="paragraph">
<p>Authentication process is almost the same for all social services, so we can write generic code. The main difference is connected with auth endpoint URLs, params, etc, so in the beginning, we introduce the following enum:</p>
</div>
<div class="listingblock">
<div class="title">SocialService.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">enum</span> SocialService {

    GOOGLE,
    FACEBOOK,
    GITHUB
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s create a service that will generate an address of authentication endpoint:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginService.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SocialLoginService</span> {

    <span class="predefined-type">String</span> NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_SocialLoginService</span><span class="delimiter">&quot;</span></span>;

    <span class="predefined-type">String</span> getLoginUrl(SocialService socialService);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To form a login address we should combine the endpoint URL and the required parameters:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginServiceBean</span> <span class="directive">implements</span> SocialLoginService {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getLoginUrl(SocialService socialService) {
        <span class="predefined-type">String</span> authEndpoint = SocialLoginHelper.getAuthEndpoint(socialService);
        <span class="predefined-type">String</span> params = SocialLoginHelper.getAuthParams(
                socialService,
                getClientId(socialService),
                getRedirectUri());
        <span class="keyword">return</span> authEndpoint + params;
    }

    <span class="directive">private</span> <span class="predefined-type">String</span> getClientId(SocialService socialService) {
        <span class="keyword">return</span> getSocialServiceConfig(socialService).getClientId();
    }

    <span class="directive">private</span> SocialServiceConfig getSocialServiceConfig(SocialService socialService) {
        <span class="keyword">switch</span> (socialService) {
            <span class="keyword">case</span> GOOGLE:
                <span class="keyword">return</span> configuration.getConfig(GoogleConfig.class);
            <span class="keyword">case</span> FACEBOOK:
                <span class="keyword">return</span> configuration.getConfig(FacebookConfig.class);
            <span class="keyword">case</span> GITHUB:
                <span class="keyword">return</span> configuration.getConfig(GitHubConfig.class);
            <span class="keyword">default</span>:
                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">No config found for service: </span><span class="delimiter">&quot;</span></span> + socialService);
            }
    }

    <span class="directive">private</span> <span class="predefined-type">String</span> getRedirectUri() {
        <span class="keyword">return</span> configuration.getConfig(GlobalConfig.class).getWebAppUrl();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>SocialLoginHelper</code> is a utility class that contains auth URLs and generates parameters part:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginHelper.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">SocialLoginHelper</span> {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GOOGLE_AUTH_ENDPOINT =
            <span class="string"><span class="delimiter">&quot;</span><span class="content">https://accounts.google.com/o/oauth2/v2/auth?</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> FACEBOOK_AUTH_ENDPOINT =
            <span class="string"><span class="delimiter">&quot;</span><span class="content">https://www.facebook.com/v3.3/dialog/oauth?</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> GITHUB_AUTH_ENDPOINT =
            <span class="string"><span class="delimiter">&quot;</span><span class="content">https://github.com/login/oauth/authorize?</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">public</span> <span class="directive">static</span> <span class="predefined-type">String</span> getAuthEndpoint(SocialService socialService) {
        <span class="keyword">switch</span> (socialService) {
            <span class="keyword">case</span> GOOGLE:
                <span class="keyword">return</span> GOOGLE_AUTH_ENDPOINT;
            <span class="keyword">case</span> FACEBOOK:
                <span class="keyword">return</span> FACEBOOK_AUTH_ENDPOINT;
            <span class="keyword">case</span> GITHUB:
                <span class="keyword">return</span> GITHUB_AUTH_ENDPOINT;
        }
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">No auth endpoint found for service: </span><span class="delimiter">&quot;</span></span> + socialService);
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add social button click listeners and redirect a user to a social service login page:</p>
</div>
<div class="listingblock">
<div class="title">LoginDialog.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LoginDialog</span> <span class="directive">extends</span> LoginScreen {

    <span class="annotation">@Subscribe</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">googleLogin</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> <span class="type">void</span> onGoogleLoginClick(<span class="predefined-type">Button</span>.ClickEvent event) {
        performSocialLogin(SocialService.GOOGLE);
    }

    <span class="directive">private</span> <span class="type">void</span> performSocialLogin(SocialService socialService) {
        <span class="predefined-type">String</span> loginUrl = socialLoginService.getLoginUrl(socialService);

        Page.getCurrent()
                .setLocation(loginUrl);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>After logging in, the service will redirect us back and we should handle a response.</p>
</div>
</div>
<div class="sect2">
<h3 id="handling_social_service_response"><a class="anchor" href="#handling_social_service_response"></a><a class="link" href="#handling_social_service_response">Handling Social Service Response</a></h3>
<div class="paragraph">
<p>To handle a response with the temporary code we will use Vaadin <a href="https://vaadin.com/docs/v8/framework/advanced/advanced-requesthandler.html">Request Handlers</a> mechanism -
it allows us to add request callbacks using simple functional interface.</p>
</div>
<div class="paragraph">
<p>Our callback handler will use <code>SocialLoginService</code> to fetch user data, so it should be a bean. Request handlers should be added to the current session before the request and removed from it in the end. It means that we can implement the handler as a prototype bean:</p>
</div>
<div class="listingblock">
<div class="title">SocialServiceCallbackHandler.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Scope</span>(BeanDefinition.SCOPE_PROTOTYPE)
<span class="annotation">@Component</span>(SocialServiceCallbackHandler.NAME)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SocialServiceCallbackHandler</span> <span class="directive">implements</span> RequestHandler {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_SocialServiceCallbackHandler</span><span class="delimiter">&quot;</span></span>;

    <span class="directive">private</span> <span class="directive">final</span> SocialService service;
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">URI</span> redirectUri;

    <span class="directive">public</span> SocialServiceCallbackHandler(SocialService service) {
        <span class="local-variable">this</span>.service = service;
        redirectUri = Page.getCurrent().getLocation();
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> handleRequest(VaadinSession session,
                                 VaadinRequest request,
                                 VaadinResponse response) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="keyword">return</span> <span class="predefined-constant">true</span>; <span class="comment">// to be implemented</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s highlight the main responsibilities of the handler:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Extract auth code from response and fetch user data via <code>SocialLoginService</code></p>
</li>
<li>
<p>Create <code>Credentials</code> instance based on user data</p>
</li>
<li>
<p>Trigger login process and redirect user back to the app</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>First, we use the <code>UIAccessor</code> instance to lock the UI until the login request is processed:</p>
</div>
<div class="listingblock">
<div class="title">SocialServiceCallbackHandler.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialServiceCallbackHandler</span> <span class="directive">implements</span> RequestHandler, InitializingBean {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> handleRequest(VaadinSession session, VaadinRequest request,
                                 VaadinResponse response) <span class="directive">throws</span> <span class="exception">IOException</span> {
        <span class="keyword">if</span> (request.getParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>) == <span class="predefined-constant">null</span>) {
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }

        uiAccessor.accessSynchronously(() -&gt; {
            <span class="keyword">try</span> {
                Credentials credentials = getCredentials(request.getParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">code</span><span class="delimiter">&quot;</span></span>),
                        service);
                app.getConnection().login(credentials);
            } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
                log.error(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unable to login using service: </span><span class="delimiter">&quot;</span></span> + service, e);
            } <span class="keyword">finally</span> {
                session.removeRequestHandler(<span class="local-variable">this</span>);
            }
        });

        ((VaadinServletResponse) response).getHttpServletResponse().
                sendRedirect(ControllerUtils.getLocationWithoutParams(redirectUri));

        <span class="keyword">return</span> <span class="predefined-constant">true</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> afterPropertiesSet() {
        uiAccessor = backgroundWorker.getUIAccessor();
    }

    <span class="directive">private</span> Credentials getCredentials(<span class="predefined-type">String</span> authCode, SocialService socialService) {
        <span class="keyword">return</span> <span class="predefined-constant">null</span>; <span class="comment">// to be implemented</span>
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get back to <code>LoginDialog</code> and use the callback handler:</p>
</div>
<div class="listingblock">
<div class="title">LoginDialog.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">LoginDialog</span> <span class="directive">extends</span> LoginScreen {

    <span class="directive">private</span> <span class="type">void</span> performSocialLogin(SocialService socialService) {
        <span class="predefined-type">String</span> loginUrl = socialLoginService.getLoginUrl(socialService);

        VaadinSession.getCurrent()
                .addRequestHandler(getCallbackHandler(socialService));

        close(WINDOW_CLOSE_ACTION);

        Page.getCurrent()
                .setLocation(loginUrl);
    }

    <span class="directive">private</span> RequestHandler getCallbackHandler(SocialService socialService) {
        <span class="keyword">return</span> getBeanLocator()
                .getPrototype(SocialServiceCallbackHandler.NAME, socialService);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="exchanging_an_auth_code_for_access_token"><a class="anchor" href="#exchanging_an_auth_code_for_access_token"></a><a class="link" href="#exchanging_an_auth_code_for_access_token">Exchanging an Auth Code for Access Token</a></h3>
<div class="paragraph">
<p>When the auth code is available, we can use it to get an access token. Form a request with the required params depending on the social network service:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginServiceBean</span> <span class="directive">implements</span> SocialLoginService {

    <span class="directive">private</span> HttpRequestBase getAccessTokenRequest(SocialService socialService,
            <span class="predefined-type">String</span> authCode) {
        <span class="keyword">switch</span> (socialService) {
            <span class="keyword">case</span> GOOGLE: {
                HttpPost tokenRequest = <span class="keyword">new</span> HttpPost(
                        getAccessTokenPath(socialService, authCode));
                tokenRequest.setEntity(getGoogleAccessTokenParams(authCode));
                <span class="keyword">return</span> tokenRequest;
            }
            <span class="keyword">case</span> FACEBOOK:
            <span class="keyword">case</span> GITHUB: {
                HttpGet tokenRequest = <span class="keyword">new</span> HttpGet(
                        getAccessTokenPath(socialService, authCode));
                tokenRequest.setHeader(HttpHeaders.ACCEPT,
                MediaType.APPLICATION_JSON_VALUE);
                <span class="keyword">return</span> tokenRequest;
            }
            <span class="keyword">default</span>:
                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">Unable to create request for social service: </span><span class="delimiter">&quot;</span></span> + socialService);
        }
    }

    <span class="directive">private</span> <span class="predefined-type">String</span> getAccessTokenPath(SocialService socialService, <span class="predefined-type">String</span> authCode) {
        <span class="predefined-type">String</span> clientId = getClientId(socialService);
        <span class="predefined-type">String</span> clientSecret = getClientSecret(socialService);
        <span class="predefined-type">String</span> redirectUri = getRedirectUri();
        <span class="keyword">return</span> SocialLoginHelper.getAccessTokenPath(socialService, clientId,
                clientSecret, redirectUri, authCode);
    }

    <span class="directive">private</span> UrlEncodedFormEntity getGoogleAccessTokenParams(<span class="predefined-type">String</span> authCode) {
        <span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">String</span>&gt; params = SocialLoginHelper.getGoogleAccessTokenParams(
                getClientId(SocialService.GOOGLE),
                getClientSecret(SocialService.GOOGLE),
                getRedirectUri(),
                authCode);

        <span class="predefined-type">List</span>&lt;BasicNameValuePair&gt; requestParams = params.entrySet().stream()
                .map(entry -&gt; <span class="keyword">new</span> BasicNameValuePair(entry.getKey(), entry.getValue()))
                .collect(Collectors.toList());

        <span class="keyword">return</span> <span class="keyword">new</span> UrlEncodedFormEntity(requestParams, StandardCharsets.UTF_8);
    }

    <span class="directive">private</span> <span class="predefined-type">String</span> getClientSecret(SocialService socialService) {
        <span class="keyword">return</span> getSocialServiceConfig(socialService).getClientSecret();
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then use <a href="https://search.maven.org/artifact/org.apache.httpcomponents/httpclient/4.5.10/jar">Apache HttpClient</a>
library to perform request:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginServiceBean</span> <span class="directive">implements</span> SocialLoginService {

    <span class="directive">private</span> <span class="predefined-type">String</span> requestAccessToken(HttpRequestBase accessTokenRequest) {
        HttpClientConnectionManager cm = <span class="keyword">new</span> BasicHttpClientConnectionManager();
        HttpClient httpClient = HttpClientBuilder.create().setConnectionManager(cm)
                .build();

        <span class="keyword">try</span> {
            HttpResponse httpResponse = httpClient.execute(accessTokenRequest);
            <span class="keyword">if</span> (httpResponse.getStatusLine().getStatusCode() != <span class="integer">200</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">Unable to get access token. Response HTTP status: </span><span class="delimiter">&quot;</span></span> +
                        httpResponse.getStatusLine().getStatusCode());
            }
            <span class="keyword">return</span> EntityUtils.toString(httpResponse.getEntity());
            } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(e.getMessage());
            } <span class="keyword">finally</span> {
                accessTokenRequest.releaseConnection();
            }
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And parse access token using
<a href="https://search.maven.org/artifact/com.google.code.gson/gson/2.8.5/jar">Google Gson</a>:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginServiceBean</span> <span class="directive">implements</span> SocialLoginService {

    <span class="directive">private</span> <span class="predefined-type">String</span> extractAccessToken(<span class="predefined-type">String</span> response) {
        JsonParser parser = <span class="keyword">new</span> JsonParser();
        JsonObject asJsonObject = parser.parse(response)
                .getAsJsonObject();

        <span class="keyword">return</span> asJsonObject.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">access_token</span><span class="delimiter">&quot;</span></span>).getAsString();
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All in one:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginServiceBean</span> <span class="directive">implements</span> SocialLoginService {

    <span class="directive">private</span> <span class="predefined-type">String</span> getAccessToken(SocialService socialService, <span class="predefined-type">String</span> authCode) {
        HttpRequestBase accessTokenRequest = getAccessTokenRequest(socialService,
                authCode);
        <span class="predefined-type">String</span> response = requestAccessToken(accessTokenRequest);
        <span class="keyword">return</span> extractAccessToken(response);
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="auto_registration"><a class="anchor" href="#auto_registration"></a><a class="link" href="#auto_registration">Auto-Registration</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The final part of the guide describes how to use the access token to get profile info, register a new account and login the user.</p>
</div>
<div class="sect2">
<h3 id="fetching_user_data"><a class="anchor" href="#fetching_user_data"></a><a class="link" href="#fetching_user_data">Fetching User Data</a></h3>
<div class="paragraph">
<p>Oftentimes social network service API endpoints enable you to specify a set of fields to fetch. Let’s add one more setting to our config interfaces:</p>
</div>
<div class="listingblock">
<div class="title">SocialServiceConfig.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SocialServiceConfig</span> {

    <span class="predefined-type">String</span> getUserDataFields();

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example, <code>GoogleConfig</code>:</p>
</div>
<div class="listingblock">
<div class="title">GoogleConfig.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Source</span>(type = SourceType.APP)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">GoogleConfig</span> <span class="directive">extends</span> Config, SocialServiceConfig {

    <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">google.clientId</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> getClientId();

    <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">google.clientSecret</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> getClientSecret();

    <span class="annotation">@Default</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">id,name,email</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">google.userDataFields</span><span class="delimiter">&quot;</span></span>)
    <span class="predefined-type">String</span> getUserDataFields();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a simple immutable POJO to store the loaded profile info:</p>
</div>
<div class="listingblock">
<div class="title">SocialUserData.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">SocialUserData</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="directive">private</span> <span class="predefined-type">String</span> id;
    <span class="directive">private</span> <span class="predefined-type">String</span> login;
    <span class="directive">private</span> <span class="predefined-type">String</span> name;

    <span class="directive">public</span> SocialUserData(<span class="predefined-type">String</span> id, <span class="predefined-type">String</span> login, <span class="predefined-type">String</span> name) {
        <span class="local-variable">this</span>.id = id;
        <span class="local-variable">this</span>.login = login;
        <span class="local-variable">this</span>.name = name;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getId() {
        <span class="keyword">return</span> id;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getLogin() {
        <span class="keyword">return</span> login;
    }

    <span class="directive">public</span> <span class="predefined-type">String</span> getName() {
        <span class="keyword">return</span> name;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toString() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">SocialUserData{</span><span class="delimiter">&quot;</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">id='</span><span class="delimiter">&quot;</span></span> + id + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">, login='</span><span class="delimiter">&quot;</span></span> + login + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
                <span class="string"><span class="delimiter">&quot;</span><span class="content">, name='</span><span class="delimiter">&quot;</span></span> + name + <span class="string"><span class="delimiter">'</span><span class="char">\'</span><span class="delimiter">'</span></span> +
                <span class="string"><span class="delimiter">'</span><span class="content">}</span><span class="delimiter">'</span></span>;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s add a new <code>SocialLoginService</code> method that will accept the auth code and return corresponding user data.</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginService.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SocialLoginService</span> {

    SocialUserData getUserData(SocialService socialService, <span class="predefined-type">String</span> authCode);

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method will do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fetch an access token using the auth code</p>
</li>
<li>
<p>Fetch user data using access token</p>
</li>
<li>
<p>Parse a response to create <code>SocialUserData</code> instance</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Since exchanging the auth code for the access token is already described, we can proceed to fetching user data:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginServiceBean</span> <span class="directive">implements</span> SocialLoginService {

    <span class="directive">private</span> <span class="predefined-type">String</span> getUserDataAsJson(SocialService socialService, <span class="predefined-type">String</span> accessToken) {
        <span class="predefined-type">String</span> userDataEndpoint = SocialLoginHelper.getUserDataEndpoint(socialService);
        <span class="predefined-type">String</span> params = SocialLoginHelper.getUserDataEndpointParams(
                socialService,
                accessToken,
                getUserDataFields(socialService));
        <span class="predefined-type">String</span> url = userDataEndpoint + params;

        <span class="keyword">return</span> requestUserData(url);
    }

    <span class="directive">private</span> <span class="predefined-type">String</span> requestUserData(<span class="predefined-type">String</span> url) {
        HttpClientConnectionManager cm = <span class="keyword">new</span> BasicHttpClientConnectionManager();
        HttpClient httpClient = HttpClientBuilder.create().setConnectionManager(cm)
                .build();

        HttpGet getRequest = <span class="keyword">new</span> HttpGet(url);
        <span class="keyword">try</span> {
            HttpResponse httpResponse = httpClient.execute(getRequest);
            <span class="keyword">if</span> (httpResponse.getStatusLine().getStatusCode() != <span class="integer">200</span>) {
                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">Unable to access Google API. Response HTTP status: </span><span class="delimiter">&quot;</span></span> +
                        httpResponse.getStatusLine().getStatusCode());
            }
            <span class="keyword">return</span> EntityUtils.toString(httpResponse.getEntity());
        } <span class="keyword">catch</span> (<span class="exception">IOException</span> e) {
            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">RuntimeException</span>(e.getMessage());
        } <span class="keyword">finally</span> {
            getRequest.releaseConnection();
        }
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parse user data from the response into <code>SocialUserData</code> POJO:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginServiceBean</span> <span class="directive">implements</span> SocialLoginService {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> SocialUserData getUserData(SocialService socialService, <span class="predefined-type">String</span> authCode) {
        <span class="predefined-type">String</span> accessToken = getAccessToken(socialService, authCode);
        <span class="predefined-type">String</span> userDataJson = getUserDataAsJson(socialService, accessToken);
        <span class="keyword">return</span> parseUserData(userDataJson);
    }

    <span class="directive">private</span> SocialUserData parseUserData(<span class="predefined-type">String</span> userDataJson) {
        JsonParser parser = <span class="keyword">new</span> JsonParser();

        JsonObject response = parser.parse(userDataJson)
                .getAsJsonObject();

        <span class="predefined-type">String</span> id = Strings.nullToEmpty(response.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>).getAsString());
        <span class="predefined-type">String</span> name = Strings.nullToEmpty(response.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>).getAsString());

        <span class="predefined-type">String</span> login = Strings.nullToEmpty(response.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">email</span><span class="delimiter">&quot;</span></span>).getAsString());
        <span class="keyword">if</span> (StringUtils.isEmpty(login)) {
            login = Strings.nullToEmpty(response.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">login</span><span class="delimiter">&quot;</span></span>).getAsString());
        }

        <span class="keyword">return</span> <span class="keyword">new</span> SocialUserData(id, login, name);
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="social_credentials"><a class="anchor" href="#social_credentials"></a><a class="link" href="#social_credentials">Social Credentials</a></h3>
<div class="paragraph">
<p>Now we can log in user via CUBA Security Subsystem. The general workflow is the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>Credentials</code> instance is passed into <code>Connection</code></p>
</li>
<li>
<p><code>Connection</code> iterates over available <code>LoginProviders</code> and checks whether it supports the passed credentials</p>
</li>
<li>
<p>When suitable provider is found <code>Connection</code> delegates invocation to it</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To support custom login you should create your own <code>Credentials</code> and <code>LoginProvider</code>
that supports such type of credentials.</p>
</div>
<div class="paragraph">
<p>Create a new class <code>SocialCredentials</code> in the <code>web</code> module:</p>
</div>
<div class="listingblock">
<div class="title">SocialCredentials.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialCredentials</span> <span class="directive">extends</span> AbstractClientCredentials {

    <span class="directive">private</span> <span class="directive">final</span> SocialUserData userData;
    <span class="directive">private</span> <span class="directive">final</span> SocialService socialService;

    <span class="directive">public</span> SocialCredentials(SocialUserData userData,
                             SocialService socialService,
                             <span class="predefined-type">Locale</span> locale) {
        <span class="local-variable">super</span>(locale, <span class="predefined-type">Collections</span>.emptyMap());
        <span class="local-variable">this</span>.userData = userData;
        <span class="local-variable">this</span>.socialService = socialService;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getUserIdentifier() {
        <span class="keyword">return</span> userData.getId();
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let’s go back to <code>SocialServiceCallbackHandler</code> to finish its implementation:</p>
</div>
<div class="listingblock">
<div class="title">SocialServiceCallbackHandler.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialServiceCallbackHandler</span> <span class="directive">implements</span> RequestHandler, InitializingBean {

    <span class="directive">private</span> Credentials getCredentials(<span class="predefined-type">String</span> authCode, SocialService socialService) {
        SocialLoginService.SocialUserData userData = socialLoginService
                .getUserData(socialService, authCode);

        <span class="predefined-type">Locale</span> defaultLocale = messages.getTools()
                .getDefaultLocale();

         <span class="keyword">return</span> <span class="keyword">new</span> SocialCredentials(userData, socialService, defaultLocale);
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="login_provider"><a class="anchor" href="#login_provider"></a><a class="link" href="#login_provider">Login Provider</a></h3>
<div class="paragraph">
<p>The <code>Connection</code> component uses all available <code>LoginProviders</code> to get new authentication info. <code>LoginProviders</code> mechanism enables you to use ordered Spring beans to authenticate a user for different types of credentials. We will use this extension point to create a social login provider:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginProvider.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>(SocialLoginProvider.NAME)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginProvider</span> <span class="directive">implements</span> LoginProvider {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_SocialLoginProvider</span><span class="delimiter">&quot;</span></span>;

    <span class="annotation">@Nullable</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> AuthenticationDetails login(Credentials credentials) <span class="directive">throws</span> <span class="exception">LoginException</span> {
        SocialCredentials socialCredentials = (SocialCredentials) credentials;
        SocialLoginService.SocialUserData userData = socialCredentials.getUserData();

        <span class="comment">// to be implemented</span>

        <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> supports(<span class="predefined-type">Class</span>&lt;?&gt; credentialsClass) {
        <span class="keyword">return</span> SocialCredentials.class.isAssignableFrom(credentialsClass);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will extend the built-in <code>ExternalUserLoginProvider</code> to re-use its logic. Create a new <code>ExternalUserCredentials</code> based on the available info and pass it to the super method:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginProvider.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>(SocialLoginProvider.NAME)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginProvider</span> <span class="directive">extends</span> ExternalUserLoginProvider <span class="directive">implements</span> LoginProvider {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">String</span> NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_SocialLoginProvider</span><span class="delimiter">&quot;</span></span>;

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> SocialRegistrationService socialRegistrationService;

    <span class="annotation">@Nullable</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> AuthenticationDetails login(Credentials credentials) <span class="directive">throws</span> <span class="exception">LoginException</span> {
        SocialCredentials socialCredentials = (SocialCredentials) credentials;

        SocialLoginService.SocialUserData userData = socialCredentials.getUserData();

        <span class="comment">// to be implemented;</span>
        User user = <span class="predefined-constant">null</span>;

        <span class="predefined-type">Locale</span> defaultLocale = socialCredentials.getLocale();

        <span class="keyword">return</span> <span class="local-variable">super</span>.login(<span class="keyword">new</span> ExternalUserCredentials(user.getLogin(), defaultLocale));
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To form credentials we have to find an existing or register a new user.</p>
</div>
</div>
<div class="sect2">
<h3 id="user_registration"><a class="anchor" href="#user_registration"></a><a class="link" href="#user_registration">User Registration</a></h3>
<div class="paragraph">
<p>Create a new entity <code>SocialUser</code> extending <code>User</code> and add three fields to it:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>googleId</code></p>
</li>
<li>
<p><code>facebookId</code></p>
</li>
<li>
<p><code>githubId</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These fields are required to bind the social network profile with the system user to be able to find it later. We should also assign a default group to a new user - create a new configuration interface:</p>
</div>
<div class="listingblock">
<div class="title">SocialRegistrationConfig.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Source</span>(type = SourceType.APP)
<span class="directive">public</span> <span class="type">interface</span> <span class="class">SocialRegistrationConfig</span> <span class="directive">extends</span> Config {

    <span class="annotation">@Default</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">0fa2b1a5-1d68-4d69-9fbd-dff348347f93</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Property</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">social.defaultGroupId</span><span class="delimiter">&quot;</span></span>)
    <span class="annotation">@Factory</span>(factory = UuidTypeFactory.class)
    <span class="predefined-type">UUID</span> getDefaultGroupId();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create a new service <code>SocialRegistrationService</code> intended to find existing or register a new user:</p>
</div>
<div class="listingblock">
<div class="title">SocialRegistrationService.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">interface</span> <span class="class">SocialRegistrationService</span> {

    <span class="predefined-type">String</span> NAME = <span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_SocialRegistrationService</span><span class="delimiter">&quot;</span></span>;

    User findOrRegisterUser(<span class="predefined-type">String</span> socialServiceId, <span class="predefined-type">String</span> login, <span class="predefined-type">String</span> name,
                            SocialService socialService);

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Its implementation is quite straightforward:</p>
</div>
<div class="listingblock">
<div class="title">SocialRegistrationServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SocialRegistrationServiceBean</span> <span class="directive">implements</span> SocialRegistrationService {

    <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Pattern</span> EMAIL_PATTERN = <span class="predefined-type">Pattern</span>.compile(<span class="string"><span class="delimiter">&quot;</span><span class="content">[^@]+@[^.]+</span><span class="char">\\</span><span class="content">..+</span><span class="delimiter">&quot;</span></span>);

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> DataManager dataManager;
    <span class="annotation">@Inject</span>
    <span class="directive">private</span> <span class="predefined-type">Configuration</span> configuration;

    <span class="annotation">@Override</span>
    <span class="directive">public</span> User findOrRegisterUser(<span class="predefined-type">String</span> socialServiceId, <span class="predefined-type">String</span> login, <span class="predefined-type">String</span> name,
                                   SocialService socialService) {
        User existingUser = findExistingUser(socialService, socialServiceId);
        <span class="keyword">if</span> (existingUser != <span class="predefined-constant">null</span>) {
            <span class="keyword">return</span> existingUser;
        }

        SocialUser user = createNewUser(socialServiceId, login, name, socialService);

        <span class="keyword">return</span> dataManager.commit(user);
    }

    <span class="annotation">@Nullable</span>
    <span class="directive">private</span> User findExistingUser(SocialService socialService, <span class="predefined-type">String</span> socialServiceId) {
        <span class="predefined-type">String</span> socialServiceField = getSocialIdParamName(socialService);

        <span class="keyword">return</span> dataManager.load(User.class)
                .query(<span class="string"><span class="delimiter">&quot;</span><span class="content">select u from sec$User u where </span><span class="delimiter">&quot;</span></span> +
                        <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">u.%s = :socialServiceId</span><span class="delimiter">&quot;</span></span>, socialServiceField))
                .parameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">socialServiceId</span><span class="delimiter">&quot;</span></span>, socialServiceId)
                .one();
    }

    <span class="directive">private</span> SocialUser createNewUser(<span class="predefined-type">String</span> socialServiceId, <span class="predefined-type">String</span> login,
                                     <span class="predefined-type">String</span> name, SocialService socialService) {
        SocialUser user = dataManager.create(SocialUser.class);

        user.setLogin(login);
        user.setName(name);
        user.setGroup(getDefaultGroup());
        user.setActive(<span class="predefined-constant">true</span>);

        <span class="keyword">if</span> (isEmail(login)) {
            user.setEmail(login);
        }

        <span class="keyword">switch</span> (socialService) {
            <span class="keyword">case</span> GOOGLE:
                user.setGoogleId(socialServiceId);
                <span class="keyword">break</span>;
            <span class="keyword">case</span> FACEBOOK:
                user.setFacebookId(socialServiceId);
                <span class="keyword">break</span>;
            <span class="keyword">case</span> GITHUB:
                user.setGithubId(socialServiceId);
                <span class="keyword">break</span>;
        }

        <span class="keyword">return</span> user;
    }

    <span class="directive">private</span> <span class="predefined-type">Group</span> getDefaultGroup() {
        SocialRegistrationConfig config = configuration.getConfig(SocialRegistrationConfig.class);

        <span class="keyword">return</span> dataManager.load(<span class="predefined-type">Group</span>.class)
                .query(<span class="string"><span class="delimiter">&quot;</span><span class="content">select g from sec$Group g where g.id = :defaultGroupId</span><span class="delimiter">&quot;</span></span>)
                .parameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">defaultGroupId</span><span class="delimiter">&quot;</span></span>, config.getDefaultGroupId())
                .one();
    }

    <span class="directive">private</span> <span class="predefined-type">String</span> getSocialIdParamName(SocialService socialService) {
        <span class="keyword">switch</span> (socialService) {
            <span class="keyword">case</span> GOOGLE:
                <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">googleId</span><span class="delimiter">&quot;</span></span>;
            <span class="keyword">case</span> FACEBOOK:
                <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">facebookId</span><span class="delimiter">&quot;</span></span>;
            <span class="keyword">case</span> GITHUB:
                <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">githubId</span><span class="delimiter">&quot;</span></span>;
        }
        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalArgumentException</span>(
                <span class="string"><span class="delimiter">&quot;</span><span class="content">No social id param found for service: </span><span class="delimiter">&quot;</span></span> + socialService);
    }

    <span class="directive">private</span> <span class="type">boolean</span> isEmail(<span class="predefined-type">String</span> s) {
        <span class="keyword">return</span> EMAIL_PATTERN.matcher(s).matches();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get back to <code>SocialLoginProvider</code> and use <code>SocialRegistrationService</code> to get the user:</p>
</div>
<div class="listingblock">
<div class="title">SocialLoginProvider</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>(SocialLoginProvider.NAME)
<span class="directive">public</span> <span class="type">class</span> <span class="class">SocialLoginProvider</span> <span class="directive">extends</span> ExternalUserLoginProvider <span class="directive">implements</span> LoginProvider {

    <span class="annotation">@Nullable</span>
    <span class="annotation">@Override</span>
    <span class="directive">public</span> AuthenticationDetails login(Credentials credentials) <span class="directive">throws</span> <span class="exception">LoginException</span> {
        SocialCredentials socialCredentials = (SocialCredentials) credentials;

        SocialLoginService.SocialUserData userData = socialCredentials.getUserData();

        User user = socialRegistrationService.findOrRegisterUser(
                userData.getId(),
                userData.getLogin(),
                userData.getName(),
                socialCredentials.getSocialService());

        <span class="predefined-type">Locale</span> defaultLocale = socialCredentials.getLocale();

        <span class="keyword">return</span> <span class="local-variable">super</span>.login(<span class="keyword">new</span> ExternalUserCredentials(user.getLogin(), defaultLocale));
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a><a class="link" href="#summary">Summary</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Anonymous access allows you to provide some publicly available functionality in your application, like dashboards, news, or feedback page. But in case when some features are available only for logged in users, social login is a convenient way to avoid filling a registration form. In this guide we’ve described how to support these use cases for CUBA based applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further_information"><a class="anchor" href="#further_information"></a><a class="link" href="#further_information">Further Information</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://doc.cuba-platform.com/manual-7.1/gui_anonymous_access.html">Anonymous Access reference documentation</a></p>
</li>
</ul>
</div>
</div>
</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <!-- Sidebar (right column) -->
            <div id="blog-sidebar">
                <div class="region region-sidebar ">
                    <section id="block-block-29" class="block block-block clearfix">

                        <div class="guide-panel">
                            <h3 class="header-table-content">Table of contents</h3>
                            <ul class="sectlevel1">
<li><a href="#what_will_be_built">What Will Be Built</a>
<ul class="sectlevel2">
<li><a href="#final_application">Final Application</a></li>
<li><a href="#requirements">Requirements</a></li>
</ul>
</li>
<li><a href="#example_cuba_petclinic">Example: CUBA petclinic</a></li>
<li><a href="#public_access">Public Access</a>
<ul class="sectlevel2">
<li><a href="#setting_up_anonymous_access">Setting up Anonymous Access</a></li>
<li><a href="#initial_screen">Initial Screen</a></li>
<li><a href="#anonymous_permissions">Anonymous Permissions</a></li>
<li><a href="#screen_routes">Screen Routes</a></li>
</ul>
</li>
<li><a href="#login_dialog">Login Dialog</a>
<ul class="sectlevel2">
<li><a href="#extended_main_screen">Extended Main Screen</a></li>
<li><a href="#login_dialog_2">Login Dialog</a></li>
</ul>
</li>
<li><a href="#social_login">Social Login</a>
<ul class="sectlevel2">
<li><a href="#oauth_web_flow">OAuth Web Flow</a></li>
<li><a href="#social_buttons">Social Buttons</a></li>
<li><a href="#preliminary_preparation">Preliminary Preparation</a></li>
<li><a href="#social_services_configuration">Social Services Configuration</a></li>
<li><a href="#getting_an_auth_code">Getting an Auth Code</a></li>
<li><a href="#handling_social_service_response">Handling Social Service Response</a></li>
<li><a href="#exchanging_an_auth_code_for_access_token">Exchanging an Auth Code for Access Token</a></li>
</ul>
</li>
<li><a href="#auto_registration">Auto-Registration</a>
<ul class="sectlevel2">
<li><a href="#fetching_user_data">Fetching User Data</a></li>
<li><a href="#social_credentials">Social Credentials</a></li>
<li><a href="#login_provider">Login Provider</a></li>
<li><a href="#user_registration">User Registration</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#further_information">Further Information</a></li>
</ul>
                        </div>

                        <div class="sidebar-razd"></div>
                        <div class="guide-panel download">
                            <a href="https://github.com/cuba-guides/cuba-petclinic-social-login" class="github-link" target="_blank">Example code on Github</a>
                        </div>
                        <div class="guide-panel cuba-version">Supported versions: CUBA 7.1+; Java 8+</div>

                    </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer fragment="14269c1b298" class="footer">
    <div class="container footer_container">
        <div class="footer_columns">
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Framework</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/framework/">Framework</a></li>
                        <li><a href="/tools/">Tools</a></li>
                        <li><a href="/marketplace/">Addons</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Learn</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/learn/quickstart/">Quick Start</a></li>
                        <li><a href="/learn/live-demo/">Live Demo</a></li>
                        <li><a href="/guides/">Guides</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Documentation</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/documentation/">Documentation</a></li>
                        <li><a href="/api-reference/">API References</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Community</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/discuss/">Forum</a></li>
                        <li><a href="/blog/">Blog</a></li>
                        <li><a href="/contacts/">Contacts</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer_bottom">
            <div class="footer_copyright">
                Developed and sponsored by Haulmont
                <a href="https://www.cuba-platform.com/terms-of-use/" class="footer_terms">Terms of Use</a></div>
            <ul class="social footer_social">
                <li class="social_item">
                    <a href="https://github.com/cuba-platform/cuba" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -github social_icon">
                        <path d="M3.047 3.188C5.109 1.062 7.594 0 10.5 0c2.906 0 5.383 1.055 7.43 3.164C19.977 5.274 21 7.812 21 10.781c0 2.344-.672 4.453-2.016 6.328-1.343 1.875-3.062 3.172-5.156 3.891h-.187c-.375 0-.563-.187-.563-.563l.024-1.054c.015-.672.023-1.29.023-1.852 0-.906-.25-1.578-.75-2.015 1.438-.188 2.602-.649 3.492-1.383.89-.735 1.336-2.04 1.336-3.914 0-1.125-.36-2.094-1.078-2.906.313-.907.281-1.86-.094-2.86h-.234c-.719 0-1.61.375-2.672 1.125a9.858 9.858 0 0 0-2.625-.375c-.844 0-1.719.125-2.625.375-1.063-.75-1.953-1.125-2.672-1.125H4.97c-.375 1-.407 1.953-.094 2.86-.719.812-1.078 1.78-1.078 2.906 0 1.875.437 3.18 1.312 3.914s2.032 1.195 3.47 1.383c-.345.343-.563.828-.657 1.453a2.687 2.687 0 0 1-1.219.281c-.781 0-1.39-.39-1.828-1.172-.406-.687-.953-1.062-1.64-1.125-.657 0-.673.219-.047.656.468.25.859.782 1.171 1.594.032.125.094.274.188.445.094.172.351.399.773.68.422.281.93.422 1.524.422.437 0 .781-.031 1.031-.094v1.828c0 .344-.172.516-.516.516h-.187c-2.125-.719-3.852-2.008-5.18-3.867C.664 15.273 0 13.156 0 10.78c0-2.969 1.016-5.5 3.047-7.594z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://www.linkedin.com/company/cuba-platform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -linkedin social_icon">
                        <path d="M19.305 0c.474 0 .875.155 1.203.465.328.31.492.702.492 1.176v17.554c0 .474-.164.894-.492 1.258-.328.365-.73.547-1.203.547h-17.5c-.474 0-.894-.182-1.258-.547C.182 20.09 0 19.67 0 19.195V1.641C0 1.167.173.775.52.465.866.155 1.294 0 1.805 0h17.5zM6.775 17.613V8.129h-2.71v9.484h2.71zM4.431 6.407c.245.245.566.367.964.367s.728-.13.988-.39.39-.574.39-.942c0-.398-.122-.727-.367-.987s-.567-.39-.965-.39-.727.13-.987.39-.39.59-.39.987c0 .368.122.69.367.965zm13.18 11.206v-5.42c0-1.336-.305-2.348-.916-3.034-.612-.687-1.407-1.03-2.386-1.03-1.048 0-1.922.506-2.62 1.517v-1.3H8.806v9.267h2.884v-5.257c0-.361.034-.614.104-.759.28-.722.77-1.083 1.468-1.083.979 0 1.468.668 1.468 2.005v5.094h2.883z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://www.facebook.com/CUBAplatform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -facebook social_icon">
                        <path d="M17.063 0A3.939 3.939 0 0 1 21 3.938v13.124A3.939 3.939 0 0 1 17.062 21h-2.57v-8.135h2.72l.411-3.172h-3.13V7.67c0-.916.245-1.531 1.571-1.531l1.668-.014v-2.83c-.287-.041-1.285-.123-2.433-.123-2.42 0-4.088 1.476-4.088 4.183v2.338H8.477v3.172h2.734V21H3.937A3.939 3.939 0 0 1 0 17.062V3.938A3.939 3.939 0 0 1 3.938 0h13.124z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://twitter.com/CubaPlatform" target="_blank" class="social_link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon -twitter social_icon">
                            <path d="M17.5 6.59a6.058 6.058 0 0 1-1.654.465 2.903 2.903 0 0 0 1.271-1.6 5.717 5.717 0 0 1-1.832.697 2.847 2.847 0 0 0-2.092-.902 2.87 2.87 0 0 0-2.87 2.871c0 .219.013.451.068.656A8.158 8.158 0 0 1 4.457 5.77c-.246.423-.396.93-.396 1.449 0 .998.464 1.873 1.244 2.392-.479-.013-.93-.15-1.367-.355v.027c0 1.395 1.052 2.557 2.365 2.817-.246.068-.438.109-.698.109-.177 0-.355-.027-.533-.055a2.889 2.889 0 0 0 2.68 1.996A5.782 5.782 0 0 1 3.5 15.34a8.183 8.183 0 0 0 4.402 1.285c5.278 0 8.176-4.375 8.176-8.176 0-.123 0-.246-.014-.369A5.521 5.521 0 0 0 17.5 6.59zM21 3.938v13.124A3.939 3.939 0 0 1 17.062 21H3.938A3.939 3.939 0 0 1 0 17.062V3.938A3.939 3.939 0 0 1 3.938 0h13.124A3.939 3.939 0 0 1 21 3.938z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </a>
                </li>
                <li class="social_item">
                    <a href="https://www.youtube.com/c/CubaPlatform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -youtube social_icon">
                        <path d="M27.836 4.648c.11 1.97.164 3.92.164 5.852 0 1.932-.055 3.883-.164 5.852 0 1.24-.392 2.287-1.176 3.144-.784.857-1.74 1.285-2.87 1.285-2.808.146-6.071.219-9.79.219-3.719 0-6.982-.073-9.79-.219-1.13 0-2.086-.428-2.87-1.285C.556 18.64.164 17.591.164 16.352.054 14.382 0 12.432 0 10.5c0-1.276.073-3.227.219-5.852 0-1.24.383-2.287 1.148-3.144C2.133.647 3.081.219 4.211.219 6.872.073 9.97 0 13.508 0h.984c3.537 0 6.636.073 9.297.219 1.13 0 2.087.428 2.871 1.285.784.857 1.176 1.905 1.176 3.144zM11.32 15.86l7.93-5.359-7.93-5.414v10.773z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="/rss.xml" class="social_link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon -rss social_icon">
                            <path d="M.857 15.91C1.464 15.305 2.18 15 3 15c.821 0 1.527.295 2.116.884.59.59.884 1.295.884 2.116 0 .821-.295 1.527-.884 2.116-.59.59-1.295.884-2.116.884-.821 0-1.527-.295-2.116-.884C.294 19.526 0 18.821 0 18c0-.821.286-1.518.857-2.09zM0 7c3.828 0 7.118 1.376 9.871 4.129C12.624 13.882 14 17.172 14 21H9.625c0-2.917-.875-5.25-2.625-7s-4.083-2.625-7-2.625V7zm0-7c5.797 0 10.746 2.05 14.848 6.152C18.949 10.254 21 15.203 21 21h-4.375c0-4.667-1.604-8.604-4.813-11.813C8.604 5.98 4.668 4.375 0 4.375V0z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</footer>
<!--<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/83f852ef4b5c91802566.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/d3a40ea16eeb2e16777d.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/9bd7e05c04e06e762b47.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/70ff0a2e2f971caf4892.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/cf082d0abe0e606c10b9.js" defer></script>-->
<style>
    [class*="column"] + [class*="column"]:last-child {
        float: none;
    }
</style>


<!-- BEGIN FOOTER -->
<!--<footer id="footer">
    <div class="footer-wrapper cuba-container">
        <div class="region region-footer-sitemap">
            <section id="block-footer-sitemap-footer-sitemap" class="block block-footer-sitemap clearfix">
                <div id="footer-sitemap" class="clearfix">
                    <div class="fs-block-content">
                        <div class="menu-footer-sitemap">
                            <ul class="footer_links_menu-footer-sitemap total-items-5 parent-items-0 single-items-0">
                                <li class="menu-1466 depth-1 total-children-4 parent-children-0 single-children-4  first">
                                    <a href="/framework" class="fs-root-link">Platform</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-4 parent-items-0 single-items-0">
                                        <li class="menu-2770 depth-2 fs-no-children  first"><a href="/framework">The Framework</a></li>
                                        <li class="menu-1473 depth-2 fs-no-children"><a href="/development-tools">Development Tools</a></li>
                                        <li class="menu-2838 depth-2 fs-no-children last"><a href="/marketplace">Marketplace</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1469 depth-1 total-children-7 parent-children-0 single-children-7">
                                    <a href="/online-demo" class="fs-root-link">Learn</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-7 parent-items-0 single-items-0">
                                        <li class="menu-1479 depth-2 fs-no-children first"><a href="/online-demo">Online demo</a></li>
                                        <li class="menu-1477 depth-2 fs-no-children"><a href="/quickstart">Quick start</a></li>
                                        <li class="menu-1478 depth-2 fs-no-children"><a href="/documentation">Documentation</a></li>
                                        <li class="menu-1731 depth-2 fs-no-children"><a href="/guides">Guides</a></li>
                                        <li class="menu-1773 depth-2 fs-no-children"><a href="/webinars">Webinars</a></li>
                                        <li class="menu-1602 depth-2 fs-no-children last"><a href="/faq">FAQ</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1603 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="https://www.cuba-platform.com/discuss/" class="fs-root-link">Community</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1604 depth-2 fs-no-children first"><a href="https://www.cuba-platform.com/discuss/">Forum</a></li>
                                        <li class="menu-1692 depth-2 fs-no-children"><a href="/testimonials">Customer stories</a></li>
                                        <li class="menu-1615 depth-2 fs-no-children last"><a href="/blog">Blog</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1663 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="/training" class="fs-root-link">Services</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1756 depth-2 fs-no-children first"><a href="/training">Training</a></li>
                                        <li class="menu-1757 depth-2 fs-no-children"><a href="/support-options">Support</a></li>
                                        <li class="menu-1758 depth-2 fs-no-children last"><a href="/deployment">Development</a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="menu-1612 depth-1 total-children-3 parent-children-0 single-children-3  last">
                                    <a href="/download" class="fs-root-link">More</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-2773 depth-2 fs-no-children first"><a href="/download">Download</a></li>
                                        <li class="menu-2775 depth-2 fs-no-children"><a href="/store">Store</a></li>
                                        <li class="menu-1480 depth-2 fs-no-children last"><a href="/contacts">Contacts</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </section>
        </div>
        <div class="region region-footer-copyright">
            <section id="block-block-14" class="block block-block clearfix">
                <div class="footer-copyright">
                    <div class="copyright">Copyright &copy; 2008-2018 Haulmont</div>
                    <div class="licences"><a href="/terms-of-use">Terms of Use</a></div>
                    <div class="socials">
                        <ul>
                            <li><a href="https://github.com/cuba-platform/cuba" class="socials-icon github"></a></li>
                            <li><a href="https://www.youtube.com/c/CubaPlatform" class="socials-icon youtube"></a></li>
                            <li><a href="https://www.facebook.com/CUBAplatform" class="socials-icon facebook"></a></li>
                            <li><a href="https://twitter.com/CubaPlatform" class="socials-icon twitter"></a></li>
                            <li><a href="https://www.linkedin.com/company/cuba-platform" class="socials-icon linkedin"></a></li>
                            <li><a href="https://www.cuba-platform.com/rss.xml" class="socials-icon rss"></a></li>
                        </ul>
                    </div>
                </div>
                <script async defer src="https://buttons.github.io/buttons.js"></script>
            </section>
        </div>
    </div>
</footer>-->
<!-- END FOOTER -->
<div class="scrollTop"></div>
</section>

<script src="/guides/js/foundation.min.js"></script>
<script src="https://unpkg.com/isotope-layout@3.0/dist/isotope.pkgd.js"></script>
<script src="/guides/js/vendor/modernizr.js"></script>
<script src="/guides/js/toc.js"></script>
<script src="/guides/js/navigation.js"></script>
<script src="/guides/js/navbar.js"></script>
<script src="/guides/js/extra.js"></script>
<script src="/guides/js/extra2.js"></script>
<script src="/guides/js/cuba-new.js"></script>
<script>
(function ($) {
  $(document).foundation();
  var doc = document.documentElement;
  doc.setAttribute('data-useragent', navigator.userAgent)

  /* Issue #24 */
  $(".blog .content img").each(function() {
    var imgMarkup = $(this)[0].outerHTML;
    console.log(imgMarkup);
    $(this).replaceWith('<div class="img-center">' + imgMarkup + '</div>');
  });

})(jQuery);

// Cache selectors
var lastId,
    topMenu = $(".sectlevel1"),
    topMenuHeight = topMenu.outerHeight()+1,

    // All list items
    menuItems = topMenu.find("a"),
    // Anchors corresponding to menu items
    scrollItems = menuItems.map(function(){
        var item = $($(this).attr("href"));
        if (item.length) { return item; }
    });
console.log(topMenuHeight );
menuItems.click(function(e){
    var href = $(this).attr("href"),
        offsetTop = href === "#" ? 0 : $(href).offset().top - 85;
    $('html, body').stop().animate({
        scrollTop: offsetTop
    }, 850);
    e.preventDefault();
    window.location =  href;
});

$( document ).ready(function() {
    const hash = location.hash.replace('#','');
    if(hash !== ''){
        $('html, body').stop().animate({ scrollTop: $('a[href=#' + hash + ']').offset().top - 85}, 850);
    }
});

// Bind to scroll
$(window).scroll(function(){
    // Get container scroll position
    var fromTop = $(this).scrollTop()+topMenuHeight;

    // Get id of current scroll item
    var cur = scrollItems.map(function(){
        if ($(this).offset().top < fromTop)
            return this;
    });
    // Get the id of the current element
    cur = cur[cur.length-1];
    var id = cur && cur.length ? cur[0].id : "";

    if (lastId !== id) {
        lastId = id;
        // Set/remove active class
        menuItems
            .parent().removeClass("active")
            .end().filter("[href=#"+id+"]").parent().addClass("active");
    }
});

</script>
</body>
</html>
