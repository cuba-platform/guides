<!doctype html>
<!--[if IE 9]>
<html class="lt-ie10" lang="en"> <![endif]-->
<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middleware Testing in CUBA applications</title>
    <meta name="description" content="The CUBA Platform guides cover different aspects of the CUBA Platform and give you advice on how to work with CUBA Platform by giving you concrete examples.">
    <meta name="author" content="Haulmont">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@CubaPlatform">
    <meta name="twitter:creator" content="@CubaPlatform">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Middleware Testing in CUBA applications">
    <meta property="og:description" content="In this guide you will learn how automated testing in a CUBA application works. In particular this guide deals with middleware layer of a CUBA application and how tests can be executed there.">
    <meta property="og:url" content="https://www.cuba-platform.com/guides/testing-middleware">
    <meta property="og:image" content="">

    <link rel="shortcut icon" href="/guides/images/favicon.png" type="image/png" />
    <link rel="stylesheet" href="/guides/css/foundation.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.css">
    <link rel="stylesheet" href="/guides/css/coderay.css">
    <link rel="stylesheet" href="/guides/css/bootstrap.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/reset.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/animate.css">
    <link rel="stylesheet" href="/guides/css/extra.css">
    <link rel="stylesheet" href="/guides/css/extra2.css">
    <link rel="stylesheet" href="/guides/css/cuba-new.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.min.css">
    <link rel="stylesheet" href="/guides/css/guides.css">
    <script src="/guides/js/jquery_v2.1.min.js"></script>
    <link rel="stylesheet" href="/guides/css/main.css" />
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-962 node-type-blog-post i18n-en">

<section id="wrapper">
    
<header role="banner" fragment="14269c1b298" class="header">
    <nav class="header_nav">
        <input id="mobile-menu-open" type="checkbox" class="header_checkbox">
        <div class="container header_container">
            <div class="header_toggle">
                <label for="mobile-menu-open"
                       class="header_toggle-label toggle-label">
                    <span>CUBA.platform</span>
                </label>
            </div>
            <a href="/" class="header_logo nuxt-link-active"></a>
            <ul class="header_menu">
                <li class="header_menu_item"><a href="/framework/" class="header_menu_link">Framework</a></li>
                <li class="header_menu_item"><a href="/learn/" class="header_menu_link nuxt-link-active">Learn</a></li>
                <li class="header_menu_item"><a href="/documentation/" class="header_menu_link">Documentation</a></li>
                <li class="header_menu_item"><a href="/discuss/" class="header_menu_link">Forum</a></li>
                <li class="header_menu_item"><a href="/blog/" class="header_menu_link">Blog</a></li>
            </ul>
            <div class="header-support">
                <button class="header-support_toggle">
                <img src="images/users.svg" class="header-support_toggle_icon">
                <span class="header-support_toggle_text">Services</span></button>
                <div class="header-support_popup">
                    <div class="support-popup">
                        <div class="support-popup_services">
                            <h3 class="support-popup_services_title">Commercial services for your project</h3>
                            <ul class="services-list">
                                <li class="services-list_item"><a href="/support-options/"><strong
                                        class="services-list_title">Consultancy &amp; Support</strong>
                                    <div class="services-list_text">
                                        <div><p>Commercial consulting requests have a guaranteed response
                                            time.</p>
                                        </div>
                                    </div>
                                </a></li>
                                <li class="services-list_item"><a href="/development/"><strong
                                        class="services-list_title">Custom Development</strong>
                                    <div class="services-list_text">
                                        <div><p>We can deliver a turn key solution or contribute to your
                                            project</p>
                                        </div>
                                    </div>
                                </a></li>
                                <li class="services-list_item"><a href="/training/"><strong
                                        class="services-list_title">Training</strong>
                                    <div class="services-list_text">
                                        <div><p>For fast and deep dive into framework features to shift your
                                            team productivity.</p>
                                        </div>
                                    </div>
                                </a></li>
                            </ul>
                        </div>
                        <div class="support-popup_haulmont">
                            <div class="support-popup_haulmont_header"><h3 class="support-popup_haulmont_title">
                                Haulmont</h3>
                                <div class="support-popup_haulmont_subtitle">we develop modern enterprise
                                    solutions
                                </div>
                            </div>
                            <ul class="haulmont-list">
                                <li class="haulmont-list_item">
                                    <div><p>Experts in Enterprise software</p>
                                    </div>
                                </li>
                                <li class="haulmont-list_item">
                                    <div><p>Creators of the CUBA Platform</p>
                                    </div>
                                </li>
                                <li class="haulmont-list_item">
                                    <div><p>Established in 2008</p>
                                    </div>
                                </li>
                            </ul>
                            <ul class="numbers-list">
                                <li class="numbers-list_item"><strong class="numbers-list_number">300+</strong>
                                    <div class="numbers-list_text">developers</div>
                                </li>
                                <li class="numbers-list_item"><strong class="numbers-list_number">400+</strong>
                                    <div class="numbers-list_text">projects</div>
                                </li>
                                <li class="numbers-list_item">
                                    <div class="numbers-list_text">Customers in</div>
                                    <strong class="numbers-list_number">60+</strong>
                                    <div class="numbers-list_text">countries</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <a href="/user/" class="header_profile">
                <svg xmlns="http://www.w3.org/2000/svg" id="i-profile" class="icon header_profile_src" viewBox="0 0 563.43 563.43" width="100%" height="100%">
                    <path d="M280.79 314.559c83.266 0 150.803-67.538 150.803-150.803S364.055 13.415 280.79 13.415 129.987 80.953 129.987 163.756s67.537 150.803 150.803 150.803zm0-261.824c61.061 0 111.021 49.959 111.021 111.021s-49.96 111.02-111.021 111.02-111.021-49.959-111.021-111.021 49.959-111.02 111.021-111.02zM19.891 550.015h523.648c11.102 0 19.891-8.789 19.891-19.891 0-104.082-84.653-189.198-189.198-189.198H189.198C85.116 340.926 0 425.579 0 530.124c0 11.102 8.789 19.891 19.891 19.891zm169.307-169.307h185.034c75.864 0 138.313 56.436 148.028 129.524H41.17c9.714-72.625 72.164-129.524 148.028-129.524z"></path>
                </svg>
            </a>
        </div>
    </nav>
    <nav class="header-submenu">
        <div class="container header-submenu_container">
            <a href="/learn/quickstart/" class="header-submenu_link">Quick Start</a>
            <a href="/learn/live-demo/" class="header-submenu_link">Live Demo</a>
            <a href="/guides/" class="header-submenu_link nuxt-link-exact-active nuxt-link-active">Guides</a>
        </div>
    </nav>
</header>

<style>
    .upper-header .header-options {
        display: none;
    }

    .upper-header .upper-header-wrapper .header-menu div .nav > li:last-child > a {
        padding-right: 0;
    }
</style>


    <!-- Main Page Content and Sidebar -->
    <div class="content-wrapper">
        <div class="cuba-container text-node blog">



            <!-- Main content (left column) -->
            <div class="region region-content">



                <section id="block-system-main" class="block block-system clearfix">
                    <div id="node-962" class="article node node-blog-post node-promoted clearfix">
                        <div class="content">
                            <div class="field field-name-body field-type-text-with-summary field-label-hidden">
                                <div class="field-items">
                                    <div class="field-item even" property="content: encoded">
                                        <h1>Middleware Testing in CUBA applications</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Test automation is key to every successful application development effort since it gives a high positive return on investment for QA efforts. CUBA applications are build on the Java ecosystem, which has a very powerful and mature test automation capabilities. In this guide you will learn how to leverage those capabilities.</p>
</div>
<div class="paragraph">
<p>First you will understand how testing in general works in a CUBA application. Afterwards this guide will concentrate on the area of unit &amp; integration testing on the middleware layer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what_will_be_built"><a class="anchor" href="#what_will_be_built"></a><a class="link" href="#what_will_be_built">What Will be Built</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide enhances the <a href="https://github.com/cuba-platform/cuba-petclinic">CUBA Petclinic</a> example to show how existing features can be automatically tested:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>automatic creation of a Visit for a given Pet Identification Number</p>
</li>
<li>
<p>automatic "Disease Warning Mailing" for endangered pets</p>
</li>
<li>
<p>calculation of next regular checkup date proposals for a Pet</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="final_application"><a class="anchor" href="#final_application"></a><a class="link" href="#final_application">Final Application</a></h3>
<a href="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-reports/master/img/adjustments-cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-reports/master/img/login-screen.png"/></a>
</div>
<div class="sect2">
<h3 id="requirements"><a class="anchor" href="#requirements"></a><a class="link" href="#requirements">Requirements</a></h3>
<div class="paragraph">
<p>Your development environment requires to contain the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 1.8</a></p>
</li>
<li>
<p>a text editor or IDE (<a href="https://www.jetbrains.com/idea/download/">IntelliJ IDEA</a> preferred)</p>
</li>
<li>
<p><a href="https://www.cuba-platform.com/download">CUBA Studio</a> as standalone IDE or as an IDEA plugin (optional)</p>
</li>
<li>
<p><a href="https://github.com/cuba-platform/cuba-cli/wiki/Installation">CUBA CLI</a> (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware/archive/master.zip">Download</a> and unzip the source repository for this guide, or clone it using git:</p>
</div>
<div class="paragraph">
<p><code>git clone <a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware.git" class="bare">https://github.com/cuba-guides/cuba-petclinic-testing-middleware.git</a></code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example_cuba_petclinic"><a class="anchor" href="#example_cuba_petclinic"></a><a class="link" href="#example_cuba_petclinic">Example: CUBA petclinic</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The project that is the basis for this example is <a href="https://github.com/cuba-platform/cuba-petclinic">CUBA Petclinic</a>. It is based on the commonly known <a href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a>. The CUBA Petclinic application deals with the domain of a Pet clinic and the associated business workflows to manage a pet clinic.</p>
</div>
<div class="paragraph">
<p>The underlying domain model for the application looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/domain-model.png" alt="Domain model">
</div>
</div>
<div class="paragraph">
<p>The main entities are <strong>Pet</strong> and <strong>Visit</strong>. A Pet is visiting the petclinic and during this Visit a Vet is taking care of it. A Pet belongs to an Owner, which can hold multiple pets. The visit describes the act of a pet visiting the clinic with the help of its owner.</p>
</div>
<a href="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/login-screen.png"/></a>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a><a class="link" href="#overview">Overview</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Test automation is a commonly known best practice in the industry of software development since multiple decades. It allows to write a small test application, that executes a particular sub part of the production application and verifies its correct behavior.</p>
</div>
<div class="paragraph">
<p>In the Java ecosystem test automation has a long tradition. One famous example of this is the testing framework JUnit, which was one of the very first testing frameworks out in the market.</p>
</div>
<div class="paragraph">
<p>In a CUBA application, just like any other Java application, it is possible and recommended to write automated tests, that exercise parts of the target application.</p>
</div>
<div class="paragraph">
<p>In a test case (which is expressed as another Java class in a special test source directory) instances of production classes are instantiated and methods are executed. Afterwards the results are verified through programmatic comparison of an expected result against the actual result. Depending on this comparison, the test case is either treated as "success" or "failure".</p>
</div>
<div class="paragraph">
<p>A CUBA application is divided into two parts: the middleware part and the frontend part. The middleware consists of a combination of the <code>core</code> and the <code>global</code> module in the source code. It normally contains the majority of the business logic, integrations to other systems and the database related interactions.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This guide is only about testing the middleware part of a CUBA application, since for the frontend different patterns and testing strategies apply and therefore is covered in a dedicated guide.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test_environments"><a class="anchor" href="#test_environments"></a><a class="link" href="#test_environments">Test Environments</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Depending on how production code is executed in a test environment, this environment needs to fulfil certain criteria. E.g. if testing a production class that interacts with a database, this database has to be up and running in that environment and the production code needs to have a proper connection to it.</p>
</div>
<div class="paragraph">
<p>If on the other hand a business logic in the application like a sum building over a couple of order items is exercised in a test case the execution environment can be much simpler and does not need to have dependencies on other parts.</p>
</div>
<div class="paragraph">
<p>When it comes to the CUBA middleware both of those environment scenarios can be instantiated in order to execute test classes. The first variant with running dependencies like a database is normally referred to as an <code>Integration test</code>. For the scenario where the production class is instantiated without any surrounding environment support is called a <code>Unit test</code>.</p>
</div>
<div class="paragraph">
<p>In the next section you will learn about the differences of those two environment types. Afterwards those environments are put in place with testing the two scenarios for the petclinic application.</p>
</div>
<div class="sect2">
<h3 id="middleware_integration_testing"><a class="anchor" href="#middleware_integration_testing"></a><a class="link" href="#middleware_integration_testing">Middleware Integration Testing</a></h3>
<div class="paragraph">
<p>In this environment the production application is started partially. The integration test environment for a CUBA middleware is oftentimes the more common way of running a test case. This means that all the CUBA platform classes work the way you would expect them to work.</p>
</div>
<div class="paragraph">
<p>The <code>DataManager</code> interface for example, when invoking <code>dataManager.load(Customer.class).id(123).one()</code> will actually go against the database and fetch the customer with the ID 123. The same is true for the production code that was written in your application: <code>CustomerCreationService</code> will when interacting try to create a Customer in the database.</p>
</div>
<div class="paragraph">
<p>The integration testing environment has the following characteristics available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring application context</p>
</li>
<li>
<p>Connection to external database</p>
</li>
<li>
<p>Platform APIs work as in production codes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In order to make that environment available to the test case it take a couple of seconds to execute the test case.</p>
</div>
<div class="sect3">
<h4 id="database_connection"><a class="anchor" href="#database_connection"></a><a class="link" href="#database_connection">Database Connection</a></h4>
<div class="paragraph">
<p>CUBA uses the same database connection, that is established when running the production application. In the case of HSQLDB CUBA Studio takes care of having the database running when executing the test case.</p>
</div>
<div class="paragraph">
<p>By default the database instance is <code>shared</code> between the test environment and the situation when you run the application locally. This means that data that is defined locally when running the application is also available in the test case execution. Furthermore, if the test case changes data in the database, it is also changed the next time when you start the application.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Sharing data between the two environments is convenient and can often be helpful but also can cause some level of non-determinism. In case you are facing the situation of having problems expressing the correct assertions in the test case, because you cannot reliably determine how much / which data is in the database or you accidentally change data through the test case, it is also possible to split the databases of the two environments to avoid this behavior.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="test_container"><a class="anchor" href="#test_container"></a><a class="link" href="#test_container">Test Container</a></h4>
<div class="paragraph">
<p>The Test container is an object in the test case, that is mainly responsible for starting up and managing the integration test environment. It is supposed to be used in the test class as an object that when starting the test case will do various things to spin up the environment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>start the Spring application context</p>
</li>
<li>
<p>establishes a DB connection</p>
</li>
<li>
<p>instantiates all CUBA platform APIs</p>
</li>
<li>
<p>activates all application components and their configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An example usage of this Test Container looks like this:</p>
</div>
<div class="listingblock">
<div class="title">SampleIntegrationTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ExtendWith</span>(PetclinicTestContainer.Common.class) <i class="conum" data-value="1"></i><b>(1)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SampleIntegrationTest</span> {

    <span class="directive">public</span> <span class="directive">static</span> PetclinicTestContainer testContainer =
            PetclinicTestContainer.Common.INSTANCE; <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> persistenceAPI_canBeRetrieved_fromTheTestContainer() {

        Persistence persistence = testContainer.persistence(); <i class="conum" data-value="3"></i><b>(3)</b>

        assertNotNull(persistence);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the JUnit integration test uses the PetclinicTestContainer Extension</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the petclinic test container instance is added as a field in the test class</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>in the test cases the container can be used to interact with the test environment</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This guide uses JUnit as the testing library for examples. CUBA supports multiple testing frameworks like Spock, but by default it ships with JUnit.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="middleware_unit_testing"><a class="anchor" href="#middleware_unit_testing"></a><a class="link" href="#middleware_unit_testing">Middleware Unit Testing</a></h3>
<div class="paragraph">
<p>Besides the integration test environment it is also possible to create test cases, that do not spin up the Spring application context or any CUBA platform APIs at all. As for the above described use case, where there are no dependencies to the environment that should be leveraged in the test case, not having to start the environment is oftentimes beneficial.</p>
</div>
<div class="paragraph">
<p>The two main benefits of writing unit test in an isolated fashion without an integration test environment are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>locality of the test scenario</p>
</li>
<li>
<p>test execution speed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this case the class under test is instantiated directly. Since dependency injection is not working in this scenario potential dependencies (objects that the class under test relies upon) have to be instantiated manually and passed into the class under test directly. In case those dependencies are CUBA APIs, they normally have to be mocked. Mocking is a common way in test automation that helps to emulate / control certain external parts that the system under test interacts with in order to isolate the test subject as much as possible from its outside world.</p>
</div>
<div class="sect3">
<h4 id="mocking"><a class="anchor" href="#mocking"></a><a class="link" href="#mocking">Mocking</a></h4>

</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tests_for_petclinic_functionality"><a class="anchor" href="#tests_for_petclinic_functionality"></a><a class="link" href="#tests_for_petclinic_functionality">Tests for Petclinic Functionality</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the next section you will learn how to put all this theory into action by implementing unit / integration test cases, that verify the correct
behavior of features that have been introduced in the <a href="https://www.cuba-platform.com/guides/intro-working-with-data-in-cuba">Working with Data in CUBA</a> guide next to new functionality that you will learn about later.</p>
</div>
<div class="sect2">
<h3 id="automatic_visit_creation"><a class="anchor" href="#automatic_visit_creation"></a><a class="link" href="#automatic_visit_creation">Automatic Visit Creation</a></h3>
<div class="paragraph">
<p>The first test case is about the automatic visit creation functionality of the Petclinic application. In the Visit browse screen, the user
can create a new visit by entering the Pet Identification Number as a quick action. The software will go ahead and create a visit
for todays date for the entered Pet.</p>
</div>
<div class="paragraph">
<p>Part of the implementation of the feature is a CUBA service called <code>VisitService</code> that is triggered from the UI. It contains one method <code>Visit createVisitForToday(String identificationNumber)</code> that is the subject of the test case.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Although the feature includes a UI part, this will not be part of the automated testing. It is quite common to test certain sub parts of the implementation in isolation (as you will see). That being said, there is still a need for a real end-to-end test case to verify all the parts work together correctly. But this is out of scope for this guide.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Before looking into the concrete test case, here is a recap of what the <code>VisitService</code> is doing in the implementation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>it looks up the Pet by the given Identification Number</p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>in case the Pet is found it will use it</p>
</li>
<li>
<p>in case no Pet is found, it will not create a Visit</p>
</li>
</ol>
</div>
</li>
<li>
<p>it creates a new instance of a Visit with the correct attributes</p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>it figures out the correct Pet and assigns it to the Visit</p>
</li>
<li>
<p>it uses <code>today</code> as the <code>visitDate</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>it stores the newly created Visit</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A general test case that exercises the implementation and verifies its behavior looks like this:</p>
</div>
<div class="listingblock">
<div class="title">VisitServiceTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VisitServiceTest</span> {
    <span class="comment">// ...</span>
    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> createVisitForToday_createsANewVisit_forTheCorrectPet() {
        <span class="comment">// given: verify DB contains one visit for Pikachu (precondition)</span>
        assertThat(db.countVisitsFor(pikachu))
            .isEqualTo(<span class="integer">1</span>);
        <span class="comment">// when: a new visit is created for Pikachus Identification Number</span>
        visit = visitService.createVisitForToday(
                pikachu.getIdentificationNumber()
        );
        <span class="comment">// then: DB contains two visits for Pikachu (verification)</span>
        assertThat(db.countVisitsFor(pikachu))
            .isEqualTo(<span class="integer">2</span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This test case already lays out the general pattern of how the most test cases in this guide are defined. The pattern is called <code>Arrange-Act-Assert</code>:</p>
</div>
<div class="paragraph">
<p>First there is a phase of test data setup or verification of test data (<code>Arrange</code>). This is necessary to ensure the test case has a stable set of test
data to start from. Next the implementation is exercised with the desired input parameters (<code>Act</code>). In the last phase, the verifications
are executed to see if the code changed the system in the desired ways (<code>Assert</code>).</p>
</div>
<div class="paragraph">
<p>Based on that description it is possible to identify a couple of test cases, that describe the above mentioned behavior:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>createVisitForToday_createsANewVisit_forTheCorrectPet</code> - verifies <code>1.a</code>, <code>2.a</code> and <code>3.</code></p>
</li>
<li>
<p><code>createVisitForToday_createsANewVisit_withTheCorrectVisitInformation</code> - verifies <code>1.a</code>, <code>2.b</code> and <code>3.</code></p>
</li>
<li>
<p><code>createVisitForToday_createsNoVisit_forAnIncorrectIdentificationNumber</code> - verifies <code>1.b</code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="test_class_setup"><a class="anchor" href="#test_class_setup"></a><a class="link" href="#test_class_setup">Test class setup</a></h4>
<div class="paragraph">
<p>For this test class</p>
</div>
<div class="listingblock">
<div class="title">VisitServiceTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ExtendWith</span>(PetclinicTestContainer.Common.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VisitServiceTest</span> {


  <span class="directive">public</span> <span class="directive">static</span> PetclinicTestContainer testContainer = PetclinicTestContainer.Common.INSTANCE;

  <span class="directive">private</span> <span class="directive">static</span> TimeSource timeSource;
  <span class="directive">private</span> <span class="directive">static</span> VisitService visitService;

  <span class="directive">private</span> <span class="directive">static</span> PetclinicVisitDb db;

  <span class="directive">private</span> Visit visit;
  <span class="directive">private</span> Pet pikachu;

  <span class="annotation">@BeforeAll</span>
  <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> setupEnvironment() {
    visitService = AppBeans.get(VisitService.class);

    timeSource = AppBeans.get(TimeSource.class);

    db = <span class="keyword">new</span> PetclinicVisitDb(
        AppBeans.get(DataManager.class),
        testContainer
    );
  }

  <span class="annotation">@BeforeEach</span>
  <span class="directive">public</span> <span class="type">void</span> loadPikachu() {
    pikachu = db.petWithName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Pikachu</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">pet-with-owner-and-type</span><span class="delimiter">&quot;</span></span>);
  }

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> createVisitForToday_createsANewVisit_forTheCorrectPet() {

    <span class="comment">// given:</span>
    assertThat(db.countVisitsFor(pikachu)).isEqualTo(<span class="integer">1</span>);

    <span class="comment">// when:</span>
    visit = visitService.createVisitForToday(pikachu.getIdentificationNumber());

    <span class="comment">// then:</span>
    assertThat(db.countVisitsFor(pikachu)).isEqualTo(<span class="integer">2</span>);
  }

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> createVisitForToday_createsANewVisit_withTheCorrectVisitInformation() {

    <span class="comment">// given:</span>
    assertThat(db.countVisitsFor(pikachu)).isEqualTo(<span class="integer">1</span>);

    <span class="comment">// when:</span>
    visit = visitService.createVisitForToday(pikachu.getIdentificationNumber());

    <span class="comment">// then:</span>
    assertThat(visit.getPet())
        .isEqualTo(pikachu);

    <span class="comment">// and:</span>
    assertThat(visit.getVisitDate())
        .isInSameDayAs(timeSource.currentTimestamp());

  }

  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> createVisitForToday_createsNoVisit_forAnIncorrectIdentificationNumber() {

    <span class="comment">// given:</span>
    <span class="predefined-type">String</span> incorrectIdentificationNumber = <span class="string"><span class="delimiter">&quot;</span><span class="content">IncorrectIdentificationNumber</span><span class="delimiter">&quot;</span></span>;

    assertThat(db.petWithIdentificationNumber(incorrectIdentificationNumber))
        .isNotPresent();

    <span class="comment">// and:</span>
    <span class="predefined-type">Long</span> amountOfVisitsBefore = db.countVisits();

    <span class="comment">// when:</span>
    visit = visitService.createVisitForToday(incorrectIdentificationNumber);

    <span class="comment">// then:</span>
    assertThat(visit)
        .isNull();

    <span class="comment">// and:</span>
    assertThat(db.countVisits())
        .isEqualTo(amountOfVisitsBefore);
  }

  <span class="annotation">@AfterEach</span>
  <span class="directive">public</span> <span class="type">void</span> cleanupVisit() {
    db.remove(visit);
  }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the JUnit integration test uses the PetclinicTestContainer Extension</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the petclinic test container instance is added as a field in the test class</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>in the test cases the container can be used to interact with the test environment</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="disease_warning_mailing"><a class="anchor" href="#disease_warning_mailing"></a><a class="link" href="#disease_warning_mailing">Disease Warning Mailing</a></h3>

</div>
<div class="sect2">
<h3 id="next_regular_checkup_date_proposal"><a class="anchor" href="#next_regular_checkup_date_proposal"></a><a class="link" href="#next_regular_checkup_date_proposal">Next Regular Checkup Date Proposal</a></h3>

</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a><a class="link" href="#summary">Summary</a></h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="further_information"><a class="anchor" href="#further_information"></a><a class="link" href="#further_information">Further Information</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://doc.cuba-platform.com/reporting-7.0/index.html">CUBA docs: Reporting</a></p>
</li>
<li>
<p><a href="https://doc.cuba-platform.com/reporting-7.1/open_office.html">CUBA docs: Reporting - Appendix A: Installing and Configuring OpenOffice</a></p>
</li>
</ul>
</div>
</div>
</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <!-- Sidebar (right column) -->
            <div id="blog-sidebar">
                <div class="region region-sidebar ">
                    <section id="block-block-29" class="block block-block clearfix">

                        <div class="guide-panel">
                            <h3 class="header-table-content">Table of contents</h3>
                            <ul class="sectlevel1">
<li><a href="#what_will_be_built">What Will be Built</a>
<ul class="sectlevel2">
<li><a href="#final_application">Final Application</a></li>
<li><a href="#requirements">Requirements</a></li>
</ul>
</li>
<li><a href="#example_cuba_petclinic">Example: CUBA petclinic</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#test_environments">Test Environments</a>
<ul class="sectlevel2">
<li><a href="#middleware_integration_testing">Middleware Integration Testing</a></li>
<li><a href="#middleware_unit_testing">Middleware Unit Testing</a></li>
</ul>
</li>
<li><a href="#tests_for_petclinic_functionality">Tests for Petclinic Functionality</a>
<ul class="sectlevel2">
<li><a href="#automatic_visit_creation">Automatic Visit Creation</a></li>
<li><a href="#disease_warning_mailing">Disease Warning Mailing</a></li>
<li><a href="#next_regular_checkup_date_proposal">Next Regular Checkup Date Proposal</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#further_information">Further Information</a></li>
</ul>
                        </div>

                        <div class="sidebar-razd"></div>
                        <div class="guide-panel download">
                            <a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware" class="github-link" target="_blank">Example code on Github</a>
                        </div>
                        <div class="guide-panel cuba-version">Supported versions: CUBA 7.0+; Java 8+</div>

                    </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer fragment="14269c1b298" class="footer">
    <div class="container footer_container">
        <div class="footer_columns">
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Framework</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/framework/">Framework</a></li>
                        <li><a href="/tools/">Tools</a></li>
                        <li><a href="/marketplace/">Addons</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Learn</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/learn/quickstart/">Quick Start</a></li>
                        <li><a href="/learn/live-demo/">Live Demo</a></li>
                        <li><a href="/guides/">Guides</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Documentation</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/documentation/">Documentation</a></li>
                        <li><a href="/api-reference/">API References</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Community</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/discuss/">Forum</a></li>
                        <li><a href="/blog/">Blog</a></li>
                        <li><a href="/contacts/">Contacts</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer_bottom">
            <div class="footer_copyright">
                Developed and sponsored by Haulmont
                <a href="/learn/videos/#" class="footer_terms">Terms of Use</a></div>
            <ul class="social footer_social">
                <li class="social_item">
                    <a href="https://github.com/cuba-platform/cuba" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -github social_icon">
                        <path d="M3.047 3.188C5.109 1.062 7.594 0 10.5 0c2.906 0 5.383 1.055 7.43 3.164C19.977 5.274 21 7.812 21 10.781c0 2.344-.672 4.453-2.016 6.328-1.343 1.875-3.062 3.172-5.156 3.891h-.187c-.375 0-.563-.187-.563-.563l.024-1.054c.015-.672.023-1.29.023-1.852 0-.906-.25-1.578-.75-2.015 1.438-.188 2.602-.649 3.492-1.383.89-.735 1.336-2.04 1.336-3.914 0-1.125-.36-2.094-1.078-2.906.313-.907.281-1.86-.094-2.86h-.234c-.719 0-1.61.375-2.672 1.125a9.858 9.858 0 0 0-2.625-.375c-.844 0-1.719.125-2.625.375-1.063-.75-1.953-1.125-2.672-1.125H4.97c-.375 1-.407 1.953-.094 2.86-.719.812-1.078 1.78-1.078 2.906 0 1.875.437 3.18 1.312 3.914s2.032 1.195 3.47 1.383c-.345.343-.563.828-.657 1.453a2.687 2.687 0 0 1-1.219.281c-.781 0-1.39-.39-1.828-1.172-.406-.687-.953-1.062-1.64-1.125-.657 0-.673.219-.047.656.468.25.859.782 1.171 1.594.032.125.094.274.188.445.094.172.351.399.773.68.422.281.93.422 1.524.422.437 0 .781-.031 1.031-.094v1.828c0 .344-.172.516-.516.516h-.187c-2.125-.719-3.852-2.008-5.18-3.867C.664 15.273 0 13.156 0 10.78c0-2.969 1.016-5.5 3.047-7.594z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://www.linkedin.com/company/cuba-platform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -linkedin social_icon">
                        <path d="M19.305 0c.474 0 .875.155 1.203.465.328.31.492.702.492 1.176v17.554c0 .474-.164.894-.492 1.258-.328.365-.73.547-1.203.547h-17.5c-.474 0-.894-.182-1.258-.547C.182 20.09 0 19.67 0 19.195V1.641C0 1.167.173.775.52.465.866.155 1.294 0 1.805 0h17.5zM6.775 17.613V8.129h-2.71v9.484h2.71zM4.431 6.407c.245.245.566.367.964.367s.728-.13.988-.39.39-.574.39-.942c0-.398-.122-.727-.367-.987s-.567-.39-.965-.39-.727.13-.987.39-.39.59-.39.987c0 .368.122.69.367.965zm13.18 11.206v-5.42c0-1.336-.305-2.348-.916-3.034-.612-.687-1.407-1.03-2.386-1.03-1.048 0-1.922.506-2.62 1.517v-1.3H8.806v9.267h2.884v-5.257c0-.361.034-.614.104-.759.28-.722.77-1.083 1.468-1.083.979 0 1.468.668 1.468 2.005v5.094h2.883z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://www.facebook.com/CUBAplatform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -facebook social_icon">
                        <path d="M17.063 0A3.939 3.939 0 0 1 21 3.938v13.124A3.939 3.939 0 0 1 17.062 21h-2.57v-8.135h2.72l.411-3.172h-3.13V7.67c0-.916.245-1.531 1.571-1.531l1.668-.014v-2.83c-.287-.041-1.285-.123-2.433-.123-2.42 0-4.088 1.476-4.088 4.183v2.338H8.477v3.172h2.734V21H3.937A3.939 3.939 0 0 1 0 17.062V3.938A3.939 3.939 0 0 1 3.938 0h13.124z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://twitter.com/CubaPlatform" target="_blank" class="social_link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon -twitter social_icon">
                            <path d="M17.5 6.59a6.058 6.058 0 0 1-1.654.465 2.903 2.903 0 0 0 1.271-1.6 5.717 5.717 0 0 1-1.832.697 2.847 2.847 0 0 0-2.092-.902 2.87 2.87 0 0 0-2.87 2.871c0 .219.013.451.068.656A8.158 8.158 0 0 1 4.457 5.77c-.246.423-.396.93-.396 1.449 0 .998.464 1.873 1.244 2.392-.479-.013-.93-.15-1.367-.355v.027c0 1.395 1.052 2.557 2.365 2.817-.246.068-.438.109-.698.109-.177 0-.355-.027-.533-.055a2.889 2.889 0 0 0 2.68 1.996A5.782 5.782 0 0 1 3.5 15.34a8.183 8.183 0 0 0 4.402 1.285c5.278 0 8.176-4.375 8.176-8.176 0-.123 0-.246-.014-.369A5.521 5.521 0 0 0 17.5 6.59zM21 3.938v13.124A3.939 3.939 0 0 1 17.062 21H3.938A3.939 3.939 0 0 1 0 17.062V3.938A3.939 3.939 0 0 1 3.938 0h13.124A3.939 3.939 0 0 1 21 3.938z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </a>
                </li>
                <li class="social_item">
                    <a href="https://www.youtube.com/c/CubaPlatform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -youtube social_icon">
                        <path d="M27.836 4.648c.11 1.97.164 3.92.164 5.852 0 1.932-.055 3.883-.164 5.852 0 1.24-.392 2.287-1.176 3.144-.784.857-1.74 1.285-2.87 1.285-2.808.146-6.071.219-9.79.219-3.719 0-6.982-.073-9.79-.219-1.13 0-2.086-.428-2.87-1.285C.556 18.64.164 17.591.164 16.352.054 14.382 0 12.432 0 10.5c0-1.276.073-3.227.219-5.852 0-1.24.383-2.287 1.148-3.144C2.133.647 3.081.219 4.211.219 6.872.073 9.97 0 13.508 0h.984c3.537 0 6.636.073 9.297.219 1.13 0 2.087.428 2.871 1.285.784.857 1.176 1.905 1.176 3.144zM11.32 15.86l7.93-5.359-7.93-5.414v10.773z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="/rss.xml" class="social_link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon -rss social_icon">
                            <path d="M.857 15.91C1.464 15.305 2.18 15 3 15c.821 0 1.527.295 2.116.884.59.59.884 1.295.884 2.116 0 .821-.295 1.527-.884 2.116-.59.59-1.295.884-2.116.884-.821 0-1.527-.295-2.116-.884C.294 19.526 0 18.821 0 18c0-.821.286-1.518.857-2.09zM0 7c3.828 0 7.118 1.376 9.871 4.129C12.624 13.882 14 17.172 14 21H9.625c0-2.917-.875-5.25-2.625-7s-4.083-2.625-7-2.625V7zm0-7c5.797 0 10.746 2.05 14.848 6.152C18.949 10.254 21 15.203 21 21h-4.375c0-4.667-1.604-8.604-4.813-11.813C8.604 5.98 4.668 4.375 0 4.375V0z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</footer>
<!--<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/83f852ef4b5c91802566.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/d3a40ea16eeb2e16777d.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/9bd7e05c04e06e762b47.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/70ff0a2e2f971caf4892.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/cf082d0abe0e606c10b9.js" defer></script>-->
<style>
    [class*="column"] + [class*="column"]:last-child {
        float: none;
    }
</style>


<!-- BEGIN FOOTER -->
<!--<footer id="footer">
    <div class="footer-wrapper cuba-container">
        <div class="region region-footer-sitemap">
            <section id="block-footer-sitemap-footer-sitemap" class="block block-footer-sitemap clearfix">
                <div id="footer-sitemap" class="clearfix">
                    <div class="fs-block-content">
                        <div class="menu-footer-sitemap">
                            <ul class="footer_links_menu-footer-sitemap total-items-5 parent-items-0 single-items-0">
                                <li class="menu-1466 depth-1 total-children-4 parent-children-0 single-children-4  first">
                                    <a href="/framework" class="fs-root-link">Platform</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-4 parent-items-0 single-items-0">
                                        <li class="menu-2770 depth-2 fs-no-children  first"><a href="/framework">The Framework</a></li>
                                        <li class="menu-1473 depth-2 fs-no-children"><a href="/development-tools">Development Tools</a></li>
                                        <li class="menu-2838 depth-2 fs-no-children last"><a href="/marketplace">Marketplace</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1469 depth-1 total-children-7 parent-children-0 single-children-7">
                                    <a href="/online-demo" class="fs-root-link">Learn</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-7 parent-items-0 single-items-0">
                                        <li class="menu-1479 depth-2 fs-no-children first"><a href="/online-demo">Online demo</a></li>
                                        <li class="menu-1477 depth-2 fs-no-children"><a href="/quickstart">Quick start</a></li>
                                        <li class="menu-1478 depth-2 fs-no-children"><a href="/documentation">Documentation</a></li>
                                        <li class="menu-1731 depth-2 fs-no-children"><a href="/guides">Guides</a></li>
                                        <li class="menu-1773 depth-2 fs-no-children"><a href="/webinars">Webinars</a></li>
                                        <li class="menu-1602 depth-2 fs-no-children last"><a href="/faq">FAQ</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1603 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="https://www.cuba-platform.com/discuss/" class="fs-root-link">Community</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1604 depth-2 fs-no-children first"><a href="https://www.cuba-platform.com/discuss/">Forum</a></li>
                                        <li class="menu-1692 depth-2 fs-no-children"><a href="/testimonials">Customer stories</a></li>
                                        <li class="menu-1615 depth-2 fs-no-children last"><a href="/blog">Blog</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1663 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="/training" class="fs-root-link">Services</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1756 depth-2 fs-no-children first"><a href="/training">Training</a></li>
                                        <li class="menu-1757 depth-2 fs-no-children"><a href="/support-options">Support</a></li>
                                        <li class="menu-1758 depth-2 fs-no-children last"><a href="/deployment">Development</a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="menu-1612 depth-1 total-children-3 parent-children-0 single-children-3  last">
                                    <a href="/download" class="fs-root-link">More</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-2773 depth-2 fs-no-children first"><a href="/download">Download</a></li>
                                        <li class="menu-2775 depth-2 fs-no-children"><a href="/store">Store</a></li>
                                        <li class="menu-1480 depth-2 fs-no-children last"><a href="/contacts">Contacts</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </section>
        </div>
        <div class="region region-footer-copyright">
            <section id="block-block-14" class="block block-block clearfix">
                <div class="footer-copyright">
                    <div class="copyright">Copyright &copy; 2008-2018 Haulmont</div>
                    <div class="licences"><a href="/terms-of-use">Terms of Use</a></div>
                    <div class="socials">
                        <ul>
                            <li><a href="https://github.com/cuba-platform/cuba" class="socials-icon github"></a></li>
                            <li><a href="https://www.youtube.com/c/CubaPlatform" class="socials-icon youtube"></a></li>
                            <li><a href="https://www.facebook.com/CUBAplatform" class="socials-icon facebook"></a></li>
                            <li><a href="https://twitter.com/CubaPlatform" class="socials-icon twitter"></a></li>
                            <li><a href="https://www.linkedin.com/company/cuba-platform" class="socials-icon linkedin"></a></li>
                            <li><a href="https://www.cuba-platform.com/rss.xml" class="socials-icon rss"></a></li>
                        </ul>
                    </div>
                </div>
                <script async defer src="https://buttons.github.io/buttons.js"></script>
            </section>
        </div>
    </div>
</footer>-->
<!-- END FOOTER -->
<div class="scrollTop"></div>

</section>

<script src="/guides/js/foundation.min.js"></script>
<script src="https://unpkg.com/isotope-layout@3.0/dist/isotope.pkgd.js"></script>
<script src="/guides/js/vendor/modernizr.js"></script>
<script src="/guides/js/toc.js"></script>
<script src="/guides/js/navigation.js"></script>
<script src="/guides/js/navbar.js"></script>
<script src="/guides/js/extra.js"></script>
<script src="/guides/js/extra2.js"></script>
<script src="/guides/js/cuba-new.js"></script>
<script>
(function ($) {
  $(document).foundation();
  var doc = document.documentElement;
  doc.setAttribute('data-useragent', navigator.userAgent)

  /* Issue #24 */
  $(".blog .content img").each(function() {
    var imgMarkup = $(this)[0].outerHTML;
    console.log(imgMarkup);
    $(this).replaceWith('<div class="img-center">' + imgMarkup + '</div>');
  });

})(jQuery);

// Cache selectors
var lastId,
    topMenu = $(".sectlevel1"),
    topMenuHeight = topMenu.outerHeight()+1,

    // All list items
    menuItems = topMenu.find("a"),
    // Anchors corresponding to menu items
    scrollItems = menuItems.map(function(){
        var item = $($(this).attr("href"));
        if (item.length) { return item; }
    });
console.log(topMenuHeight );
menuItems.click(function(e){
    var href = $(this).attr("href"),
        offsetTop = href === "#" ? 0 : $(href).offset().top - 85;
    $('html, body').stop().animate({
        scrollTop: offsetTop
    }, 850);
    e.preventDefault();
    window.location =  href;
});

$( document ).ready(function() {
    const hash = location.hash.replace('#','');
    if(hash !== ''){
        $('html, body').stop().animate({ scrollTop: $('a[href=#' + hash + ']').offset().top - 85}, 850);
    }
});

// Bind to scroll
$(window).scroll(function(){
    // Get container scroll position
    var fromTop = $(this).scrollTop()+topMenuHeight;

    // Get id of current scroll item
    var cur = scrollItems.map(function(){
        if ($(this).offset().top < fromTop)
            return this;
    });
    // Get the id of the current element
    cur = cur[cur.length-1];
    var id = cur && cur.length ? cur[0].id : "";

    if (lastId !== id) {
        lastId = id;
        // Set/remove active class
        menuItems
            .parent().removeClass("active")
            .end().filter("[href=#"+id+"]").parent().addClass("active");
    }
});

</script>
</body>
</html>
