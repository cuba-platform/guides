<!doctype html>
<!--[if IE 9]>
<html class="lt-ie10" lang="en"> <![endif]-->
<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Decouple business logic with application events</title>
    <meta name="description" content="The CUBA Platform guides cover different aspects of the CUBA Platform and give you advice on how to work with CUBA Platform by giving you concrete examples.">
    <meta name="author" content="Haulmont">
    <link rel="stylesheet" href="/guides/css/foundation.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.css">
    <link rel="stylesheet" href="/guides/css/coderay.css">
    <link rel="stylesheet" href="/guides/css/bootstrap.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/reset.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/animate.css">
    <link rel="stylesheet" href="/guides/css/extra.css">
    <link rel="stylesheet" href="/guides/css/extra2.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.min.css">
    <link rel="stylesheet" href="/guides/css/guides.css">
    <script src="/guides/js/jquery_v2.1.min.js"></script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-962 node-type-blog-post i18n-en">

<section id="wrapper">
    <!-- BEGIN HEADER -->
<header id="header">
    <div class="upper-header">
        <div class="upper-header-wrapper cuba-container">
            <div class="header-logo">
                <a href="/"></a>
            </div>
            <div class="header-options"></div>
            <div class="header-menu" role="navigation">
                <div class="region region-nav-main">
                    <section id="block-menu-menu-nav" class="block block-menu clearfix">
                        <ul class="menu nav">
                            <li class="first expanded dropdown">
                                <a href="/framework" data-target="#" class="dropdown-toggle" data-toggle="dropdown">Platform <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                    <li class="first leaf"><a href="/framework">The Framework</a></li>
                                    <li class="leaf"><a href="/development-tools">Development Tools</a></li>
                                    <li class="leaf"><a href="/marketplace">Marketplace</a></li>
                                    <li class="last leaf"><a href="/license-pricing">License &amp; Pricing</a></li>
                                </ul>
                            </li>
                            <li class="leaf"><a href="/download">Download</a></li>
                            <li class="expanded active-trail active dropdown">
                                <a href="/online-demo" class="active-trail dropdown-toggle" data-target="#" data-toggle="dropdown">Learn <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                    <li class="first leaf"><a href="/online-demo">Online Demo</a></li>
                                    <li class="leaf"><a href="/quickstart">Quick Start</a></li>
                                    <li class="leaf"><a href="/tutorials">Tutorials</a></li>
                                    <li class="leaf"><a href="/sample-projects">Sample Projects</a></li>
                                    <li class="leaf"><a href="/webinars">Webinars</a></li>
                                    <li class="leaf"><a href="/documentation">Documentation</a></li>
                                    <li class="last leaf"><a href="/faq">FAQ</a></li>
                                </ul>
                            </li>
                            <li class="expanded dropdown">
                                <a href="https://www.cuba-platform.com/discuss/" data-target="#" class="dropdown-toggle" data-toggle="dropdown">
                                    Community
                                    <span class="caret"></span>
                                </a>
                                <ul class="dropdown-menu">
                                    <li class="first leaf"><a href="https://www.cuba-platform.com/discuss/">Forum</a></li>
                                    <li class="collapsed"><a href="/testimonials">Customer stories</a></li>
                                    <li class="last leaf"><a href="/blog">Blog</a></li>
                                </ul>
                            </li>
                            <li class="expanded dropdown">
                                <a href="/training" data-target="#" class="dropdown-toggle" data-toggle="dropdown">Services <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                    <li class="first leaf"><a href="/training">Training</a></li>
                                    <li class="leaf"><a href="/support-options">Support</a></li>
                                    <li class="last leaf"><a href="/development">Development</a></li>
                                </ul>
                            </li>
                            <li class="leaf"><a href="/store">Store</a></li>
                            <li class="last leaf"><a href="/contacts">Contacts</a></li>
                        </ul>
                    </section>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- BEGIN LOWER HEADER -->
<div class="lower-header std">
    <div class="submenu">
        <div class="submenu-title-wrapper">
            <div class="cuba-container">
                <div class="region region-lower-header-submenu">
                    <section id="block-menu-block-1" class="block block-menu-block clearfix">

                        <h2 class="block-title">Learn</h2>

                        <div class="menu-block-wrapper menu-block-1 menu-name-menu-nav parent-mlid-0 menu-level-2">
                            <ul class="menu nav">
                                <li class="first leaf menu-mlid-1329"><a href="/online-demo">Online Demo</a></li>
                                <li class="leaf menu-mlid-1327"><a href="/quickstart">Quick Start</a></li>
                                <li class="leaf menu-mlid-1328"><a href="/tutorials">Tutorials</a></li>
                                <li class="leaf menu-mlid-1730"><a href="/sample-projects">Sample Projects</a></li>
                                <li class="leaf"><a href="/webinars">Webinars</a></li>
                                <li class="leaf menu-mlid-1326"><a href="/documentation">Documentation</a></li>
                                <li class="last leaf menu-mlid-1591"><a href="/faq">FAQ</a></li>
                            </ul>
                        </div>

                    </section>
                </div>
            </div>
        </div>

        <!-- WILL BE SHOWN UPON CONDITION -->

        <!-- WILL BE SHOWN UPON CONDITION -->

    </div>
</div>

<style>
    .upper-header .header-options {
        display: none;
    }

    .upper-header .upper-header-wrapper .header-menu div .nav > li:last-child > a {
        padding-right: 0;
    }
</style>

    <!-- Main Page Content and Sidebar -->
    <div class="content-wrapper">
        <div class="cuba-container text-node blog">
            <!-- Main content (left column) -->
            <div class="region region-content">
                <section id="block-system-main" class="block block-system clearfix">
                    <div id="node-962" class="article node node-blog-post node-promoted clearfix">
                        <div class="content">
                            <div class="field field-name-body field-type-text-with-summary field-label-hidden">
                                <div class="field-items">
                                    <div class="field-item even" property="content: encoded">
                                        <h1>Decouple business logic with application events</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In CUBA 7 events are the predominant mechanism to react to different kinds of changes of the application. Furthermore, events are a common pattern within an application to decouple one part of the business logic from another. This guide gives an overview on how events can be used in a CUBA application and what the benefits are.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what_will_be_built"><a class="anchor" href="#what_will_be_built"></a><a class="link" href="#what_will_be_built">What will be built</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide enhances the <a href="https://github.com/cuba-platform/cuba-petclinic">CUBA petclinic</a> example to show different use cases of application events. In particular, the following use cases will be covered:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>generate a room keycode when a visit is going to be created</p>
</li>
<li>
<p>sending out room keycode for booked visits</p>
</li>
<li>
<p>kicking off payment process once a pet visit is marked as completed</p>
</li>
<li>
<p>refresh the visits list once a visit is marked as completed</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="final_application"><a class="anchor" href="#final_application"></a><a class="link" href="#final_application">Final Application</a></h3>
<a href="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-application-events/master/img/adjustments-cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-application-events/master/img/login-screen.png"/></a>
</div>
<div class="sect2">
<h3 id="requirements"><a class="anchor" href="#requirements"></a><a class="link" href="#requirements">Requirements</a></h3>
<div class="paragraph">
<p>Your development environment requires to contain the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.oracle.com/technetwork/java/javase/downloads/index.html">JDK 1.8</a></p>
</li>
<li>
<p>a text editor or IDE (<a href="https://www.jetbrains.com/idea/download/">IntelliJ IDEA</a> preferred)</p>
</li>
<li>
<p><a href="https://www.cuba-platform.com/download">CUBA Studio</a> (optional)</p>
</li>
<li>
<p><a href="https://github.com/cuba-platform/cuba-cli/wiki/Installation">CUBA CLI</a> (optional)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://github.com/cuba-guides/cuba-petclinic-intro-to-application-events/archive/master.zip">Download</a> and unzip the source repository for this guide, or clone it using git:</p>
</div>
<div class="paragraph">
<p><code>git clone <a href="https://github.com/cuba-guides/cuba-petclinic-intro-to-application-events.git" class="bare">https://github.com/cuba-guides/cuba-petclinic-intro-to-application-events.git</a></code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example_cuba_petclinic"><a class="anchor" href="#example_cuba_petclinic"></a><a class="link" href="#example_cuba_petclinic">Example: CUBA petclinic</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The project that is the basis for this example is <a href="https://github.com/cuba-platform/cuba-petclinic">CUBA Petclinic</a>. It is based on the commonly known <a href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a>. The CUBA Petclinic application deals with the domain of a Pet clinic and the associated business workflows to manage a pet clinic.</p>
</div>
<div class="paragraph">
<p>The underlying domain model for the application looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/domain-model2.png" alt="Domain model">
</div>
</div>
<div class="paragraph">
<p>The main entities are <strong>Pet</strong> and <strong>Visit</strong>. A Pet is visiting the petclinic and during this Visit a Vet is taking care of it. A Pet belongs to an Owner, which can hold multiple pets. The visit describes the act of a pet visiting the clinic with the help of its owner.</p>
</div>
<a href="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/login-screen.png"/></a>
</div>
</div>
<div class="sect1">
<h2 id="benefits_of_an_event_based_business_logic"><a class="anchor" href="#benefits_of_an_event_based_business_logic"></a><a class="link" href="#benefits_of_an_event_based_business_logic">Benefits of an event based business logic</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The most common approach of communicating across application logic is to do method invocation. In CUBA and Spring this is done via Java objects, Spring components &amp; CUBA services that interact with each other. There are good reasons to use this communication pattern, but it is not the only one. Method invocation is oftentimes overused which can lead to bad maintainability of the overall system due to highly coupled application parts.</p>
</div>
<div class="paragraph">
<p>Event-based business logic is an alternative communication pattern for application logic, that has particular strengths in its low coupling of the communication partcipants. It is not suitable for all kinds of communication styles, but for a big number of cases it is a viable alternative. Generally event based communication can be used in the following scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>notification style communication</p>
</li>
<li>
<p>communication that doesn&#8217;t necessarily need a back-channel</p>
</li>
<li>
<p>triggering between technical independent parts of application logic</p>
</li>
<li>
<p>situations where the user doesn&#8217;t need an immediate response</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As a result of using event based communication the parts of the application that are leveraging it will gain the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>low coupling from the event sender to the receiver</p>
</li>
<li>
<p>easy isolated testability of the sender and receiver</p>
</li>
<li>
<p>increased resiliency of the sender</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="available_types_of_events_in_a_cuba_application"><a class="anchor" href="#available_types_of_events_in_a_cuba_application"></a><a class="link" href="#available_types_of_events_in_a_cuba_application">Available types of events in a CUBA application</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are different kinds of application events within a CUBA application. The main categories are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>CUBA entity lifecycle events</p>
</li>
<li>
<p>CUBA application lifecycle events</p>
</li>
<li>
<p>CUBA UI events</p>
</li>
<li>
<p>custom application events</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="entity_changes_through_entitychangedevent"><a class="anchor" href="#entity_changes_through_entitychangedevent"></a><a class="link" href="#entity_changes_through_entitychangedevent">Entity changes through EntityChangedEvent</a></h3>
<div class="paragraph">
<p>In the petclinic example the following logic will be implemented: The petclinic has rooms for the stay of the pets during their time in the clinic. The rooms have no traditional keys or keycards, but instead have a 6 digit keycode to enter at the entrance door. This keycode has to be given to the pet&#8217;s owner once a new visit is booked. The transportation of the keycode should happen via SMS notification from the application.</p>
</div>
<div class="paragraph">
<p>This example is in the category of <em>Entity lifecycle events</em> because we want to execute logic, once a visit is booked (created). The <code>EntityChangedEvent</code> is sent out by the CUBA storage mechanism, once an Entity has been changed in the database.</p>
</div>
<div class="paragraph">
<p>CUBA fires such an Event for entities, that have an annotation <code>@PublishEntityChangedEvents</code> on the class definition. A <code>EntityChangedEvent</code> contains information about the type of change (create, update or delete) as well as the attributes which have been changed.</p>
</div>
<div class="paragraph">
<p>To register an Event listener for this event, a new Spring bean in the core module of the application has to be defined. In order to register to a specific kind of event, the method that should be called once an <code>EntityChangedEvent</code> has been sent has to be annotated with <code>@TransactionalEventListener</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There are two different kinds of annotations to register for as an event listener: <code>@TransactionalEventListener</code> and <code>@EventListener</code>. They differ regarding the transaction behavior. In this guide <code>@TransactionalEventListener</code> is used. More details can be found in the <a href="https://doc.cuba-platform.com/manual-7.0/events.html">CUBA documentation</a>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">RoomKeycodeToOwnerSender.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_roomKeycodeToOwnerSender</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">RoomKeycodeToOwnerSender</span> {

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> DataManager dataManager;

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> MobilePhoneNotificationGateway mobilePhoneNotificationGateway;

    <span class="annotation">@TransactionalEventListener</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="type">void</span> sendRoomKeycode(EntityChangedEvent&lt;Visit, <span class="predefined-type">UUID</span>&gt; event) { <i class="conum" data-value="2"></i><b>(2)</b>

        <span class="keyword">if</span> (event.getType().equals(EntityChangedEvent.Type.CREATED)) {
            Visit visit = loadVisit(event.getEntityId()); <i class="conum" data-value="3"></i><b>(3)</b>
            tryToSendRoomKeycodeToPetsOwner(visit);
        }
    }

    <span class="directive">private</span> <span class="type">void</span> tryToSendRoomKeycodeToPetsOwner(Visit visit) {


        <span class="keyword">if</span> (visit.getPet().getOwner() != <span class="predefined-constant">null</span>) {

            <span class="predefined-type">String</span> phoneNumber = visit.getPet().getOwner().getTelephone();

            <span class="keyword">if</span> (phoneNumber != <span class="predefined-constant">null</span>) {
                <span class="predefined-type">String</span> notificationText = createNotificationText(visit);

                mobilePhoneNotificationGateway.sendNotification(phoneNumber, notificationText);
            }
        }

    }


    <span class="comment">// ...</span>

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>registration of <code>sendRoomKeycode</code> as an event listener</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>scoping <code>EntityChangedEvent</code> only to Events which changed <code>Visit</code> entities</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>access to <code>Visit</code> identifier of the created instance</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With this definition of the Event listener the application will send out room keycodes to the owners of pets that have just registered in the petclinic.</p>
</div>
<div class="paragraph">
<p>There can be multiple event listeners defined for a given event. In this example it is also required not only to notify the Owner of the pet about the keycode, but also the system that is responsible for controlling the door hardware. It also needs additional information about the visit with the associated pet, to automatically adjust the height of the bed, display a welcome message on the room&#8217;s TV etc.</p>
</div>
<div class="paragraph">
<p>The following event listener will take over the responsibility to notify the room system.</p>
</div>
<div class="listingblock">
<div class="title">RoomSystemNotifier.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Component</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_roomSystemNotifier</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">RoomSystemNotifier</span> {

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> DataManager dataManager;

    <span class="annotation">@Inject</span>
    RoomSystemGateway roomSystemGateway;

    <span class="annotation">@TransactionalEventListener</span>
    <span class="directive">public</span> <span class="type">void</span> notifyRoomSystem(EntityChangedEvent&lt;Visit, <span class="predefined-type">UUID</span>&gt; event) {

        <span class="keyword">if</span> (event.getType().equals(EntityChangedEvent.Type.CREATED)) {
            Visit visit = loadVisit(event.getEntityId());
            tryToNotifyRoomSystemAboutVisit(visit);
        }
    }

    <span class="directive">private</span> <span class="type">void</span> tryToNotifyRoomSystemAboutVisit(Visit visit) {
        roomSystemGateway.informAboutVisit(visit);
    }

    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
When having multiple event listeners the invocation order oftentimes does not matter. In case it is necessary to execute one event listener before another Spring has the ability to define the order via the <code>@Order</code> annotation. See the <a href="https://doc.cuba-platform.com/manual-7.0/events.html">CUBA documentation</a> for further information on this topic.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="naming_conventions_of_events"><a class="anchor" href="#naming_conventions_of_events"></a><a class="link" href="#naming_conventions_of_events">Naming Conventions of events</a></h4>
<div class="paragraph">
<p>Events are normally named in simple past: "Entity <strong>Changed</strong> Event". This is a common pattern, because it stresses that an event is an immutable fact that happened in the past and is not changeable anymore. Event listeners on the other hand should be named in present tense.</p>
</div>
<div class="paragraph">
<p>Furthermore Event listeners are normally named regarding the one specific action that they should fulfill. Instead of creating a general <code>PetCreatedListener</code> that deals with all things that should happen once a pet is created in the system, Event listeners should be named regarding one specific action that should be performed: <code>RoomKeycodeToOwnerSender</code> &#8594; sends a room keycode to the pets owner.</p>
</div>
<div class="paragraph">
<p>This is an example of an application of the <a href="https://en.wikipedia.org/wiki/Open%E2%80%93closed_principle">open-closed principle</a>, which normally leads to more loosely coupled application parts and due to that to more maintainable software.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="custom_application_logic_events"><a class="anchor" href="#custom_application_logic_events"></a><a class="link" href="#custom_application_logic_events">Custom Application Logic events</a></h3>
<div class="paragraph">
<p>The next example is using custom application events to send messages between different parts of the application in a loosely coupled manner. When the pet is recovered and checked out the visit is marked as complete. When this event happens, certain downstream process can be kicked off as well. One of them, which this example deals with is that the invoicing process starts.</p>
</div>
<div class="paragraph">
<p>The first step towards custom application event is to define an event as a class <code>VisitCompletedEvent</code> in the <code>core</code> module:</p>
</div>
<div class="listingblock">
<div class="title">VisitCompletedEvent.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.haulmont.sample.petclinic.core.visit</span>;


<span class="directive">public</span> <span class="type">class</span> <span class="class">VisitCompletedEvent</span> <span class="directive">extends</span> ApplicationEvent { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">private</span> <span class="directive">final</span> Visit visit;

    <span class="directive">public</span> VisitCompletedEvent(<span class="predefined-type">Object</span> source, Visit visit) {

        <span class="local-variable">super</span>(source);

        <span class="local-variable">this</span>.visit = visit;
    }

    <span class="directive">public</span> Visit getVisit() {
        <span class="keyword">return</span> visit;
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Custom events have to extend <code>ApplicationEvent</code> in order to being passed through the event system of Spring</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next part is to send the event using the <code>Events</code> infrastructure of CUBA.</p>
</div>
<div class="listingblock">
<div class="title">VisitStatusServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.haulmont.sample.petclinic.service</span>;

<span class="keyword">import</span> <span class="include">com.haulmont.cuba.core.global.Events</span>;

<span class="comment">// ...</span>

<span class="annotation">@Service</span>(VisitStatusService.NAME)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VisitStatusServiceBean</span> <span class="directive">implements</span> VisitStatusService {

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> Events events; <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="comment">// ...</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> completeVisit(Visit visit) {

        <span class="keyword">if</span> (visit.getStatus().equals(VisitStatus.ACTIVE)) {
            markVisitAsComplete(visit);

            notifyAboutVisitCompletion(visit);

            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }

        <span class="comment">// ...</span>
    }

    <span class="directive">private</span> <span class="type">void</span> notifyAboutVisitCompletion(Visit visit) {
        events.publish(<span class="keyword">new</span> VisitCompletedEvent(<span class="local-variable">this</span>, visit)); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="directive">private</span> <span class="type">void</span> markVisitAsComplete(Visit visit) {
        visit.setStatus(VisitStatus.COMPLETED);
        dataManager.commit(visit);
        log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Visit {} marked as complete</span><span class="delimiter">&quot;</span></span>, visit);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Injecting CUBAs <code>Events</code> Spring bean</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Publishing a new <code>VisitCompletedEvent</code> once the visit&#8217;s status is updated</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The last remaining part does not differ compared to other events that are published by CUBA itself since the technical mechanisms are exactly the same.</p>
</div>
<div class="paragraph">
<p>The Event listener <code>InvoicingProcessInitializer</code> receives events of type <code>VisitCompletedEvent</code> and create an invoice for the received visit.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
There are two ways to listen to events. Above <code>@TransactionalEventListener</code> annotation is used. There is also a possibility to implement the Interface <code>ApplicationListener&lt;T&gt;</code> which is used for the Event listener <code>InvoicingProcessInitializer</code>.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">InvoicingProcessInitializer.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.haulmont.sample.petclinic.core.payment</span>;

<span class="annotation">@Component</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_invoicingProcessInitializer</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">InvoicingProcessInitializer</span> <span class="directive">implements</span> ApplicationListener&lt;VisitCompletedEvent&gt; {

    <span class="comment">// ...</span>

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> onApplicationEvent(VisitCompletedEvent event) {
        log.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">Payment process initialized: {}</span><span class="delimiter">&quot;</span></span>, event.getVisit());

        CommitContext commitContext = <span class="keyword">new</span> CommitContext();
        createInvoiceFor(event.getVisit(), commitContext);

        dataManager.commit(commitContext);
    }

    <span class="directive">private</span> <span class="type">void</span> createInvoiceFor(Visit visit, CommitContext commitContext) {
        Invoice invoice = dataManager.create(Invoice.class);

        invoice.setVisit(visit);
        invoice.setInvoiceDate(visit.getVisitDate());
        invoice.setInvoiceNumber(createInvoiceNumber());

        <span class="predefined-type">List</span>&lt;InvoiceItem&gt; invoiceItems = createInvoiceItemsFor(invoice);
        invoice.setItems(invoiceItems);

        invoiceItems.forEach(commitContext::addInstanceToCommit);
        commitContext.addInstanceToCommit(invoice);

    }

    <span class="comment">//...</span>

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cuba_ui_events"><a class="anchor" href="#cuba_ui_events"></a><a class="link" href="#cuba_ui_events">CUBA UI events</a></h3>
<div class="paragraph">
<p>On the UI layer there are two main use cases for events. The first is that the framework itself sends events for certain interactions that happen within the user interface of the application. Additionally, it is also possible just like in the middleware layer to send custom application UI events. Both kinds of events have in common that instead of the middleware events the UI events are always scoped to one instance of the UI. Furthermore, the events are scoped towards a single browser tab.</p>
</div>
<div class="sect3">
<h4 id="framework_ui_events"><a class="anchor" href="#framework_ui_events"></a><a class="link" href="#framework_ui_events">Framework UI events</a></h4>
<div class="paragraph">
<p>With CUBA 7 the API of the UI components changed from programmatically defined event listener and template method pattern towards declarative event subscriptions via annotations. It is possible to register event listeners in the controller using the <code>@Subscribe</code> annotation.</p>
</div>
<div class="paragraph">
<p>There are several Events to subscribe that deal with the lifecycle of a controller like <code>InitEvent</code>, <code>BeforeCloseEvent</code>, <code>PreCommitEvent</code> and so on. The data part of the controllers also offer a list of Events like <code>ItemChangeEvent</code>, <code>CollectionChangeEvent</code>. Furthermore, the UI components themselves send events for changes of their states like <code>EnterPressEvent</code>, <code>TextChangeEvent</code> and so on.</p>
</div>
<div class="paragraph">
<p>CUBA studio has the ability to get an overview of the available events for a controller. It looks like this:</p>
</div>
<img src="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-application-events/master/img/studio-subscribe-to-events.png"/>
<div class="paragraph">
<p>For the petclinic, the VisitEdit controller leverages the <code>InitEntityEvent</code> for generating a Room keycode when a new entity is going to be created:</p>
</div>
<div class="listingblock">
<div class="title">VisitEdit.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@UiController</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">petclinic_Visit.edit</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@UiDescriptor</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">visit-edit.xml</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@EditedEntityContainer</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">visitCt</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VisitEdit</span> <span class="directive">extends</span> StandardEditor&lt;Visit&gt; {

    <span class="annotation">@Subscribe</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">protected</span> <span class="type">void</span> onInitEntity(InitEntityEvent&lt;Visit&gt; event) {
        event.getEntity().setRoomKeycode(generateRoomKeycode()); <i class="conum" data-value="2"></i><b>(2)</b>
    }

    <span class="directive">private</span> <span class="predefined-type">String</span> generateRoomKeycode() {
        <span class="type">int</span> rookKeycode = <span class="keyword">new</span> <span class="predefined-type">Random</span>().nextInt(<span class="integer">999999</span>);
        <span class="keyword">return</span> <span class="predefined-type">String</span>.format(<span class="string"><span class="delimiter">&quot;</span><span class="content">%04d</span><span class="delimiter">&quot;</span></span>, rookKeycode);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Registering <code>onInitEntity</code> as an event listener for the <code>InitEntityEvent&lt;Visit&gt;</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setting the room keycode of the newly created visit entity</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="custom_ui_events"><a class="anchor" href="#custom_ui_events"></a><a class="link" href="#custom_ui_events">Custom UI events</a></h4>
<div class="paragraph">
<p>Just like for custom application events, custom UI events allow sending notifications about business / UI related facts as objects. The same UI instance is able to register for those events and execute further decoupled logic. In the petclinic, the following use case is modeled as a custom UI event. Once the visit is marked as complete through the UI button, the table of the screen should be updated.</p>
</div>
<div class="paragraph">
<p>The first step is once again to define a</p>
</div>
<div class="listingblock">
<div class="title">VisitCompletedUiEvent.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VisitCompletedClickedEvent</span> <span class="directive">extends</span> ApplicationEvent <span class="directive">implements</span> UiEvent { <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="directive">public</span> VisitCompletedClickedEvent(<span class="predefined-type">Object</span> source) {
        <span class="local-variable">super</span>(source);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Marks the application event as a UI event by implementing the interface <code>UiEvent</code></td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">VisitEdit.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VisitBrowse</span> <span class="directive">extends</span> StandardLookup&lt;Visit&gt; {

    <span class="comment">// ...</span>

    <span class="annotation">@Inject</span>
    <span class="directive">private</span> Events events; <i class="conum" data-value="1"></i><b>(1)</b>


    <span class="annotation">@Subscribe</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">visitsTable.completeVisit</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="type">void</span> completeVisit(<span class="predefined-type">Action</span>.ActionPerformedEvent event) {
        Visit visit = visitsTable.getSingleSelected();
        <span class="type">boolean</span> visitWasCompleted = visitStatusService.completeVisit(visit);

        <span class="keyword">if</span> (visitWasCompleted) {
            events.publish(<span class="keyword">new</span> VisitCompletedClickedEvent(visit)); <i class="conum" data-value="2"></i><b>(2)</b>
        }
        <span class="comment">// ...</span>
    }

    <span class="annotation">@EventListener</span> <i class="conum" data-value="3"></i><b>(3)</b>
    <span class="directive">protected</span> <span class="type">void</span> updateDataOnVisitCompleted(VisitCompletedClickedEvent event) {
        loadData(); <i class="conum" data-value="4"></i><b>(4)</b>

        notifications.create()
                .setCaption(messages.formatMessage(<span class="local-variable">this</span>.getClass(), <span class="string"><span class="delimiter">&quot;</span><span class="content">visitCompleteSuccessful</span><span class="delimiter">&quot;</span></span>))
                .setType(Notifications.NotificationType.TRAY)
                .show();
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Using CUBAs <code>Events</code> mechanism</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Sending a <code>VisitCompletedUiEvent</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Registering <code>updateDataOnVisitCompleted</code> as an event listener for <code>VisitCompletedUiEvent</code> events</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Reload the data</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this example the sender and the receiver are the same class, but this does not necessarily be the case. It is also possible to send a UI event in one controller and receive the event in another controller.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sending_events_between_layers"><a class="anchor" href="#sending_events_between_layers"></a><a class="link" href="#sending_events_between_layers">Sending events between layers</a></h3>
<div class="paragraph">
<p>Technically there is one main constraint to think about when interacting with events in a CUBA application. This is that as CUBA is a multi-module application that can be deployed as two main parts: frontend (web module) and middleware (core module) sending events between the two layers is not directly possible.</p>
</div>
<div class="paragraph">
<p>The underlying framework for the events mechanism is Spring which has the facility to send application events within one application, more precisely within one JVM process. Since frontend and middleware can be two different JVM processes on different servers, Spring by default has no capabilities to interact across JVM processes.</p>
</div>
<div class="paragraph">
<p>There are two ways to solve this problem. The first one is to leverage an external message broker like RabbitMQ to interact between applications (or layers of applications in this case). An internal application event can be send internally. An event listener (e.g. <code>RabbitMqForwarder</code>) then takes this message and forwards it to the external message broker. On the receiver side another Event listener for external RabbitMQ messages converts the messages back to an internal CUBA / Spring messages. With that the application can transparently communicate between JVM boundaries.</p>
</div>
<div class="paragraph">
<p>The other way is to use an existing application component called <code>global-events</code>. Global events is an application component from Haulmont that especially addresses the problem of communicating between CUBA middleware and frontend parts.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a><a class="link" href="#summary">Summary</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Application events in CUBA allow defining loosely coupled business logic within the application. Parts independent from a business functionality point of view can also be reflected as independent components within the application. This low coupling has certain advantages like easier testability and higher resiliency of the parts of the application.</p>
</div>
<div class="paragraph">
<p>But there are also downsides to this approach. Communicating via events can sometimes be a challenge to get a developer&#8217;s head around. Method invocation allow a back-channel as a response. This is normally not the case for events. Also identifying that certain parts can be executed independent of each other is sometimes not obvious at first sight.</p>
</div>
<div class="paragraph">
<p>One could argue that in the example from above the room keycode to the pet&#8217;s owner should only be sent if the room system also knows about it and has configured everything properly. This natural wish for consistency is oftentimes very hard to achieve in a distributed system (as the petclinic management and room system are). Messaging in this regard increases the resiliency of the overall system and its parts on the costs of some potential consistency.</p>
</div>
<div class="paragraph">
<p>Ultimately, modelling and using application events right prevents application logic from ending up in a big ball of mud with invocations between business logic from any parts of the system to any other parts of the system. Sending messages across application parts is a more maintainable way of arranging application logic and oftentimes represents the workflows of the problem domain in a more accurate way as they exist in the real world.</p>
</div>
<div class="sect2">
<h3 id="further_information"><a class="anchor" href="#further_information"></a><a class="link" href="#further_information">Further information</a></h3>
<div class="ulist">
<ul>
<li>
<p><a href="https://doc.cuba-platform.com/manual-7.0/events.html">Events reference documentation</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Sidebar (right column) -->
            <div id="blog-sidebar">
                <div class="region region-sidebar">
                    <section id="block-block-29" class="block block-block clearfix">


                        <div class="guide-panel">
                            <h4>Table of contents</h4>
                            <ul class="sectlevel1">
<li><a href="#what_will_be_built">What will be built</a></li>
<li><a href="#example_cuba_petclinic">Example: CUBA petclinic</a></li>
<li><a href="#benefits_of_an_event_based_business_logic">Benefits of an event based business logic</a></li>
<li><a href="#available_types_of_events_in_a_cuba_application">Available types of events in a CUBA application</a></li>
<li><a href="#summary">Summary</a></li>
</ul>
                        </div>


                        <div class="guide-panel download">
                            <h4>Example code</h4>
                            <a class="button expanded"  href="https://github.com/cuba-guides/cuba-petclinic-intro-to-application-events/archive/master.zip" target="_blank">Download</a>
                            <a href="https://github.com/cuba-guides/cuba-petclinic-intro-to-application-events" class="github-link" target="_blank">Github</a>
                        </div>
                        <div class="guide-panel cuba-version">
                            <h4>Supported Versions</h4>
                            <ul>
                                <li>CUBA: 7.0+</li>
                                <li>Java: 8+</li>
                            </ul>
                        </div>

                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <!-- BEGIN FOOTER -->
<footer id="footer">
    <div class="footer-wrapper cuba-container">
        <div class="region region-footer-sitemap">
            <section id="block-footer-sitemap-footer-sitemap" class="block block-footer-sitemap clearfix">
                <div id="footer-sitemap" class="clearfix">
                    <div class="fs-block-content">
                        <div class="menu-footer-sitemap">
                            <ul class="footer_links_menu-footer-sitemap total-items-5 parent-items-0 single-items-0">
                                <li class="menu-1466 depth-1 total-children-4 parent-children-0 single-children-4  first">
                                    <a href="/framework" class="fs-root-link">Platform</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-4 parent-items-0 single-items-0">
                                        <li class="menu-2770 depth-2 fs-no-children  first"><a href="/framework">The Framework</a></li>
                                        <li class="menu-1473 depth-2 fs-no-children"><a href="/development-tools">Development Tools</a></li>
                                        <li class="menu-2838 depth-2 fs-no-children"><a href="/marketplace">Marketplace</a></li>
                                        <li class="menu-2771 depth-2 fs-no-children  last"><a href="/license-pricing">License &amp; Pricing</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1469 depth-1 total-children-7 parent-children-0 single-children-7">
                                    <a href="/online-demo" class="fs-root-link">Learn</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-7 parent-items-0 single-items-0">
                                        <li class="menu-1479 depth-2 fs-no-children first"><a href="/online-demo">Online demo</a></li>
                                        <li class="menu-1477 depth-2 fs-no-children"><a href="/quickstart">Quick start</a></li>
                                        <li class="menu-1478 depth-2 fs-no-children"><a href="/tutorials">Tutorials</a></li>
                                        <li class="menu-1731 depth-2 fs-no-children"><a href="/sample-projects">Sample Projects</a></li>
                                        <li class="menu-1773 depth-2 fs-no-children"><a href="/webinars">Webinars</a></li>
                                        <li class="menu-1476 depth-2 fs-no-children"><a href="/documentation">Documentation</a></li>
                                        <li class="menu-1602 depth-2 fs-no-children last"><a href="/faq">FAQ</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1603 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="https://www.cuba-platform.com/discuss/" class="fs-root-link">Community</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1604 depth-2 fs-no-children first"><a href="https://www.cuba-platform.com/discuss/">Forum</a></li>
                                        <li class="menu-1692 depth-2 fs-no-children"><a href="/testimonials">Customer stories</a></li>
                                        <li class="menu-1615 depth-2 fs-no-children last"><a href="/blog">Blog</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1663 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="/training" class="fs-root-link">Services</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1756 depth-2 fs-no-children first"><a href="/training">Training</a></li>
                                        <li class="menu-1757 depth-2 fs-no-children"><a href="/support-options">Support</a></li>
                                        <li class="menu-1758 depth-2 fs-no-children last"><a href="/deployment">Development</a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="menu-1612 depth-1 total-children-3 parent-children-0 single-children-3  last">
                                    <a href="/download" class="fs-root-link">More</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-2773 depth-2 fs-no-children first"><a href="/download">Download</a></li>
                                        <li class="menu-2775 depth-2 fs-no-children"><a href="/store">Store</a></li>
                                        <li class="menu-1480 depth-2 fs-no-children last"><a href="/contacts">Contacts</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </section>
        </div>
        <div class="region region-footer-copyright">
            <section id="block-block-14" class="block block-block clearfix">
                <div class="footer-copyright">
                    <div class="copyright">Copyright &copy; 2008-2018 Haulmont</div>
                    <div class="licences"><a href="/terms-of-use">Terms of Use</a></div>
                    <div class="socials">
                        <ul>
                            <li><a href="https://github.com/cuba-platform/cuba" class="socials-icon github"></a></li>
                            <li><a href="https://www.youtube.com/c/CubaPlatform" class="socials-icon youtube"></a></li>
                            <li><a href="https://www.facebook.com/CUBAplatform" class="socials-icon facebook"></a></li>
                            <li><a href="https://twitter.com/CubaPlatform" class="socials-icon twitter"></a></li>
                            <li><a href="https://www.linkedin.com/company/cuba-platform" class="socials-icon linkedin"></a></li>
                            <li><a href="https://www.cuba-platform.com/rss.xml" class="socials-icon rss"></a></li>
                        </ul>
                    </div>
                </div>
                <!-- Place this tag in your head or just before your close body tag. -->
                <script async defer src="https://buttons.github.io/buttons.js"></script>
            </section>
        </div>
    </div>
    <!--<script src="https://www.cuba-platform.com/sites/default/files/js/js_OmOCame-fnmHrN5e61CZ6Qi6MS5rHZ2jo6O0qsiYS1Q.js"></script>
    <script src="https://www.cuba-platform.com/sites/default/files/js/js_Es7w5kWiS8CGph1E0HE2jrcO3tONeJfC-cTNWigk87E.js"></script>-->
</footer>
<!-- END FOOTER -->
<div class="scrollTop"></div>
</section>

<script src="/guides/js/foundation.min.js"></script>
<script src="https://unpkg.com/isotope-layout@3.0/dist/isotope.pkgd.js"></script>
<script src="/guides/js/vendor/modernizr.js"></script>
<script src="/guides/js/toc.js"></script>
<script src="/guides/js/navigation.js"></script>
<script src="/guides/js/navbar.js"></script>
<script src="/guides/js/extra.js"></script>
<script src="/guides/js/extra2.js"></script>
<script>
(function ($) {
  $(document).foundation();
  var doc = document.documentElement;
  doc.setAttribute('data-useragent', navigator.userAgent)

  /* Issue #24 */
  $(".blog .content img").each(function() {
    var imgMarkup = $(this)[0].outerHTML;
    console.log(imgMarkup);
    $(this).replaceWith('<div class="img-center">' + imgMarkup + '</div>');
  });
})(jQuery); 
</script>
</body>
</html>
