<!doctype html>
<!--[if IE 9]>
<html class="lt-ie10" lang="en"> <![endif]-->
<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middleware Integration Testing in CUBA Applications</title>
    <meta name="description" content="The CUBA Platform guides cover different aspects of the CUBA Platform and give you advice on how to work with CUBA Platform by giving you concrete examples.">
    <meta name="author" content="Haulmont">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@CubaPlatform">
    <meta name="twitter:creator" content="@CubaPlatform">
    <meta name="twitter:title" content="Middleware Integration Testing in CUBA Applications">
    <meta name="twitter:description" content="Testing Guide: Middleware integration testing of a CUBA application">
    <meta name="twitter:image" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Middleware Integration Testing in CUBA Applications">
    <meta property="og:description" content="Testing Guide: Middleware integration testing of a CUBA application">
    <meta property="og:url" content="https://www.cuba-platform.com/guides/integration-testing-middleware">
    <meta property="og:image" content="">

    <link rel="shortcut icon" href="/guides/images/favicon.png" type="image/png" />
    <link rel="stylesheet" href="/guides/css/foundation.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.css">
    <link rel="stylesheet" href="/guides/css/coderay.css">
    <link rel="stylesheet" href="/guides/css/bootstrap.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/reset.css">
    <link rel="stylesheet" href="https://www.cuba-platform.com/sites/all/themes/cuba_adaptive/css/animate.css">
    <link rel="stylesheet" href="/guides/css/extra.css">
    <link rel="stylesheet" href="/guides/css/extra2.css">
    <link rel="stylesheet" href="/guides/css/cuba-new.css">
    <link rel="stylesheet" href="/guides/css/font-awesome.min.css">
    <link rel="stylesheet" href="/guides/css/guides.css">
    <script src="/guides/js/jquery_v2.1.min.js"></script>
    <link rel="stylesheet" href="/guides/css/main.css" />
    <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MH3DTWV');</script>
<!-- End Google Tag Manager -->
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-962 node-type-blog-post i18n-en">

<section id="wrapper">
    
<header role="banner" fragment="14269c1b298" class="header">
    <nav class="header_nav">
        <input id="mobile-menu-open" type="checkbox" class="header_checkbox">
        <div class="container header_container">
            <div class="header_toggle">
                <label for="mobile-menu-open"
                       class="header_toggle-label toggle-label">
                    <span>CUBA.platform</span>
                </label>
            </div>
            <a href="/" class="header_logo nuxt-link-active"></a>
            <ul class="header_menu">
                <li class="header_menu_item"><a href="/framework/" class="header_menu_link">Framework</a></li>
                <li class="header_menu_item"><a href="/learn/" class="header_menu_link nuxt-link-active">Learn</a></li>
                <li class="header_menu_item"><a href="/documentation/" class="header_menu_link">Documentation</a></li>
                <li class="header_menu_item"><a href="/discuss/" class="header_menu_link">Forum</a></li>
                <li class="header_menu_item"><a href="/blog/" class="header_menu_link">Blog</a></li>
            </ul>
            <div class="header-support">
                <button class="header-support_toggle">
                <img src="images/users.svg" class="header-support_toggle_icon">
                <span class="header-support_toggle_text">Services</span></button>
                <div class="header-support_popup">
                    <div class="support-popup">
                        <div class="support-popup_services">
                            <h3 class="support-popup_services_title">Commercial services for your project</h3>
                            <ul class="services-list">
                                <li class="services-list_item"><a href="/support-options/"><strong
                                        class="services-list_title">Consultancy &amp; Support</strong>
                                    <div class="services-list_text">
                                        <div><p>Commercial consulting requests have a guaranteed response
                                            time.</p>
                                        </div>
                                    </div>
                                </a></li>
                                <li class="services-list_item"><a href="/development/"><strong
                                        class="services-list_title">Custom Development</strong>
                                    <div class="services-list_text">
                                        <div><p>We can deliver a turn key solution or contribute to your
                                            project</p>
                                        </div>
                                    </div>
                                </a></li>
                                <li class="services-list_item"><a href="/training/"><strong
                                        class="services-list_title">Training</strong>
                                    <div class="services-list_text">
                                        <div><p>For fast and deep dive into framework features to shift your
                                            team productivity.</p>
                                        </div>
                                    </div>
                                </a></li>
                            </ul>
                        </div>
                        <div class="support-popup_haulmont">
                            <div class="support-popup_haulmont_header"><h3 class="support-popup_haulmont_title">
                                Haulmont</h3>
                                <div class="support-popup_haulmont_subtitle">we develop modern enterprise
                                    solutions
                                </div>
                            </div>
                            <ul class="haulmont-list">
                                <li class="haulmont-list_item">
                                    <div><p>Experts in Enterprise software</p>
                                    </div>
                                </li>
                                <li class="haulmont-list_item">
                                    <div><p>Creators of the CUBA Platform</p>
                                    </div>
                                </li>
                                <li class="haulmont-list_item">
                                    <div><p>Established in 2008</p>
                                    </div>
                                </li>
                            </ul>
                            <ul class="numbers-list">
                                <li class="numbers-list_item"><strong class="numbers-list_number">300+</strong>
                                    <div class="numbers-list_text">developers</div>
                                </li>
                                <li class="numbers-list_item"><strong class="numbers-list_number">400+</strong>
                                    <div class="numbers-list_text">projects</div>
                                </li>
                                <li class="numbers-list_item">
                                    <div class="numbers-list_text">Customers in</div>
                                    <strong class="numbers-list_number">60+</strong>
                                    <div class="numbers-list_text">countries</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <a href="/user/" class="header_profile">
                <svg xmlns="http://www.w3.org/2000/svg" id="i-profile" class="icon header_profile_src" viewBox="0 0 563.43 563.43" width="100%" height="100%">
                    <path d="M280.79 314.559c83.266 0 150.803-67.538 150.803-150.803S364.055 13.415 280.79 13.415 129.987 80.953 129.987 163.756s67.537 150.803 150.803 150.803zm0-261.824c61.061 0 111.021 49.959 111.021 111.021s-49.96 111.02-111.021 111.02-111.021-49.959-111.021-111.021 49.959-111.02 111.021-111.02zM19.891 550.015h523.648c11.102 0 19.891-8.789 19.891-19.891 0-104.082-84.653-189.198-189.198-189.198H189.198C85.116 340.926 0 425.579 0 530.124c0 11.102 8.789 19.891 19.891 19.891zm169.307-169.307h185.034c75.864 0 138.313 56.436 148.028 129.524H41.17c9.714-72.625 72.164-129.524 148.028-129.524z"></path>
                </svg>
            </a>
        </div>
    </nav>
    <nav class="header-submenu">
        <div class="container header-submenu_container">
            <a href="/learn/quickstart/" class="header-submenu_link">Quick Start</a>
            <a href="/learn/live-demo/" class="header-submenu_link">Live Demo</a>
            <a href="/guides/" class="header-submenu_link nuxt-link-exact-active nuxt-link-active">Guides</a>
        </div>
    </nav>
</header>

<style>
    .upper-header .header-options {
        display: none;
    }

    .upper-header .upper-header-wrapper .header-menu div .nav > li:last-child > a {
        padding-right: 0;
    }
</style>

    <!-- Main Page Content and Sidebar -->
    <div class="content-wrapper">
        <div class="cuba-container text-node blog">



            <!-- Main content (left column) -->
            <div class="region region-content">



                <section id="block-system-main" class="block block-system clearfix">
                    <div id="node-962" class="article node node-blog-post node-promoted clearfix">
                        <div class="content">
                            <div class="field field-name-body field-type-text-with-summary field-label-hidden">
                                <div class="field-items">
                                    <div class="field-item even" property="content: encoded">
                                        <h1>Middleware Integration Testing in CUBA Applications</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Test automation is the key to every successful application development process since it normally gives a high positive return on investments for QA efforts. CUBA applications are built on the Java ecosystem which has very powerful and mature test automation capabilities. In this guide you will learn how to leverage those capabilities.</p>
</div>
<div class="paragraph">
<p>First you will understand how testing in general works in a CUBA application. Afterwards, this guide will concentrate on the area of integration testing in the middleware layer.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what_we_are_going_to_build"><a class="anchor" href="#what_we_are_going_to_build"></a><a class="link" href="#what_we_are_going_to_build">What we are going to build</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide enhances the <a href="https://github.com/cuba-platform/cuba-petclinic">CUBA Petclinic</a> example to show how existing features can be tested in an automated fashion:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>automatic creation of a Visit for a given Pet Identification Number</p>
</li>
<li>
<p>automatic "Disease Warning Mailing" for endangered Pets</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="requirements"><a class="anchor" href="#requirements"></a><a class="link" href="#requirements">Requirements</a></h3>
<div class="paragraph">
<p>Your development environment requires to contain the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://adoptopenjdk.net/">JDK 8</a></p>
</li>
<li>
<p><a href="https://www.cuba-platform.com/download">CUBA Studio</a> as standalone IDE or as an IntelliJ IDEA plugin</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware/archive/master.zip">Download</a> and unzip the source repository for this guide, or clone it using git:</p>
</div>
<div class="paragraph">
<p><code>git clone <a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware.git" class="bare">https://github.com/cuba-guides/cuba-petclinic-testing-middleware.git</a></code></p>
</div>
</div>
<div class="sect2">
<h3 id="additional_testing_dependencies"><a class="anchor" href="#additional_testing_dependencies"></a><a class="link" href="#additional_testing_dependencies">Additional Testing Dependencies</a></h3>
<div class="paragraph">
<p>This guide uses JUnit 5 as well as AssertJ to develop and run the automated integration test cases. Therefore, the following dependencies should be expressed in the <code>build.gradle</code> for all the three modules (<code>global</code>, <code>core</code> and <code>web</code>):</p>
</div>
<div class="listingblock">
<div class="title">build.gradle</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">configure([globalModule, coreModule, webModule]) {
    <span class="comment">// ...</span>
    dependencies {
            testCompile(<span class="string"><span class="delimiter">'</span><span class="content">org.junit.jupiter:junit-jupiter-api:5.5.2</span><span class="delimiter">'</span></span>)
            testCompile(<span class="string"><span class="delimiter">'</span><span class="content">org.junit.jupiter:junit-jupiter-engine:5.5.2</span><span class="delimiter">'</span></span>)
            testCompile(<span class="string"><span class="delimiter">'</span><span class="content">org.junit.vintage:junit-vintage-engine:5.5.2</span><span class="delimiter">'</span></span>)

            testCompile(<span class="string"><span class="delimiter">'</span><span class="content">org.assertj:assertj-core:3.11.1</span><span class="delimiter">'</span></span>)

    }
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="example_cuba_petclinic"><a class="anchor" href="#example_cuba_petclinic"></a><a class="link" href="#example_cuba_petclinic">Example: CUBA petclinic</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>The project that is the basis for this example is <a href="https://github.com/cuba-platform/cuba-petclinic">CUBA Petclinic</a>. It is based on the commonly known <a href="https://github.com/spring-projects/spring-petclinic">Spring Petclinic</a>. The CUBA Petclinic application deals with the domain of a Pet clinic and the associated business workflows to manage a pet clinic.</p>
</div>
<div class="paragraph">
<p>The underlying domain model for the application looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/guides/images/domain-model.png" alt="Domain model">
</div>
</div>
<div class="paragraph">
<p>The main entities are <strong>Pet</strong> and <strong>Visit</strong>. A Pet is visiting the petclinic and during this Visit a Vet is taking care of it. A Pet belongs to an Owner, which can hold multiple pets. The visit describes the act of a pet visiting the clinic with the help of its owner.</p>
</div>
<a href="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-platform/cuba-petclinic/master/img/login-screen.png"/></a>
</div>
</div>
<div class="sect1">
<h2 id="overview"><a class="anchor" href="#overview"></a><a class="link" href="#overview">Overview</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Test automation is a commonly known best practice in the industry of software development for several decades. It allows writing a small test application that executes a particular sub-part of the production application and verifies its correct behavior.</p>
</div>
<div class="paragraph">
<p>The term <code>production</code>, as it is used in this guide, refers to the application code that is inside the application, just to differentiate it from the code that is defining the test case (the <code>test code</code>). It does not mean production as in "the production system" used by your customers.</p>
</div>
<div class="paragraph">
<p>In the Java ecosystem test automation has a long tradition. One famous example of this is the testing framework JUnit, which was one of the very first testing frameworks out in the market.</p>
</div>
<div class="paragraph">
<p>In a CUBA application, just like any other Java application, it is possible and recommended to write automated tests that exercise parts of the target application.</p>
</div>
<div class="paragraph">
<p>In a test case (which is expressed as another Java class in a special test source directory) instances of production classes are instantiated and methods are executed. Afterwards, the results are verified through a programmatic comparison of an expected result against the actual result. Depending on this comparison, the test case is either treated as "success" or "failure".</p>
</div>
<div class="paragraph">
<p>A CUBA application is divided into two parts: the middleware part and the client part. The middleware consists of a combination of the <code>core</code> and the <code>global</code> module in the source code. It normally contains the majority of the business logic, integrations to other systems and the database related interactions.</p>
</div>
<div class="paragraph">
<p>This guide is only about testing the middleware part of a CUBA application, since for the client different patterns and testing strategies apply. Therefore, this kind of testing is covered in another dedicated guide.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="test_environments"><a class="anchor" href="#test_environments"></a><a class="link" href="#test_environments">Test Environments</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Depending on how production code is executed in a test environment, this environment needs to fulfil certain criteria. If e.g. a test exercises a production class that interacts with a database, this database has to be up and running in that environment and the production code must have a proper connection to it.</p>
</div>
<div class="paragraph">
<p>If a test case, on the other hand, executes a production class that contains business logic to sum up order amounts for a customer, the execution environment can be much simpler and without dependencies on other parts.</p>
</div>
<div class="paragraph">
<p>When it comes to the CUBA middleware, both of those environment scenarios can be instantiated to execute test classes. The first variant with running dependencies like a database is normally referred to as an <code>Integration test</code>. The scenario where the production class is instantiated without any surrounding environment support is called a <code>Unit test</code>.</p>
</div>
<div class="paragraph">
<p>In the next section you will learn about the differences of those two environment types. Afterwards, this guide concentrates on the integration testing part by testing the two scenarios for the petclinic application.</p>
</div>
<div class="sect2">
<h3 id="middleware_integration_testing"><a class="anchor" href="#middleware_integration_testing"></a><a class="link" href="#middleware_integration_testing">Middleware Integration Testing</a></h3>
<div class="paragraph">
<p>In this environment the production application is started partially. The integration test environment for a CUBA middleware is oftentimes a common way of running a test case. This means that all the CUBA platform classes work the way just as in the production code of the application.</p>
</div>
<div class="paragraph">
<p>The <code>DataManager</code> interface, for example, when invoking <code>dataManager.load(Customer.class).id(123).one()</code> will actually go against the database and fetch the customer with the ID 123. The same is true for the production code that was written in your application: <code>CustomerCreationService</code> will try to create a Customer in the database.</p>
</div>
<div class="paragraph">
<p>The integration test environment contains the following environmental parts:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Spring application context</p>
</li>
<li>
<p>Connection to external database</p>
</li>
<li>
<p>Platform APIs work as in production codes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It takes a couple of seconds before the environment is available to the test case and the test actually starts.</p>
</div>
<div class="sect3">
<h4 id="database_connection"><a class="anchor" href="#database_connection"></a><a class="link" href="#database_connection">Database Connection</a></h4>
<div class="paragraph">
<p>CUBA integration tests use the same database connection that is established when running the CUBA application. In the case of HSQLDB CUBA Studio takes care of having the database running when executing the test case.</p>
</div>
<div class="paragraph">
<p>By default the database instance is <code>shared</code> between the test environment and the local application. It means that data defined locally when the application is run is also available in the test case execution. Furthermore, if the test case changes the data in the database, it is also changed when you start the application the next time.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Sharing the data between the two environments is convenient and can be helpful but also can cause some level of non-determinism. You might face the situation of having problems expressing the correct assertions in the test case, because you cannot reliably determine how much / which data is in the database or you accidentally change the data through the test case. In this case it is also possible to split the databases between the two environments to avoid such behavior.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="test_container"><a class="anchor" href="#test_container"></a><a class="link" href="#test_container">Test Container</a></h4>
<div class="paragraph">
<p>The Test container is an object in the test case, that is mainly responsible for starting up and managing the integration test environment. It is supposed to be used in the test class as an object that sets up the test environment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>starts the Spring application context</p>
</li>
<li>
<p>establishes a DB connection</p>
</li>
<li>
<p>instantiates all CUBA platform APIs</p>
</li>
<li>
<p>activates all application components and their configuration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>CUBA Studio generates the TestContainer class into the test source directory of the <code>core</code> module. Next you will see an example usage of the <code>PetclinicTestContainer</code>:</p>
</div>
<div class="listingblock">
<div class="title">SampleIntegrationTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">SampleIntegrationTest</span> {

    <span class="annotation">@RegisterExtension</span> <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">public</span> <span class="directive">static</span> PetclinicTestContainer testContainer =
            PetclinicTestContainer.Common.INSTANCE; <i class="conum" data-value="2"></i><b>(2)</b>

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> persistenceAPI_canBeRetrieved_fromTheTestContainer() {

        Persistence persistence = testContainer.persistence(); <i class="conum" data-value="3"></i><b>(3)</b>

        assertNotNull(persistence);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the JUnit integration test uses the PetclinicTestContainer Extension</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the petclinic test container instance is added as a field in the test class</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>in the test cases the container can be used to interact with the test environment</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
This guide uses JUnit 5 as the testing library for examples. CUBA supports multiple testing frameworks like Spock, but by default it ships with JUnit.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="middleware_unit_testing"><a class="anchor" href="#middleware_unit_testing"></a><a class="link" href="#middleware_unit_testing">Middleware Unit Testing</a></h3>
<div class="paragraph">
<p>Besides the integration test environment, it is also possible to create test cases that do not spin up the Spring application context or any CUBA platform APIs at all. As for the above described use case (Sum building of order amounts), not having to start the test environment can be beneficial as well.</p>
</div>
<div class="paragraph">
<p>The two main benefits of writing unit tests in an isolated fashion without an integration test environment are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>locality of the test scenario</p>
</li>
<li>
<p>test execution speed</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>But there are also downsides or limitation when using unit tests. This whole topic is a part of another dedicated testing guide and is not discussed here.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="tests_for_petclinic_functionality"><a class="anchor" href="#tests_for_petclinic_functionality"></a><a class="link" href="#tests_for_petclinic_functionality">Tests for Petclinic Functionality</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the next section you will learn how to put all this theory into action by implementing integration test cases that verify the correct behavior of features introduced in the <a href="https://www.cuba-platform.com/guides/intro-working-with-data-in-cuba">Working with Data in CUBA</a> guide.</p>
</div>
<div class="sect2">
<h3 id="working_with_junit_tests_in_cuba_studio"><a class="anchor" href="#working_with_junit_tests_in_cuba_studio"></a><a class="link" href="#working_with_junit_tests_in_cuba_studio">Working with JUnit Tests in CUBA Studio</a></h3>
<div class="paragraph">
<p>The test cases in the Petclinic example can be executed either by Gradle or directly within CUBA Studio via its UI.</p>
</div>
<div class="paragraph">
<p>The corresponding gradle task is: <code>./gradlew test</code> (Linux, Mac) or <code>gradlew.bat test</code> (Windows)</p>
</div>
<div class="paragraph">
<p>To see test cases in the File list of the project, you need to switch from <code>CUBA</code> to <code>Project</code> in the Project Tool Window.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/integration-testing-middleware/studio-intellij-switch-project-view.png" alt="studio intellij switch project view">
</div>
</div>
<div class="paragraph">
<p>In CUBA Studio the test execution is done by creating a run configuration for the test case and executing this run configuration. A test case or class can either be executed by the shortcut <code>CRTL+F5</code> (Windows) / <code>CMD+R</code> (Mac) or alternatively by using the Run icon on the test case / test class:</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="/guides/images/integration-testing-middleware/running-test-via-cuba-studio.png" alt="running test via cuba studio">
</div>
</div>
<div class="paragraph">
<p>CUBA Studio leverages the standard IntelliJ IDEA capabilities around testing and test execution. More information can be found in the <a href="https://www.jetbrains.com/help/idea/performing-tests.html">IDEA documentation</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="automatic_visit_creation"><a class="anchor" href="#automatic_visit_creation"></a><a class="link" href="#automatic_visit_creation">Automatic Visit Creation</a></h3>
<div class="paragraph">
<p>The first test case is about the automatic visit creation functionality of the Petclinic application. In the Visit browse screen, a user can create a new visit by entering the Pet Identification Number as a quick action. The software will go ahead and create a visit for the entered Pet.</p>
</div>
<a href="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-datamanager/master/img/create-visit-for-pet.png"><img src="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-datamanager/master/img/create-visit-for-pet.png"/></a>
<div class="paragraph">
<p>Part of this feature&#8217;s implementation is a CUBA service called <code>VisitService</code> triggered from the UI. It contains one method <code>Visit createVisitForToday(String identificationNumber)</code> that is the subject of the test case.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Although the feature includes a UI part, this will not be part of the automated testing. It is quite common to test certain subparts of the implementation in isolation (as you will see). That being said, there is still a need for a real end-to-end test case to verify all the parts work together correctly. But this is out of this guide&#8217;s scope.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="implementation_of_the_functionality"><a class="anchor" href="#implementation_of_the_functionality"></a><a class="link" href="#implementation_of_the_functionality">Implementation of the Functionality</a></h4>
<div class="paragraph">
<p>Before looking into the first test case, here is a recap of what the <code>VisitService</code> is doing in the implementation:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>it looks up the Pet by the given Identification Number</p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>in case the Pet is found, it will use it</p>
</li>
<li>
<p>in case no Pet is found, it will not create a Visit</p>
</li>
</ol>
</div>
</li>
<li>
<p>it creates a new instance of a Visit with the correct attributes</p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>it figures out the correct Pet and assigns it to the Visit</p>
</li>
<li>
<p>it uses <code>today</code> as the <code>visitDate</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>it stores the newly created Visit</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The implementation of this functionality is shown below:</p>
</div>
<div class="listingblock">
<div class="title">VisitServiceBean.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Service</span>(VisitService.NAME)
<span class="directive">public</span> <span class="type">class</span> <span class="class">VisitServiceBean</span> <span class="directive">implements</span> VisitService {
  <span class="annotation">@Inject</span>
  <span class="directive">protected</span> DataManager dataManager;
  <span class="annotation">@Inject</span>
  <span class="directive">protected</span> TimeSource timeSource;
  <span class="comment">//...</span>
  <span class="annotation">@Override</span>
  <span class="directive">public</span> Visit createVisitForToday(<span class="predefined-type">String</span> identificationNumber) {
    Optional&lt;Pet&gt; pet = loadPetByIdentificationNumber(identificationNumber);  <i class="conum" data-value="1"></i><b>(1)</b>

    <span class="keyword">if</span> (!pet.isPresent()) {
      <span class="keyword">return</span> <span class="predefined-constant">null</span>;
    }

    <span class="keyword">return</span> saveVisit( <i class="conum" data-value="2"></i><b>(2)</b>
        createVisitForPet(pet.get())
    );
  }

  <span class="directive">private</span> Visit createVisitForPet(Pet pet) {
    Visit visit = dataManager.create(Visit.class);
    visit.setPet(pet);
    visit.setVisitDate(timeSource.currentTimestamp());
    <span class="keyword">return</span> visit;
  }

  <span class="directive">private</span> Visit saveVisit(Visit visit) {
    <span class="keyword">return</span> dataManager.commit(visit);
  }

  <span class="directive">private</span> Optional&lt;Pet&gt; loadPetByIdentificationNumber(<span class="predefined-type">String</span> identificationNumber) {
    <span class="keyword">return</span> dataManager.load(Pet.class)
        .query(<span class="string"><span class="delimiter">&quot;</span><span class="content">e.identificationNumber = ?1</span><span class="delimiter">&quot;</span></span>, identificationNumber)
        .optional();
  }
  <span class="comment">//...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the Pet is searched by the given Identification Number returning an <code>Optional&lt;Pet&gt;</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>in case a Pet is found, a corresponding Visit will be created and stored</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="test_class_setup"><a class="anchor" href="#test_class_setup"></a><a class="link" href="#test_class_setup">Test Class Setup</a></h4>
<div class="paragraph">
<p>To implement the defined test case, first let&#8217;s look at the integration test harness of the test case. It is based on the description of the <code>SampleIntegrationTest</code> from above. In this test there are some noteworthy additions to simplify the test cases.</p>
</div>
<div class="listingblock">
<div class="title">VisitServiceTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">VisitServiceTest</span> {
    <span class="annotation">@RegisterExtension</span>
    <span class="directive">public</span> <span class="directive">static</span> PetclinicTestContainer testContainer = PetclinicTestContainer.Common.INSTANCE;
    <span class="directive">private</span> <span class="directive">static</span> VisitService visitService; <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="directive">static</span> PetclinicVisitDb db;

    <span class="directive">private</span> Visit visit;
    <span class="directive">private</span> Pet pikachu;

    <span class="annotation">@BeforeAll</span>
    <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> setupEnvironment() {
        visitService = AppBeans.get(VisitService.class);

        db = <span class="keyword">new</span> PetclinicVisitDb( <i class="conum" data-value="2"></i><b>(2)</b>
            AppBeans.get(DataManager.class),
            testContainer
        );
    }

    <span class="annotation">@BeforeEach</span>
    <span class="directive">public</span> <span class="type">void</span> loadPikachu() { <i class="conum" data-value="3"></i><b>(3)</b>
        pikachu = db.petWithName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Pikachu</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">pet-with-owner-and-type</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="comment">// different test cases...</span>

    <span class="annotation">@AfterEach</span>
    <span class="directive">public</span> <span class="type">void</span> cleanupVisit() { <i class="conum" data-value="4"></i><b>(4)</b>
        db.remove(visit);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the <code>VisitService</code> is the system under test (SUT) in this test case</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the <code>PetclinicVisitDb</code> class acts as a container for all relevant interactions with the database like test data and verification</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>loadPikachu</code> is an example of a method that should be executed before each test case in this class</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>the <code>cleanupVisit</code> does the data cleanup in the DB after each test case execution</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The JUnit Annotations <code>@BeforeEach</code> and <code>@AfterEach</code> are used to execute certain parts of the code before / after each test case.</p>
</div>
</div>
<div class="sect3">
<h4 id="test_utility_methods"><a class="anchor" href="#test_utility_methods"></a><a class="link" href="#test_utility_methods">Test Utility Methods</a></h4>
<div class="paragraph">
<p>One important piece here is the class <code>PetclinicVisitDb</code> and its usage via the <code>db</code> variable.
This class encapsulated Database interactions tailored towards the test class <code>VisitServiceTest</code>. It has the following API:</p>
</div>
<div class="listingblock">
<div class="title">PetclinicVisitDb.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">PetclinicVisitDb</span> {

  <span class="directive">public</span> Pet petWithName(<span class="predefined-type">String</span> name, <span class="predefined-type">String</span> view) { <span class="comment">/* ... */</span> }

  <span class="directive">public</span> <span class="type">void</span> remove(<span class="predefined-type">Entity</span>&lt;<span class="predefined-type">UUID</span>&gt; entity) { <span class="comment">/* ... */</span> }

  <span class="directive">public</span> Optional&lt;Pet&gt; petWithIdentificationNumber(
          <span class="predefined-type">String</span> identificationNumber
  ) { <span class="comment">/* ... */</span> }

  <span class="directive">public</span> <span class="predefined-type">Long</span> countVisitsFor(Pet pet) { <span class="comment">/* ... */</span> }

  <span class="directive">public</span> <span class="predefined-type">Long</span> countVisits() { <span class="comment">/* ... */</span> }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Under the hood the class interacts with the <code>dataManager</code> and other various things to provide this specific API to the test cases. This class is a combination of an implementation of the <a href="http://xunitpatterns.com/Test%20Utility%20Method.html">Test Utility Method pattern</a> and the
 <a href="http://xunitpatterns.com/Back%20Door%20Manipulation.html">Back Door Manipulation Pattern</a>.</p>
</div>
<div class="paragraph">
<p>It is not strictly necessary to put this logic into a dedicated class, but it oftentimes frees up the test classes from various helper methods or inline code that will increase the noise in the test case itself (as you can see in the first test case).</p>
</div>
</div>
<div class="sect3">
<h4 id="arrange_act_assert"><a class="anchor" href="#arrange_act_assert"></a><a class="link" href="#arrange_act_assert">Arrange Act Assert</a></h4>
<div class="paragraph">
<p>The general pattern of how most test cases in this guide are defined is called <code>Arrange-Act-Assert</code>:</p>
</div>
<div class="paragraph">
<p>First there is a phase of test data setup, or verification of test data (<code>Arrange</code>). This is necessary to ensure the test case has a stable set of test data to start from. Next, the implementation is exercised with the desired input parameters (<code>Act</code>). In the last phase, the verifications are executed to see if the code changed the system in the desired ways (<code>Assert</code>).</p>
</div>
</div>
<div class="sect3">
<h4 id="first_test_case"><a class="anchor" href="#first_test_case"></a><a class="link" href="#first_test_case">First Test Case</a></h4>
<div class="paragraph">
<p>Based on the implementation description it is possible to identify a couple of test cases, that describe the above mentioned behavior:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>createsANewVisit_forTheCorrectPet</code> - verifies <code>1.a</code>, <code>2.a</code> and <code>3.</code></p>
</li>
<li>
<p><code>createsANewVisit_withTheCorrectVisitInformation</code> - verifies <code>1.a</code>, <code>2.b</code> and <code>3.</code></p>
</li>
<li>
<p><code>createsNoVisit_forAnIncorrectIdentificationNumber</code> - verifies <code>1.b</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s look into the test case which checks for the correct Pet to be associated to the new Visit:</p>
</div>
<div class="listingblock">
<div class="title">VisitServiceTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">VisitServiceTest</span> {
    <span class="comment">// ...</span>
    <span class="directive">private</span> Visit visit;
    <span class="directive">private</span> Pet pikachu;

    <span class="annotation">@BeforeEach</span>
    <span class="directive">public</span> <span class="type">void</span> loadPikachu() {
        pikachu = db.petWithName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Pikachu</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">pet-with-owner-and-type</span><span class="delimiter">&quot;</span></span>);
    }

    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> createVisitForToday_createsANewVisit_forTheCorrectPet() { <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="comment">// given: there is one visit associated to pikachu</span>
        assertThat(db.countVisitsFor(pikachu))
            .isEqualTo(<span class="integer">1</span>);
        <span class="comment">// when: logic is executed for pikachus identification number</span>
        visit = visitService.createVisitForToday(
                pikachu.getIdentificationNumber()
        );
        <span class="comment">// then: there are two visits associated to pikachu</span>
        assertThat(db.countVisitsFor(pikachu)) <i class="conum" data-value="2"></i><b>(2)</b>
            .isEqualTo(<span class="integer">2</span>);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the method name of the JUnit test case describes the high level narrative of the test case</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the assertions are expressed through a corresponding AssertJ assertion</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As described above, the test case uses the <code>Arrange-Act-Assert</code> pattern with the three steps, that are described through the <code>given</code>, <code>when</code> and <code>then</code> comments in the test case.</p>
</div>
<div class="paragraph">
<p>With the passing in the Identification Number of Pikachu, and then afterwards assert that the count of visits was increased in the DB, it is safe to say that the <code>VisitService</code> correctly did a lookup from the Identification Number to the correct Pet entity (<code>1.a</code>).</p>
</div>
<div class="paragraph">
<p>Furthermore, we can conclude that <code>2.a</code> and <code>3.</code> are also handled correctly since in the
assertion we do another DB lookup of visits by the foreign key to the Pikachu Pet instance and verify the amount was increased exactly by one.</p>
</div>
<div class="paragraph">
<p>The <code>assertThat</code> statement compares the two values <code>db.countVisitsFor(pikachu)</code> and <code>2</code>. If they are the same, the test is treated as success, otherwise it is treated as failure.</p>
</div>
</div>
<div class="sect3">
<h4 id="database_seed_data"><a class="anchor" href="#database_seed_data"></a><a class="link" href="#database_seed_data">Database Seed Data</a></h4>
<div class="paragraph">
<p>One thing to note here is that there is already some data in the database. Not only Pets like <code>Pikachu</code> are already stored, Visit information is stored as well. This is because in the Petclinic application the <code>30.create-db.sql</code> file contains seed data that is used for demonstration purposes. This has both upsides and downsides when it comes to test automation.</p>
</div>
<div class="paragraph">
<p>On the one hand, it makes the test data setup easier, as there is already some data to rely on. It is not necessary to create the required <code>Pet</code>, <code>PetType</code> and <code>Visit</code> entities programmatically
before any test case can be executed. It makes the test creation easier and faster.</p>
</div>
<div class="paragraph">
<p>On the other hand, relying on test data that is defined outside the test case also comes with a maintenance cost. It generally makes the test cases less resilient to changes of that test data. Since this is central test data that all test cases share (as well as the running application), the situation can be even worse. Also, is makes the test a little more obscure, since it is hard to see those implicit assumptions about certain data being available.</p>
</div>
<div class="paragraph">
<p>To mitigate that situation the first test case contains a <a href="http://xunitpatterns.com/Guard%20Assertion.html">Guard Assertion</a>: <code>assertThat(db.countVisitsFor(pikachu)).isEqualTo(1);</code>. It ensures that the test data setup is what the test expects to function correctly. In case this precondition is not given, the test will fail immediately pointing to that problem. Without this precondition, a downstream error would have occurred, and it would be harder to determine
the root cause of the failing test case. Besides the test case, it also helps the reader of the test case to understand it better.</p>
</div>
<div class="paragraph">
<p>It is possible to improve the situation even further but still stay with the central seed data setup. In fact, for the the test case it is irrelevant if there are 1, 2 or 85 visits in the database for the pet. The only thing that is relevant is that the amount should be <em>increased exactly by one</em> after the execution.</p>
</div>
<div class="paragraph">
<p>To make the test more independent on the amount of <code>Visit</code> data, the test can capture the amount before the execution like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">class</span> <span class="class">VisitServiceTest</span> {
    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> createVisitForToday_createsANewVisit_forTheCorrectPet() {
        <span class="comment">// given: the amount of visits for pikachu is captured</span>
        <span class="predefined-type">Long</span> visitAmountBefore = db.countVisitsFor(pikachu);
        <span class="comment">// when: logic is executed for the pikachus identification number</span>
        visit = visitService.createVisitForToday(
                pikachu.getIdentificationNumber()
        );
        <span class="comment">// then: there is one more visit associated to pikachu</span>
        assertThat(db.countVisitsFor(pikachu))
            .isEqualTo(visitAmountBefore + <span class="integer">1</span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With that change the test will be more resilient regardless of how many visits for Pikachu are inserted by the environment. This variant is an implementation of the <a href="http://xunitpatterns.com/Delta%20Assertion.html">Delta Assertion Pattern</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="other_test_cases_for_createvisitfortoday"><a class="anchor" href="#other_test_cases_for_createvisitfortoday"></a><a class="link" href="#other_test_cases_for_createvisitfortoday">Other Test Cases for CreateVisitForToday</a></h4>
<div class="paragraph">
<p>For this example the two additional test cases will not be discussed in this guide as they are quite similar compared to the test case from above. Instead you can look them up in the corresponding example project:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware/blob/master/modules/core/test/com/haulmont/sample/petclinic/service/visit/create_visit/VisitServiceTest.java#L65">test case: createVisitForToday_createsANewVisit_withTheCorrectVisitInformation</a></p>
</li>
<li>
<p><a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware/blob/master/modules/core/test/com/haulmont/sample/petclinic/service/visit/create_visit/VisitServiceTest.java#L85">test case: createVisitForToday_createsNoVisit_forAnIncorrectIdentificationNumber</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="disease_warning_mailing"><a class="anchor" href="#disease_warning_mailing"></a><a class="link" href="#disease_warning_mailing">Disease Warning Mailing</a></h3>
<div class="paragraph">
<p>The next functionality that should be tested is the ability to send out a "Disease Warning Mailing" for the endangered pets. As with the previous feature, this functionality is similarly defined in a Service called <code>DiseaseWarningMailingService</code> within its method <code>warnAboutDisease</code>.</p>
</div>
<div class="paragraph">
<p>The implementation of the feature contains the following parts:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>All potentially endangered Pets will be located</p>
<div class="olist loweralpha">
<ol class="loweralpha">
<li>
<p>that are of the given type</p>
</li>
<li>
<p>live in the corresponding city</p>
</li>
<li>
<p>have a valid Email Address through its Owner</p>
</li>
</ol>
</div>
</li>
<li>
<p>An Email will be sent for each Pet containing information about the Disease</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>For sending out the emails, we&#8217;ll use the standard CUBA functionality for email sending: <code>EmailerAPI</code> will be leveraged.</p>
</div>
<div class="sect3">
<h4 id="test_class_setup_2"><a class="anchor" href="#test_class_setup_2"></a><a class="link" href="#test_class_setup_2">Test Class Setup</a></h4>
<div class="paragraph">
<p>The setup of the test cases will be very similar to the test class shown before. Next to the test case, there is a class containing the Test Utility Methods called <a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware/blob/master/modules/core/test/com/haulmont/sample/petclinic/service/mailing/PetclinicMailingDb.java">PetclinicMailingDb</a>. Additionally in this case certain test data is loaded from the DB at the beginning of each test. It also contains Guard Assertions that this data is really present (as you have seen before).</p>
</div>
<div class="listingblock">
<div class="title">DiseaseWarningMailingServiceTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DiseaseWarningMailingServiceTest</span> {

    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> ALABASTIA = <span class="string"><span class="delimiter">&quot;</span><span class="content">Alabastia</span><span class="delimiter">&quot;</span></span>;
    <span class="directive">private</span> <span class="directive">final</span> <span class="predefined-type">String</span> ELECTRICAL_OVERCHARGING = <span class="string"><span class="delimiter">&quot;</span><span class="content">Electrical overcharging</span><span class="delimiter">&quot;</span></span>;
    <span class="comment">// ...</span>
    <span class="directive">private</span> PetType electricType; <i class="conum" data-value="1"></i><b>(1)</b>
    <span class="directive">private</span> <span class="predefined-type">List</span>&lt;Pet&gt; electricPetsFromAlabastia;

    <span class="annotation">@BeforeEach</span>
    <span class="directive">public</span> <span class="type">void</span> loadTestDataAndVerifyItsCorrectness() {  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// given: there is an 'Electric' pet type</span>
        electricType = db.petTypeWithName(<span class="string"><span class="delimiter">&quot;</span><span class="content">Electric</span><span class="delimiter">&quot;</span></span>);

        assertThat(electricType)
            .isNotNull();

        <span class="comment">// and: there is exactly one electric pet from Alabastia</span>
        electricPetsFromAlabastia = db.petsWithTypeFromCity(
            electricType,
            ALABASTIA,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">pet-with-owner-and-type</span><span class="delimiter">&quot;</span></span>
        );

        assertThat(electricPetsFromAlabastia)
            .hasSize(<span class="integer">1</span>);
    }

    <span class="comment">// different test cases...</span>

    <span class="directive">private</span> <span class="type">int</span> warnAboutElectricalOverchargingIn(<span class="predefined-type">String</span> city) { <i class="conum" data-value="3"></i><b>(3)</b>
        <span class="keyword">return</span> diseaseWarningMailingService.warnAboutDisease(
            electricType,
            ELECTRICAL_OVERCHARGING,
            city
        );
    }

    <span class="annotation">@AfterEach</span>
    <span class="directive">public</span> <span class="type">void</span> clearOutgoingEmails() { <i class="conum" data-value="4"></i><b>(4)</b>
        db.outgoingEmails()
            .forEach(db::removeEntity);
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>electricType</code> and <code>electricPetsFromAlabastia</code> are containers for common test data in this test class</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the <code>@BeforeEach</code> method loads common test data and verifies its correctness</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>the system under test (SUT) invocation is extracted into a Test Utility Method</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>after each test case, the Outgoing Emails are cleaned up</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As seen in the last callout (4), there is a special way on how to work with and verify the Email Sending functionality.</p>
</div>
</div>
<div class="sect3">
<h4 id="state_verification_vs_behavior_verification"><a class="anchor" href="#state_verification_vs_behavior_verification"></a><a class="link" href="#state_verification_vs_behavior_verification">State Verification vs. Behavior Verification</a></h4>
<div class="paragraph">
<p>In the Case of the Email Sending, when you think about how it is possible to verify that a particular Email is correctly sent out to a target Owner, you can consider it a little bit difficult to verify. The test case can&#8217;t assure that an Email was actually sent out, because it is not directly involved in this interaction. Mainly you have the following verification options:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>check for the received Email in a real existing valid Email Account programmatically</p>
</li>
<li>
<p>emulate an SMTP server in a test case and verify that a particular message was received from the application</p>
</li>
<li>
<p>mock the <code>EmailerAPI</code> implementation by having a different implementation in the Spring configuration and verify it was called correctly</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Those three different approaches can be categorized either as a <code>State Verification</code> or a <code>Behavior Verification</code>. A behavior verification looks at the two collaborators (classes, modules or even systems) and, based on the fact that a particular interaction took place, derives the conclusion that the verification is correct. State verifications, on the other hand, do not look into how the system interacts with other collaborators, but instead look at the status after the execution and checks if the desired state is reached.</p>
</div>
<div class="paragraph">
<p>In this regard, <code>1.</code> is a State verification, while <code>2.</code> and <code>3.</code> are different kinds of behavior verifications.</p>
</div>
</div>
<div class="sect3">
<h4 id="verification_approach_for_cuba_email_functionality"><a class="anchor" href="#verification_approach_for_cuba_email_functionality"></a><a class="link" href="#verification_approach_for_cuba_email_functionality">Verification Approach for CUBA Email Functionality</a></h4>
<div class="paragraph">
<p>The <code>EmailerAPI</code> has a special method <code>List&lt;SendingMessage&gt; sendEmailAsync(EmailInfo info);</code> used in the implementation. In particular, this <code>async</code> part is handled like this: the API call stores the <code>EmailInfo</code> object into a CUBA database Table called <code>EmailSending</code> with a particular <code>SendingStatus</code>: <code>QUEUE</code>. Then a scheduled task is periodically run, it picks up those emails and tries to send them out. As this happens independently of the thread that executed <code>emailerAPI.sendEmailAsync(emailInfo)</code>, this process is asynchronous.</p>
</div>
<div class="paragraph">
<p>This knowledge allows us to uncover the forth option of verification:</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
4. Verify database rows to appear in the <code>EmailSending</code> CUBA database table used by the <code>EmailerAPI</code> which represent outgoing Email requests for CUBA Email functionality.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This option is also a state verification. Generally, it is preferable to use the state verification, as those verifications are usually more robust and normally increase the maintenance costs of a test case.</p>
</div>
<div class="paragraph">
<p>Compared to the option <code>1.</code>, the option <code>4.</code> requires much less infrastructure to be in-place. For <code>1.</code>, the system environment requires:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a real existing email account with an IMAP access</p>
</li>
<li>
<p>the correct SMTP server configuration in the CUBA Email subsystem</p>
</li>
<li>
<p>a way to programmatically interact with an IMAP inbox in the test case</p>
</li>
<li>
<p>an active internet connection</p>
</li>
<li>
<p>a mechanism to wait &amp; retry if the email get to inbox programmatically in the test case</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Furthermore, if you think about it, all of those points actually would test the correct behavior of the CUBA Email functionality. As this is already tested within the framework itself, there is no point in verifying that. Given that you rely on the correct behavior of the CUBA Email functionality (which you do, since you use it in the Petclinic production code), we should try to exclude it from our testing efforts.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Try to avoid double-test functionality provided by the framework <em>in integration tests</em>. The reason is that it is already trusted &amp; tested by the framework itself.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Coming back to the test case at hand: Option <code>4.</code> looks most promising as it is a State verification that basically describes the contract the Petclinic application has with the <code>EmailerAPI</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="different_test_cases"><a class="anchor" href="#different_test_cases"></a><a class="link" href="#different_test_cases">Different Test Cases</a></h4>
<div class="paragraph">
<p>Next we will go through the different concrete test cases for the <code>DiseaseWarningMailingService</code>.</p>
</div>
<div class="paragraph">
<p>The following test cases can be identified:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>warnAboutDisease_createsAnEmail_forEachEffectedPet</code></p>
<div class="paragraph">
<p>checks that the amount of emails passed to the <code>EmailerAPI</code> is correct (happy path)</p>
</div>
</li>
<li>
<p><code>warnAboutDisease_createsNoEmails_forACityWithoutOwners</code></p>
<div class="paragraph">
<p>verifies a negative code path, if there are no Owners located in a particular City to notify</p>
</div>
</li>
<li>
<p><code>warnAboutDisease_createsAnEmail_withTheRightEmailInformation</code></p>
<div class="paragraph">
<p>checks that the details of the email to be sent out matches the Owners information</p>
</div>
</li>
<li>
<p><code>warnAboutDisease_createsNoEmail_whenTheOwnerDoesNotHaveAnEmailAddress</code></p>
<div class="paragraph">
<p>checks that Pets with Owners that have not provided email addresses are filtered out before sending emails</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the first test case which identifies that the right amount of Emails are sent out:</p>
</div>
<div class="listingblock">
<div class="title">DiseaseWarningMailingServiceTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DiseaseWarningMailingServiceTest</span> {
    <span class="comment">// ...</span>
    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> warnAboutDisease_createsAnEmail_forEachEffectedPet() {
        <span class="comment">// given: there is only one electric pet from Alabastia</span>
        assertThat(electricPetsFromAlabastia)
            .hasSize(<span class="integer">1</span>); <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="comment">// when: a warning is send out for Alabastia</span>
        <span class="type">int</span> effectedPets = warnAboutElectricalOverchargingIn(ALABASTIA);  <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="comment">// then: the amount of effected Pets match the expected amount of one</span>
        assertThat(effectedPets)
            .isEqualTo(<span class="integer">1</span>);
        <span class="comment">// and: there is one outgoing Email for CUBAs Email Sending Functionality</span>
        assertThat(db.outgoingEmails())
            .hasSize(<span class="integer">1</span>);  <i class="conum" data-value="4"></i><b>(4)</b>
    }
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>another guard assertion to check that there is one matching Pet for <code>Alabastia</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>execution of the SUT for <code>Alabastia</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The second test case is the direct opposite of the first one. For a city which does not contain any pets, no emails should be sent out:</p>
</div>
<div class="listingblock">
<div class="title">DiseaseWarningMailingServiceTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DiseaseWarningMailingServiceTest</span> {
    <span class="comment">// ...</span>
    <span class="annotation">@Test</span>
    <span class="directive">public</span> <span class="type">void</span> warnAboutDisease_createsNoEmails_forACityWithoutOwners() {

        <span class="comment">// given: there is no owner in the Cerulean City</span>
        assertThat(db.ownersFromCity(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cerulean City</span><span class="delimiter">&quot;</span></span>)) <i class="conum" data-value="1"></i><b>(1)</b>
            .isEmpty();
        <span class="comment">// when: a warning is send out for Cerulean City</span>
        <span class="type">int</span> effectedPets = warnAboutElectricalOverchargingIn(<span class="string"><span class="delimiter">&quot;</span><span class="content">Cerulean City</span><span class="delimiter">&quot;</span></span>);
        <span class="comment">// then: no Pet should be effected</span>
        assertThat(effectedPets)
            .isEqualTo(<span class="integer">0</span>);
        <span class="comment">// and: no outgoing Email should be stored in the DB</span>
        assertThat(db.outgoingEmails())
            .hasSize(<span class="integer">0</span>);
    }
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>guard verification to check for <code>Cerulean City</code> no Pets are in the DB</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The last test case that is discussed here is the test case <code>warnAboutDisease_createsNoEmail_whenTheOwnerDoesNotHaveAnEmailAddress</code>, as it is different to the remaining test cases. This test case leverages a feature of <a href="https://junit.org/junit5/docs/current/user-guide/#writing-tests-nested">Nested Tests</a>. It allows you to group certain test cases within a test class and gives them a shared context. In this case it is used to create and cleanup certain test data (additional Owner and Pet) that matches the search criteria of <code>Alabastia</code> around each test case within this nested class.</p>
</div>
<div class="listingblock">
<div class="title">DiseaseWarningMailingServiceTest.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">DiseaseWarningMailingServiceTest</span> {
    <span class="comment">// ...</span>
  <span class="annotation">@Nested</span>
  <span class="type">class</span> <span class="class">WarnAboutDiseaseWithAdditionalElectricPetAndOwner</span> { <i class="conum" data-value="1"></i><b>(1)</b>

        <span class="directive">private</span> <span class="predefined-type">Owner</span> falkner; <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="directive">private</span> Pet zapdos;

        <span class="annotation">@BeforeEach</span>
        <span class="type">void</span> createAdditionalElectricPetAndOwner() {
            <span class="comment">// given: there is a second owner in Alabastia with an electric pet without an Email Address</span>
            falkner = db.createOwner(<span class="string"><span class="delimiter">&quot;</span><span class="content">Falkner</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Miastreet 234</span><span class="delimiter">&quot;</span></span>, ALABASTIA);
            zapdos = db.createPet(<span class="string"><span class="delimiter">&quot;</span><span class="content">123</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Zapdos</span><span class="delimiter">&quot;</span></span>, electricType, falkner);
        }

        <span class="annotation">@Test</span>
        <span class="directive">public</span> <span class="type">void</span> warnAboutDisease_createsNoEmail_whenTheOwnerDoesNotHaveAnEmailAddress() {

        <span class="comment">// given: there is two pets with type 'electric' from Alabastia</span>
        <span class="predefined-type">List</span>&lt;Pet&gt; electricPetsFromAlabastia =
            db.petsWithTypeFromCity(electricType, ALABASTIA);
        assertThat(electricPetsFromAlabastia)
            .hasSize(<span class="integer">2</span>);
        <span class="comment">// when: a warning is send out for Alabastia</span>
        <span class="type">int</span> effectedPets = warnAboutElectricalOverchargingIn(ALABASTIA);
        <span class="comment">// then: only one email was send out for the pet with an owner that has an email</span>
        assertThat(effectedPets)
              .isEqualTo(<span class="integer">1</span>);
        assertThat(db.outgoingEmails())
              .hasSize(<span class="integer">1</span>);
        }

        <span class="annotation">@AfterEach</span>
        <span class="type">void</span> removeAdditionalElectricPetAndOwner() { <i class="conum" data-value="3"></i><b>(3)</b>
            db.removeEntity(zapdos);
            db.removeEntity(falkner);
        }
    }
    <span class="comment">// ...</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>guard verification to check for <code>Cerulean City</code> that no Pets are in the DB</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>falkner</code> and <code>zapdos</code> is <a href="http://xunitpatterns.com/Fresh%20Fixture.html">Fresh Fixture</a> test data that is only available in the inner <code>@Nested</code> class</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>cleanup of the fixture is executed after each test case within the <code>@Nested</code> class</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The remaining test cases of this functionality can be found in the corresponding test class <a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware/blob/master/modules/core/test/com/haulmont/sample/petclinic/service/mailing/DiseaseWarningMailingServiceTest.java">DiseaseWarningMailingServiceTest.java</a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary"><a class="anchor" href="#summary"></a><a class="link" href="#summary">Summary</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This guide covers a lot of introductions and concepts. To summarize, let&#8217;s recap the main points here.</p>
</div>
<div class="paragraph">
<p>This guide started out with a general overview on test automation. We briefly mentioned benefits of test automation and described the general setup of an automated test in the Java ecosystem. Afterwards, we introduced different test environment categories: <code>unit test</code> and <code>integration test</code>. You also learned about some CUBA specifics like the CUBA middleware testing, how the Database connection is established in the tests, and the concept of the Test Container.</p>
</div>
<div class="paragraph">
<p>Then the guide focused on two examples within the Petclinic example application.</p>
</div>
<div class="paragraph">
<p>In the automatic creation of a Visit for a given Pet Identification Number we showed the test class setup. It also contains the explanation of the Test Utility Methods and how they are expressed in the test cases of this guide. By showing a concrete test case we explained the <code>Arrange-Act-Assert</code> pattern on how the test cases are laid out. The example also contained a explanation of test / seed data setup and the benefits and drawbacks of the shared fixture test data that is used in the guide.</p>
</div>
<div class="paragraph">
<p>The automatic "Disease Warning Mailing" for endangered Pets showed another example that introduced the problem of testing dependencies in the form of the <code>EmailerAPI</code> used in the implementation. We discussed different approaches and categorized them into <code>State Verification</code> and <code>Behavior Verification</code>. We&#8217;ve chosen a state verification variant in the example test case to check that the email functionality is behaving as expected.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="further_information"><a class="anchor" href="#further_information"></a><a class="link" href="#further_information">Further Information</a></h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://doc.cuba-platform.com/manual-latest/integration_tests_mw.html">CUBA docs: Middleware Integration Testing</a></p>
</li>
<li>
<p><a href="https://junit.org/junit5/docs/current/user-guide">JUnit 5 User Guide</a></p>
</li>
<li>
<p><a href="https://assertj.github.io/doc/">AssertJ Documentation</a></p>
</li>
</ul>
</div>
</div>
</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            <!-- Sidebar (right column) -->
            <div id="blog-sidebar">
                <div class="region region-sidebar ">
                    <section id="block-block-29" class="block block-block clearfix">

                        <div class="guide-panel">
                            <h3 class="header-table-content">Table of contents</h3>
                            <ul class="sectlevel1">
<li><a href="#what_we_are_going_to_build">What we are going to build</a>
<ul class="sectlevel2">
<li><a href="#requirements">Requirements</a></li>
<li><a href="#additional_testing_dependencies">Additional Testing Dependencies</a></li>
</ul>
</li>
<li><a href="#example_cuba_petclinic">Example: CUBA petclinic</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#test_environments">Test Environments</a>
<ul class="sectlevel2">
<li><a href="#middleware_integration_testing">Middleware Integration Testing</a></li>
<li><a href="#middleware_unit_testing">Middleware Unit Testing</a></li>
</ul>
</li>
<li><a href="#tests_for_petclinic_functionality">Tests for Petclinic Functionality</a>
<ul class="sectlevel2">
<li><a href="#working_with_junit_tests_in_cuba_studio">Working with JUnit Tests in CUBA Studio</a></li>
<li><a href="#automatic_visit_creation">Automatic Visit Creation</a></li>
<li><a href="#disease_warning_mailing">Disease Warning Mailing</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
<li><a href="#further_information">Further Information</a></li>
</ul>
                        </div>

                        <div class="sidebar-razd"></div>
                        <div class="guide-panel download">
                            <a href="https://github.com/cuba-guides/cuba-petclinic-testing-middleware" class="github-link" target="_blank">Example code on Github</a>
                        </div>
                        <div class="guide-panel cuba-version">Supported versions: CUBA 7.1+; Java 8+</div>

                    </section>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer fragment="14269c1b298" class="footer">
    <div class="container footer_container">
        <div class="footer_columns">
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Framework</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/framework/">Framework</a></li>
                        <li><a href="/tools/">Tools</a></li>
                        <li><a href="/marketplace/">Addons</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Learn</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/learn/quickstart/">Quick Start</a></li>
                        <li><a href="/learn/live-demo/">Live Demo</a></li>
                        <li><a href="/guides/">Guides</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Documentation</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/documentation/">Documentation</a></li>
                        <li><a href="/api-reference/">API References</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer_column">
                <div class="footer-menu"><h4 class="footer-menu_label">Community</h4>
                    <ul class="footer-menu_nav">
                        <li><a href="/discuss/">Forum</a></li>
                        <li><a href="/blog/">Blog</a></li>
                        <li><a href="/contacts/">Contacts</a></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer_bottom">
            <div class="footer_copyright">
                Developed and sponsored by Haulmont
                <a href="https://www.cuba-platform.com/terms-of-use/" class="footer_terms">Terms of Use</a></div>
            <ul class="social footer_social">
                <li class="social_item">
                    <a href="https://github.com/cuba-platform/cuba" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -github social_icon">
                        <path d="M3.047 3.188C5.109 1.062 7.594 0 10.5 0c2.906 0 5.383 1.055 7.43 3.164C19.977 5.274 21 7.812 21 10.781c0 2.344-.672 4.453-2.016 6.328-1.343 1.875-3.062 3.172-5.156 3.891h-.187c-.375 0-.563-.187-.563-.563l.024-1.054c.015-.672.023-1.29.023-1.852 0-.906-.25-1.578-.75-2.015 1.438-.188 2.602-.649 3.492-1.383.89-.735 1.336-2.04 1.336-3.914 0-1.125-.36-2.094-1.078-2.906.313-.907.281-1.86-.094-2.86h-.234c-.719 0-1.61.375-2.672 1.125a9.858 9.858 0 0 0-2.625-.375c-.844 0-1.719.125-2.625.375-1.063-.75-1.953-1.125-2.672-1.125H4.97c-.375 1-.407 1.953-.094 2.86-.719.812-1.078 1.78-1.078 2.906 0 1.875.437 3.18 1.312 3.914s2.032 1.195 3.47 1.383c-.345.343-.563.828-.657 1.453a2.687 2.687 0 0 1-1.219.281c-.781 0-1.39-.39-1.828-1.172-.406-.687-.953-1.062-1.64-1.125-.657 0-.673.219-.047.656.468.25.859.782 1.171 1.594.032.125.094.274.188.445.094.172.351.399.773.68.422.281.93.422 1.524.422.437 0 .781-.031 1.031-.094v1.828c0 .344-.172.516-.516.516h-.187c-2.125-.719-3.852-2.008-5.18-3.867C.664 15.273 0 13.156 0 10.78c0-2.969 1.016-5.5 3.047-7.594z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://www.linkedin.com/company/cuba-platform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -linkedin social_icon">
                        <path d="M19.305 0c.474 0 .875.155 1.203.465.328.31.492.702.492 1.176v17.554c0 .474-.164.894-.492 1.258-.328.365-.73.547-1.203.547h-17.5c-.474 0-.894-.182-1.258-.547C.182 20.09 0 19.67 0 19.195V1.641C0 1.167.173.775.52.465.866.155 1.294 0 1.805 0h17.5zM6.775 17.613V8.129h-2.71v9.484h2.71zM4.431 6.407c.245.245.566.367.964.367s.728-.13.988-.39.39-.574.39-.942c0-.398-.122-.727-.367-.987s-.567-.39-.965-.39-.727.13-.987.39-.39.59-.39.987c0 .368.122.69.367.965zm13.18 11.206v-5.42c0-1.336-.305-2.348-.916-3.034-.612-.687-1.407-1.03-2.386-1.03-1.048 0-1.922.506-2.62 1.517v-1.3H8.806v9.267h2.884v-5.257c0-.361.034-.614.104-.759.28-.722.77-1.083 1.468-1.083.979 0 1.468.668 1.468 2.005v5.094h2.883z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://www.facebook.com/CUBAplatform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -facebook social_icon">
                        <path d="M17.063 0A3.939 3.939 0 0 1 21 3.938v13.124A3.939 3.939 0 0 1 17.062 21h-2.57v-8.135h2.72l.411-3.172h-3.13V7.67c0-.916.245-1.531 1.571-1.531l1.668-.014v-2.83c-.287-.041-1.285-.123-2.433-.123-2.42 0-4.088 1.476-4.088 4.183v2.338H8.477v3.172h2.734V21H3.937A3.939 3.939 0 0 1 0 17.062V3.938A3.939 3.939 0 0 1 3.938 0h13.124z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="https://twitter.com/CubaPlatform" target="_blank" class="social_link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon -twitter social_icon">
                            <path d="M17.5 6.59a6.058 6.058 0 0 1-1.654.465 2.903 2.903 0 0 0 1.271-1.6 5.717 5.717 0 0 1-1.832.697 2.847 2.847 0 0 0-2.092-.902 2.87 2.87 0 0 0-2.87 2.871c0 .219.013.451.068.656A8.158 8.158 0 0 1 4.457 5.77c-.246.423-.396.93-.396 1.449 0 .998.464 1.873 1.244 2.392-.479-.013-.93-.15-1.367-.355v.027c0 1.395 1.052 2.557 2.365 2.817-.246.068-.438.109-.698.109-.177 0-.355-.027-.533-.055a2.889 2.889 0 0 0 2.68 1.996A5.782 5.782 0 0 1 3.5 15.34a8.183 8.183 0 0 0 4.402 1.285c5.278 0 8.176-4.375 8.176-8.176 0-.123 0-.246-.014-.369A5.521 5.521 0 0 0 17.5 6.59zM21 3.938v13.124A3.939 3.939 0 0 1 17.062 21H3.938A3.939 3.939 0 0 1 0 17.062V3.938A3.939 3.939 0 0 1 3.938 0h13.124A3.939 3.939 0 0 1 21 3.938z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </a>
                </li>
                <li class="social_item">
                    <a href="https://www.youtube.com/c/CubaPlatform" target="_blank" class="social_link">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon -youtube social_icon">
                        <path d="M27.836 4.648c.11 1.97.164 3.92.164 5.852 0 1.932-.055 3.883-.164 5.852 0 1.24-.392 2.287-1.176 3.144-.784.857-1.74 1.285-2.87 1.285-2.808.146-6.071.219-9.79.219-3.719 0-6.982-.073-9.79-.219-1.13 0-2.086-.428-2.87-1.285C.556 18.64.164 17.591.164 16.352.054 14.382 0 12.432 0 10.5c0-1.276.073-3.227.219-5.852 0-1.24.383-2.287 1.148-3.144C2.133.647 3.081.219 4.211.219 6.872.073 9.97 0 13.508 0h.984c3.537 0 6.636.073 9.297.219 1.13 0 2.087.428 2.871 1.285.784.857 1.176 1.905 1.176 3.144zM11.32 15.86l7.93-5.359-7.93-5.414v10.773z" fill="currentColor" fill-rule="evenodd"></path>
                    </svg>
                </a></li>
                <li class="social_item">
                    <a href="/rss.xml" class="social_link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon -rss social_icon">
                            <path d="M.857 15.91C1.464 15.305 2.18 15 3 15c.821 0 1.527.295 2.116.884.59.59.884 1.295.884 2.116 0 .821-.295 1.527-.884 2.116-.59.59-1.295.884-2.116.884-.821 0-1.527-.295-2.116-.884C.294 19.526 0 18.821 0 18c0-.821.286-1.518.857-2.09zM0 7c3.828 0 7.118 1.376 9.871 4.129C12.624 13.882 14 17.172 14 21H9.625c0-2.917-.875-5.25-2.625-7s-4.083-2.625-7-2.625V7zm0-7c5.797 0 10.746 2.05 14.848 6.152C18.949 10.254 21 15.203 21 21h-4.375c0-4.667-1.604-8.604-4.813-11.813C8.604 5.98 4.668 4.375 0 4.375V0z" fill="currentColor" fill-rule="evenodd"></path>
                        </svg>
                    </a>
                </li>
            </ul>
        </div>
    </div>
</footer>
<!--<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/83f852ef4b5c91802566.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/d3a40ea16eeb2e16777d.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/9bd7e05c04e06e762b47.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/70ff0a2e2f971caf4892.js" defer></script>
<script src="https://cuba-nuxt.demo.haulmont.com/_nuxt/cf082d0abe0e606c10b9.js" defer></script>-->
<style>
    [class*="column"] + [class*="column"]:last-child {
        float: none;
    }
</style>


<!-- BEGIN FOOTER -->
<!--<footer id="footer">
    <div class="footer-wrapper cuba-container">
        <div class="region region-footer-sitemap">
            <section id="block-footer-sitemap-footer-sitemap" class="block block-footer-sitemap clearfix">
                <div id="footer-sitemap" class="clearfix">
                    <div class="fs-block-content">
                        <div class="menu-footer-sitemap">
                            <ul class="footer_links_menu-footer-sitemap total-items-5 parent-items-0 single-items-0">
                                <li class="menu-1466 depth-1 total-children-4 parent-children-0 single-children-4  first">
                                    <a href="/framework" class="fs-root-link">Platform</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-4 parent-items-0 single-items-0">
                                        <li class="menu-2770 depth-2 fs-no-children  first"><a href="/framework">The Framework</a></li>
                                        <li class="menu-1473 depth-2 fs-no-children"><a href="/development-tools">Development Tools</a></li>
                                        <li class="menu-2838 depth-2 fs-no-children last"><a href="/marketplace">Marketplace</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1469 depth-1 total-children-7 parent-children-0 single-children-7">
                                    <a href="/online-demo" class="fs-root-link">Learn</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-7 parent-items-0 single-items-0">
                                        <li class="menu-1479 depth-2 fs-no-children first"><a href="/online-demo">Online demo</a></li>
                                        <li class="menu-1477 depth-2 fs-no-children"><a href="/quickstart">Quick start</a></li>
                                        <li class="menu-1478 depth-2 fs-no-children"><a href="/documentation">Documentation</a></li>
                                        <li class="menu-1731 depth-2 fs-no-children"><a href="/guides">Guides</a></li>
                                        <li class="menu-1773 depth-2 fs-no-children"><a href="/webinars">Webinars</a></li>
                                        <li class="menu-1602 depth-2 fs-no-children last"><a href="/faq">FAQ</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1603 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="https://www.cuba-platform.com/discuss/" class="fs-root-link">Community</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1604 depth-2 fs-no-children first"><a href="https://www.cuba-platform.com/discuss/">Forum</a></li>
                                        <li class="menu-1692 depth-2 fs-no-children"><a href="/testimonials">Customer stories</a></li>
                                        <li class="menu-1615 depth-2 fs-no-children last"><a href="/blog">Blog</a></li>
                                    </ul>
                                </li>
                                <li class="menu-1663 depth-1 total-children-3 parent-children-0 single-children-3"><a
                                        href="/training" class="fs-root-link">Services</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-1756 depth-2 fs-no-children first"><a href="/training">Training</a></li>
                                        <li class="menu-1757 depth-2 fs-no-children"><a href="/support-options">Support</a></li>
                                        <li class="menu-1758 depth-2 fs-no-children last"><a href="/deployment">Development</a>
                                        </li>
                                    </ul>
                                </li>
                                <li class="menu-1612 depth-1 total-children-3 parent-children-0 single-children-3  last">
                                    <a href="/download" class="fs-root-link">More</a>
                                    <ul class="footer_links_menu-footer-sitemap total-items-3 parent-items-0 single-items-0">
                                        <li class="menu-2773 depth-2 fs-no-children first"><a href="/download">Download</a></li>
                                        <li class="menu-2775 depth-2 fs-no-children"><a href="/store">Store</a></li>
                                        <li class="menu-1480 depth-2 fs-no-children last"><a href="/contacts">Contacts</a></li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </section>
        </div>
        <div class="region region-footer-copyright">
            <section id="block-block-14" class="block block-block clearfix">
                <div class="footer-copyright">
                    <div class="copyright">Copyright &copy; 2008-2018 Haulmont</div>
                    <div class="licences"><a href="/terms-of-use">Terms of Use</a></div>
                    <div class="socials">
                        <ul>
                            <li><a href="https://github.com/cuba-platform/cuba" class="socials-icon github"></a></li>
                            <li><a href="https://www.youtube.com/c/CubaPlatform" class="socials-icon youtube"></a></li>
                            <li><a href="https://www.facebook.com/CUBAplatform" class="socials-icon facebook"></a></li>
                            <li><a href="https://twitter.com/CubaPlatform" class="socials-icon twitter"></a></li>
                            <li><a href="https://www.linkedin.com/company/cuba-platform" class="socials-icon linkedin"></a></li>
                            <li><a href="https://www.cuba-platform.com/rss.xml" class="socials-icon rss"></a></li>
                        </ul>
                    </div>
                </div>
                <script async defer src="https://buttons.github.io/buttons.js"></script>
            </section>
        </div>
    </div>
</footer>-->
<!-- END FOOTER -->
<div class="scrollTop"></div>
</section>

<script src="/guides/js/foundation.min.js"></script>
<script src="https://unpkg.com/isotope-layout@3.0/dist/isotope.pkgd.js"></script>
<script src="/guides/js/vendor/modernizr.js"></script>
<script src="/guides/js/toc.js"></script>
<script src="/guides/js/navigation.js"></script>
<script src="/guides/js/navbar.js"></script>
<script src="/guides/js/extra.js"></script>
<script src="/guides/js/extra2.js"></script>
<script src="/guides/js/cuba-new.js"></script>
<script>
(function ($) {
  $(document).foundation();
  var doc = document.documentElement;
  doc.setAttribute('data-useragent', navigator.userAgent)

  /* Issue #24 */
  $(".blog .content img").each(function() {
    var imgMarkup = $(this)[0].outerHTML;
    console.log(imgMarkup);
    $(this).replaceWith('<div class="img-center">' + imgMarkup + '</div>');
  });

})(jQuery);

// Cache selectors
var lastId,
    topMenu = $(".sectlevel1"),
    topMenuHeight = topMenu.outerHeight()+1,

    // All list items
    menuItems = topMenu.find("a"),
    // Anchors corresponding to menu items
    scrollItems = menuItems.map(function(){
        var item = $($(this).attr("href"));
        if (item.length) { return item; }
    });
console.log(topMenuHeight );
menuItems.click(function(e){
    var href = $(this).attr("href"),
        offsetTop = href === "#" ? 0 : $(href).offset().top - 85;
    $('html, body').stop().animate({
        scrollTop: offsetTop
    }, 850);
    e.preventDefault();
    window.location =  href;
});

$( document ).ready(function() {
    const hash = location.hash.replace('#','');
    if(hash !== ''){
        $('html, body').stop().animate({ scrollTop: $('a[href=#' + hash + ']').offset().top - 85}, 850);
    }
});

// Bind to scroll
$(window).scroll(function(){
    // Get container scroll position
    var fromTop = $(this).scrollTop()+topMenuHeight;

    // Get id of current scroll item
    var cur = scrollItems.map(function(){
        if ($(this).offset().top < fromTop)
            return this;
    });
    // Get the id of the current element
    cur = cur[cur.length-1];
    var id = cur && cur.length ? cur[0].id : "";

    if (lastId !== id) {
        lastId = id;
        // Set/remove active class
        menuItems
            .parent().removeClass("active")
            .end().filter("[href=#"+id+"]").parent().addClass("active");
    }
});

</script>
</body>
</html>
