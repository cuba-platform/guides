---
compatible_cuba_versions: 7.0
project_id: cuba-petclinic-data-model-many-to-many
permalink: data-modelling-many-to-many-association
---
= Data modelling: Many-to-Many association
:showtitle:
:sectlinks:
:sectanchors:
:page-navtitle: Data modelling: Many-to-Many association
:page-excerpt: Data modelling guide: what are Many-to-Many associations and when to use them
:page-root: ../../../
:project_id: cuba-petclinic-data-model-many-to-many
:java_version: 1.8
:cuba_version: 7.0

The many-to-many association implies that multiple records in one entity are related to multiple records in another entity. The joining table will store primary keys of both related entities. Optionally, this table may contain additional columns.

Depending on whether additional fields in the joining table are needed, it can be implemented via a many to many association with an additional entity. The following examples illustrate both approaches.

== What will be build

This guide enhances the https://github.com/cuba-platform/cuba-petclinic[CUBA petclinic] example to show different use cases of many to many associations. In particular, the following use cases will be covered:

* `Vet` <--> `Specialty` is modelled as a direct Many-to-Many association and the UI is updated accordingly
* `Pet` <--> `InsuranceCompany` is modelled as an indirect Many-to-Many association with an explicit entity to store the validity range

=== Final Application

++++
<a href="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-application-events/master/img/adjustments-cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-application-events/master/img/login-screen.png"/></a>
++++

include::includes/guide_requirements.adoc[]


include::includes/petclinic_introduction.adoc[]


== Direct Many-to-Many association

An example of a direct many to many relationship is the following in the petclinic example:

image::data-model-many-to-many/direct_many_to_many.png[align="center"]

A `Vet` can have multiple specialities and a `Speciality` on the other hand can also be linked to multiple Vets.

On the database it is represented as a Join Table, but there is no explicit entity defined as the joining entity.


TIP: In the Studio entity designer, set the following settings for the `specialties` attribute: *Attribute type* - `ASSOCIATION`, *Cardinality* - `MANY_TO_MANY`. `Vet` will be marked as the owning side of the relationship, and Studio will suggest to create the corresponding `vets` attribute in the `Specialty` entity as the inverse side of the association.

https://github.com/cuba-guides/cuba-petclinic-data-model-many-to-many/blob/master/modules/global/src/com/haulmont/sample/petclinic/entity/vet/Vet.java[Vet.java] - the `Vet` entity contains a many-to-many list of `specialties`.

.Vet.java
[source, java]
----
@JoinTable(name = "PETCLINIC_VET_SPECIALTY_LINK",
        joinColumns = @JoinColumn(name = "VET_ID"),
        inverseJoinColumns = @JoinColumn(name = "SPECIALTY_ID"))
@ManyToMany(mappedBy = "")
protected Set<Specialty> specialties;
----

https://github.com/cuba-guides/cuba-petclinic-data-model-many-to-many/blob/master/modules/global/src/com/haulmont/sample/petclinic/entity/vet/Specialty.java[Specialty.java] - the `Specialty` entity now contains the many-to-many list of `vets`: *Attribute type* - `ASSOCIATION`, *Cardinality* - `MANY_TO_MANY`.

.Specialty.java
[source, java]
----
@JoinTable(name = "PETCLINIC_VET_SPECIALTY_LINK",
        joinColumns = @JoinColumn(name = "SPECIALTY_ID"),
        inverseJoinColumns = @JoinColumn(name = "VET_ID"))
@ManyToMany
protected List<Vet> vets;
----

`Specialty` will be _also_ marked by default as the owning side of the relationship, which enables modification of the collections on the both sides.

* https://github.com/cuba-platform/sample-model/blob/master/modules/global/src/com/company/sample/views.xml[views.xml] - the `vet-with-specialties` view of the vet editing screen contains the specialties association attribute with the `_minimal` view. The `specialty-with-vets` view includes the vets association as well.

* https://github.com/cuba-guides/cuba-petclinic-data-model-many-to-many/blob/master/modules/web/src/com/haulmont/sample/petclinic/web/vet/vet/vet-edit.xml[vet-edit.xml] - the XML descriptor of the vet editor defines a datasource for the `Vet` instance and a nested one for its specialties. It also contains a table displaying specialties and the actions https://doc.cuba-platform.com/manual-latest/list_actions.html#addAction[add] and https://doc.cuba-platform.com/manual-latest/list_actions.html#removeAction[remove].

* https://github.com/cuba-guides/cuba-petclinic-data-model-many-to-many/blob/master/modules/web/src/com/haulmont/sample/petclinic/web/vet/specialty/specialty-edit.xml[specialty-edit.xml] - the XML descriptor of the specialty editor defines a datasource for the `Specialty` instance and a nested one for its vets. It also contains a table displaying vets and the actions *add* and *remove*.

So, the `Vet` and the `Specialty` editors are absolutely symmetrical.


== Indirect Many-to-Many association with Joining Entity

The many-to-many association is always implemented using a joining table, but creating an entity to reflect this table is optional. The joining entity can be created in case you want to store some additional fields in the joining table.

An example of an indirect many-to-many association is the following in the petclinic example:

image::data-model-many-to-many/indirect_many_to_many.png[align="center"]

A `Pet` might over the years be insured by different `InsuranceCompanies` and a `InsuranceCompany` on the other hand has multiple memberships.

On the database it is represented as a Join Table and there is an explicit entity defined as the joining entity called `InsuranceMembership`. It also holds additional information about the membership: the validity range in which the Pet is insured by the insurance company. Therefore it has the values `validFrom` and `validUntil`.



TIP: In the Studio entity designer, set the following settings for the `insuranceMemberships` attribute: *Attribute type* - `COMPOSITION`, *Cardinality* - `ONE_TO_MANY`.

https://github.com/cuba-guides/cuba-petclinic-data-model-many-to-many/blob/master/modules/global/src/com/haulmont/sample/petclinic/entity/pet/Pet.java[Pet.java] - the `Pet` entity contains a one-to-many composition of `InsuranceMembership` instances.

.Pet.java
[source, java]
----
@Composition
@OnDelete(DeletePolicy.CASCADE)
@OneToMany(mappedBy = "pet")
protected List<InsuranceMembership> insurancesMemberships;
----



TIP: In the Studio entity designer, set the following settings for the `memberships` attribute: *Attribute type* - `COMPOSITION`, *Cardinality* - `ONE_TO_MANY`.


https://github.com/cuba-guides/cuba-petclinic-data-model-many-to-many/blob/master/modules/global/src/com/haulmont/sample/petclinic/entity/insurance/InsuranceCompany.java[InsuranceCompany.java] - the `InsuranceCompany` entity contains a one-to-many composition of `InsuranceMembership` instances.

.InsuranceCompany.java
[source, java]
----
@Composition
@OnDelete(DeletePolicy.CASCADE)
@OneToMany(mappedBy = "insuranceCompany")
protected List<InsuranceMembership> memberships;
----


https://github.com/cuba-guides/cuba-petclinic-data-model-many-to-many/blob/master/modules/global/src/com/haulmont/sample/petclinic/entity/insurance/InsuranceMembership.java[InsuranceMembership.java] - thus, the `InsuranceMembership` entity contains two many-to-one references: `pet` and `insuranceCompany`.

.InsuranceMembership.java
[source, java]
----
@NotNull
@ManyToOne(fetch = FetchType.LAZY, optional = false)
@JoinColumn(name = "PET_ID")
protected Pet pet;

@NotNull
@ManyToOne(fetch = FetchType.LAZY, optional = false)
@JoinColumn(name = "INSURANCE_COMPANY_ID")
protected InsuranceCompany insuranceCompany;

@Temporal(TemporalType.DATE)
@NotNull
@Column(name = "VALID_FROM", nullable = false)
protected Date validFrom;

@Temporal(TemporalType.DATE)
@Column(name = "VALID_UNTIL")
protected Date validUntil;
----


* https://github.com/cuba-guides/cuba-petclinic-data-model-many-to-many/blob/master/modules/global/src/com/haulmont/sample/petclinic/views.xml[views.xml] - the `pet-with-owner-and-type-and-memberships` view of the pet editing screen contains the composition of `insuranceMemberships` (referencing the `InsuranceMembership` joining entity) with `insuranceCompany` and the additional validity information: `validFrom` and `validUntil`.

+
The `insuranceCompany-with-memberships` view follows the same logic: it includes the composition of `memberships` (referencing the `InsuranceMembership` joining entity) with `pet` and the additional validity information: `validFrom` and `validUntil`.

* https://github.com/cuba-guides/cuba-petclinic-data-model-many-to-many/blob/master/modules/web/src/com/haulmont/sample/petclinic/web/pet/pet/pet-edit.xml[pet-edit.xml] - the XML descriptor of the pet editor defines a datasource for the `Pet` instance and a nested one for its `insuranceMemberships`. It also contains a table displaying memberships and the custom action to pick an airport directly, bypassing the `AirportDutyFree` editor.

As a result, editing of a `InsuranceMembership` instance works as follows:

The `Pet` edit screen shows a list of airports and the currency drop-down.


A user can click *Add Insurance*, the `InsuranceCompany` lookup will be opened, and the user can either select an insurance company to add or open its editor. When the user selects an insurance company, the new `InsuranceMembership` instance https://github.com/cuba-platform/sample-model/blob/master/modules/web/src/com/company/sample/web/dutyfree/DutyFreeEdit.java#L29[is created] with the default validity range. This instance it is not saved to the database, but added to the `insuranceMembershipsDs` datasource of the `Pet` editor.

When OK is clicked in the https://github.com/cuba-platform/sample-model/blob/master/modules/web/src/com/company/sample/web/airports/airport/airport-edit.xml[`InsuranceCompany` editor], the updated instance of the insurance company is saved both to the database and to the https://github.com/cuba-platform/sample-model/blob/master/modules/web/src/com/company/sample/web/dutyfree/duty-free-edit.xml#L12[`insuranceMembershipsDs` datasource] of the `Pet` editor, as the `InsuranceCompany` entity is fully independent.

The user can create new insurance companies and delete existing ones, and all changes will be saved to the database in separate transactions and to the `insuranceMembershipsDs` datasource as well.

When a user clicks OK in the pet edit screen, the updated `Pet` instance together with all the updated `InsuranceMembership` instances is submitted to the `DataManager.commit()` method on the middleware and saved to the database within a single transaction.



== Summary

In this data modelling guide the many-to-many association was shown. Many-to-many associations are valuable if both sides of the association should be linked to multiple items of the other side as shown for the `Vet` <--> `Specialty` case. If required by the business case, this association can also enhanced via additional information that describe the association further as it was shown with the `validFrom` & `validUntil` attributes for the `InsuranceMembership` entity.


=== Further information

* https://doc.cuba-platform.com/manual-{cuba_version}/events.html[Events reference documentation]
