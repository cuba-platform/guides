---
compatible_cuba_versions: 7.0
project_id: cuba-petclinic-intro-to-application-events
permalink: decouple-business-logic-with-app-events
---
= Decouple business logic with application events
:showtitle:
:page-navtitle: Decouple business logic with application events
:page-excerpt: Overview on how application events can be used in a CUBA application to decouple business logic
:page-root: ../../../
:project_id: cuba-petclinic-intro-to-application-events
:java_version: 1.8
:cuba_version: 7.0

This guide walks you through the CUBA mechanism to use events in your application. In CUBA 7 events are the predominant mechanism to react to different kinds of changes of the application. Furthermore events are a common pattern within an application to decouple one part of the business logic from another.


== What will be build

This guide enhances the https://github.com/cuba-platform/cuba-petclinic[CUBA petclinic] example to show different use cases of application events. In particular, the following use cases will be covered:

* sending out of Room Keycode for booked visits
* notifying user after login about latest visits
* kicking off payment process once Pet Visit is marked as completed

=== Final Application

++++
<a href="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-datamanager/master/img/adjustments-cuba-petclinic-overview.gif"><img src="https://raw.githubusercontent.com/cuba-guides/cuba-petclinic-intro-to-datamanager/master/img/login-screen.png"/></a>
++++

include::includes/guide_requirements.adoc[]


include::includes/petclinic_introduction.adoc[]

== Benefits of a event based business logic



== Available types of events in a CUBA application

There are different kinds of application events within a CUBA application. The main categories are:

* Entity Lifecycle Events
* Application Lifecycle Events
* Custom Application Events

This guide goes through the three categories one by one and lays out an example on how to use them.

=== Entity Lifecycle events: EntityChangedEvent


In the petclinic following logic will be implemented: The petclinic has rooms for the stay of the pets during their time in the clinic. The rooms have no traditional keys or keycards, but instead have a 6 digit keycode to enter at the entrace door. This keycode has to be given to the pets owner once a new visit is booked. The transportation of the keycode should happen via SMS notification from the application.

This example is in the category of _Entity lifecycle events_. The `EntityChangedEvent` is send out by the CUBA storage mechanism, once an Entity has been changed in the database: because we want to execute logic, once a visit is booked (created).

CUBA fires such an Event for entities, that have an annotation `@PublishEntityChangedEvents` on the Entity definition. A `EntityChangedEvent` contains information about the type of change (create, update or delete) as well as the attributes which have been changed.

To register a Event listener for this event, a new Spring bean in the core module of the application has to be defined. In order to register to a specific kind of event, the method that should be called once an `EntityChangedEvent` has been send has to be annotated with `@TransactionalEventListener`.


.RoomKeycodeToOwnerSender.java
[source,java]
----

@Component("petclinic_roomKeycodeToOwnerSender")
public class RoomKeycodeToOwnerSender {

    @Inject
    private DataManager dataManager;

    @Inject
    private MobilePhoneNotificationGateway mobilePhoneNotificationGateway;

    @TransactionalEventListener // <1>
    public void sendRoomKeycode(EntityChangedEvent<Visit, UUID> event) { // <2>

        if (event.getType().equals(EntityChangedEvent.Type.CREATED)) {
            Visit visit = loadVisit(event.getEntityId()); // <3>
            tryToSendRoomKeycodeToPetsOwner(visit);
        }
    }

    private void tryToSendRoomKeycodeToPetsOwner(Visit visit) {


        if (visit.getPet().getOwner() != null) {

            String phoneNumber = visit.getPet().getOwner().getTelephone();

            if (phoneNumber != null) {
                String notificationText = createNotificationText(visit);

                mobilePhoneNotificationGateway.sendNotification(phoneNumber, notificationText);
            }
        }

    }


    // ...

}
----

<1> registration of `sendRoomKeycode` as an event listener
<2> scoping `EntityChangedEvent` only to Events which changed `Visit` entities
<3> access to `Visit` identifier of the created instance


With this definition of the Event listener the application will send out room keycodes to the owners of pets that have just registered in the petclinic.

There can be multiple event listeners defined for a given event. In this example it is also required to not only notify the Owner of the pet about the keycode, but also the system that is responsible for controlling the door hardware. It also needs additional information about the visit with the associated pet, to automatically adjust the height of the bed, display a welcome message on the rooms TV etc.

The following event listener will take over the responsibility to notify the room system.


.RoomSystemNotifier.java
[source,java]
----

@Component("petclinic_roomSystemNotifier")
public class RoomSystemNotifier {

    @Inject
    private DataManager dataManager;

    @Inject
    RoomSystemGateway roomSystemGateway;

    @TransactionalEventListener
    public void notifyRoomSystem(EntityChangedEvent<Visit, UUID> event) {

        if (event.getType().equals(EntityChangedEvent.Type.CREATED)) {
            Visit visit = loadVisit(event.getEntityId());
            tryToNotifyRoomSystemAboutVisit(visit);
        }
    }

    private void tryToNotifyRoomSystemAboutVisit(Visit visit) {
        roomSystemGateway.informAboutVisit(visit);
    }

    // ...
}
----


==== Naming Conventions of events

Events are normally named in simple past: "Entity *Changed* Event". This is a common pattern, because it stresses that an event is a immutable fact that happened in the past and is not changeable anymore. Event listeners on the other hand should be named in present tense.

Furthermore Event listeners are normally named regarding the one specific action that they should fulfill. Instead of create a general `PetCreatedListener` that deals with all things that should happen once a pet is created in the system, Event listeners should be named regarding one specific action that should be performed: `RoomKeycodeToOwnerSender` -> sends a room keycode to the pets owner.

This is an example of an application of the https://en.wikipedia.org/wiki/Open%E2%80%93closed_principle[open-closed principle], which normally lead to more loosely coupled application and due to that to more maintainable software.


=== Execute logic on the global application lifecycle

=== Custom Application Logic events

== Constrains of Events in a CUBA application

=== Sending global events within an CUBA application



== Summary

The application events from CUBA allow to define loosely coupled business logic within the application. Independent parts from a business functionality point of view can also be reflected as independent components within the application. This low coupling

=== Further information

